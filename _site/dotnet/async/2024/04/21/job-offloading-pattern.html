<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<title>Job Offloading Pattern with System.Threading.Channels. A way to deal with long-running tasks in .NET | N+1 Blog</title>

	<!-- Meta Description -->
	
	<meta name="description" content="This post shows you how to implement Job Offloading Pattern using a pipeline built with System.Threading.Channels">
	

	<meta name="author" content="Oleksii Nikiforov">

	<!-- Canonical URL -->
	<link rel="canonical" href="https://nikiforovall.github.io/dotnet/async/2024/04/21/job-offloading-pattern.html">

	<!-- Open Graph -->
	<meta property="og:title" content="Job Offloading Pattern with System.Threading.Channels. A way to deal with long-running tasks in .NET">
	<meta property="og:description" content="This post shows you how to implement Job Offloading Pattern using a pipeline built with System.Threading.Channels">
	<meta property="og:url" content="https://nikiforovall.github.io/dotnet/async/2024/04/21/job-offloading-pattern.html">
	<meta property="og:site_name" content="N+1 Blog">
	<meta property="og:type" content="article">
	
	<meta property="article:published_time" content="2024-04-21T00:00:00+03:00">
	
	<meta property="og:image" content="https://nikiforovall.github.io/assets/media/default-post-image.png">

	<!-- Twitter Card -->
	<meta name="twitter:card" content="summary_large_image">
	<meta name="twitter:site" content="@nikiforovall">
	<meta name="twitter:title" content="Job Offloading Pattern with System.Threading.Channels. A way to deal with long-running tasks in .NET">
	<meta name="twitter:description" content="This post shows you how to implement Job Offloading Pattern using a pipeline built with System.Threading.Channels">
	<meta name="twitter:image" content="https://nikiforovall.github.io/assets/media/default-post-image.png">

	<!-- Enable responsive viewport -->
	<meta name="viewport" content="width=device-width, initial-scale=1.0">

	<!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
	<!--[if lt IE 9]>
	<script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
	<![endif]-->

	<!-- Le styles -->
	<link href="/assets/resources/bootstrap/css/bootstrap.min.css" rel="stylesheet">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" integrity="sha512-Evv84Mr4kqVGRNSgIGL/F/aIDqQb7xQ2vcrdIwxfjThSH8CSR7PBEakCr51Ck+w+/U6swU2Im1vVX0SVk9ABhg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
	<link href="/assets/resources/syntax/syntax.css" rel="stylesheet">
	<link href="/assets/css/style.css" rel="stylesheet">

	<!-- Search Feature Styles -->
	<style>
		.layout-page .search-trigger { position: fixed; top: 45px; right: 100px; z-index: 1000; display: flex; align-items: center; gap: 10px; padding: 6px 12px; background: #f5f5f5; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; min-width: 220px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); transition: all 0.15s ease; height: 34px; box-sizing: border-box; }
		.layout-post .search-trigger { position: fixed; top: 45px; right: 100px; z-index: 1000; display: flex; align-items: center; justify-content: center; padding: 0; background: #f5f5f5; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; width: 34px; height: 34px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); transition: all 0.15s ease; box-sizing: border-box; }
		.search-trigger:hover { background: #ebebeb; border-color: #c0c0c0; box-shadow: 0 2px 5px rgba(0,0,0,0.08); }
		.search-icon { color: #666; font-size: 14px; display: flex; align-items: center; }
		.search-placeholder { flex: 1; color: #999; font-size: 14px; user-select: none; }
		.search-keybind { display: flex; gap: 4px; align-items: center; }
		.search-key { font-family: 'Courier New', monospace; font-size: 11px; padding: 2px 6px; background: #e0e0e0; border: 1px solid #ccc; border-bottom: 2px solid #bbb; border-radius: 3px; color: #333; line-height: 1.2; box-shadow: 0 1px 1px rgba(0,0,0,0.1); }
		.layout-post .search-placeholder { display: none; }
		.layout-post .search-keybind { display: none; }
		.search-modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: 10000; display: none; align-items: flex-start; justify-content: center; padding-top: 10vh; }
		.search-modal.open { display: flex; animation: fadeIn 0.2s ease; }
		@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
		.search-backdrop { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); backdrop-filter: blur(2px); }
		.search-modal-container { position: relative; width: 90%; max-width: 600px; background: white; border-radius: 8px; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3); overflow: hidden; }
		.search-input-container { display: flex; align-items: center; padding: 16px 20px; border-bottom: 1px solid #e0e0e0; gap: 12px; }
		.search-modal-icon { color: #666; font-size: 18px; }
		.search-modal-input { flex: 1; border: none; outline: none; font-size: 16px; color: #333; background: transparent; }
		.search-modal-input::placeholder { color: #999; }
		.search-close-btn { background: transparent; border: none; color: #999; font-size: 18px; cursor: pointer; padding: 4px 8px; border-radius: 4px; transition: all 0.15s ease; }
		.search-close-btn:hover { background: #f0f0f0; color: #333; }
		.search-results { max-height: 60vh; overflow-y: auto; padding: 8px; }
		.search-hint { padding: 40px 20px; text-align: center; color: #999; font-size: 14px; }
		.search-result-item { padding: 12px 16px; border-radius: 6px; cursor: pointer; transition: background-color 0.15s ease; border: 2px solid transparent; margin-bottom: 4px; }
		.search-result-item:hover { background: #f5f5f5; }
		.search-result-item.selected { background: #e8f4f8; border-color: #4a90e2; }
		.search-footer { display: flex; justify-content: center; gap: 20px; padding: 12px 20px; border-top: 1px solid #e0e0e0; background: #fafafa; font-size: 12px; color: #666; }
		.search-footer kbd { font-family: 'Courier New', monospace; font-size: 11px; padding: 2px 5px; background: white; border: 1px solid #ddd; border-radius: 3px; color: #333; box-shadow: 0 1px 1px rgba(0,0,0,0.1); }
		@media (max-width: 768px) { .layout-page .search-trigger, .layout-post .search-trigger { display: none; } .search-modal { padding-top: 5vh; } .search-modal-container { width: 95%; max-width: none; margin: 0 10px; } .search-results { max-height: 50vh; } .search-footer { flex-wrap: wrap; gap: 10px; } }
	</style>

	<!-- Le fav and touch icons -->
	<!-- Update these with your own images
	<link rel="shortcut icon" href="images/favicon.ico">
	<link rel="apple-touch-icon" href="images/apple-touch-icon.png">
	<link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
	<link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
	-->
	<link rel="shortcut icon" href="/assets/media/favicon.ico">

	<link rel="alternate" type="application/rss+xml" title="" href="https://nikiforovall.github.io/feed.xml">

	
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Job Offloading Pattern with System.Threading.Channels. A way to deal with long-running tasks in .NET",
  
  
  "description": "This post shows you how to implement Job Offloading Pattern using a pipeline built with System.Threading.Channels",
  
  "image": ["https://nikiforovall.github.io/assets/media/default-post-image.png"],
  "datePublished": "2024-04-21T00:00:00+03:00",
  "dateModified": "2024-04-21T00:00:00+03:00",
  "author": {
    "@type": "Person",
    "name": "Oleksii Nikiforov",
    "url": "https://nikiforovall.github.io/about.html",
    "sameAs": [
      "https://github.com/nikiforovAll",
      "https://twitter.com/nikiforovall",
      "https://www.linkedin.com/in/nikiforov-oleksii",
      "https://t.me/nikiforovallblog"
    ]
  },
  "publisher": {
    "@type": "Person",
    "name": "Oleksii Nikiforov",
    "logo": {
      "@type": "ImageObject",
      "url": "https://www.gravatar.com/avatar/e86fa0938976c38907a302ecb208f011?s=200"
    }
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://nikiforovall.github.io/dotnet/async/2024/04/21/job-offloading-pattern.html"
  },
  
  "articleSection": "dotnet",
  
  
  "keywords": "dotnet, aspnetcore, pipelines, async, opentelemetry",
  
  "inLanguage": "en-US"
}
</script>


</head>

<body class="layout-post">
	<nav class="navbar navbar-default visible-xs" role="navigation">
		<!-- Brand and toggle get grouped for better mobile display -->
		<div class="navbar-header">
			<button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
				<span class="sr-only">Toggle navigation</span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</button>
			
			<a type="button" class="navbar-toggle nav-link" href="http://github.com/nikiforovAll" target="_blank" rel="noopener noreferrer">
				<i class="fa-brands fa-github"></i>
			</a>
			
			
			<a type="button" class="navbar-toggle nav-link" href="http://x.com/nikiforovall" target="_blank" rel="noopener noreferrer">
				<i class="fa-brands fa-x-twitter"></i>
			</a>
			
			
			<a type="button" class="navbar-toggle nav-link" href="mailto:alexey.nikiforovall@gmail.com">
				<i class="fa-solid fa-envelope"></i>
			</a>
			
			<a class="navbar-brand" href="/">
				<img src="//www.gravatar.com/avatar/e86fa0938976c38907a302ecb208f011?s=35" class="img-circle">
				N+1 Blog
			</a>
		</div>

		<!-- Collect the nav links, forms, and other content for toggling -->
		<div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
			<ul class="nav navbar-nav">
				<li class="active"><a href="/">Home</a></li>
				<li><a href="/topics.html">Topics</a></li>
				<li><a href="/about.html">About</a></li>
			</ul>
		</div>
<!-- /.navbar-collapse -->
	</nav>

	<!-- nav-menu-dropdown -->
	<div class="btn-group hidden-xs" id="nav-menu">
		<button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">
			<i class="fa-solid fa-bars"></i>
		</button>
		<ul class="dropdown-menu" role="menu">
			<li><a href="/"><i class="fa-solid fa-home"></i>Home</a></li>
			<li><a href="/topics.html"><i class="fa-solid fa-bookmark"></i>Topics</a></li>
			<li><a href="/about.html"><i class="fa-solid fa-pencil"></i>About</a></li>
			<li class="divider">
			<li><a href="#"><i class="fa-solid fa-arrow-up"></i>Top of Page</a></li>
		</ul>
	</div>

	<!-- Search Control -->
	<div id="search-trigger" class="search-trigger">
		<span class="search-icon"><i class="fa-solid fa-search"></i></span>
		<span class="search-placeholder">Search</span>
		<div class="search-keybind">
			<kbd class="search-key" id="search-modifier">ctrl</kbd>
			<kbd class="search-key">K</kbd>
		</div>
	</div>

	<!-- Search Modal -->
	<div id="search-modal" class="search-modal">
		<div class="search-backdrop"></div>
		<div class="search-modal-container">
			<div class="search-input-container">
				<i class="fa-solid fa-search search-modal-icon"></i>
				<input type="text" id="search-input" class="search-modal-input" placeholder="Search blog posts..." autocomplete="off">
				<button id="search-close" class="search-close-btn" title="Close (ESC)">
					<i class="fa-solid fa-times"></i>
				</button>
			</div>
			<div id="search-results" class="search-results">
				<div class="search-hint">Type at least 2 characters to search...</div>
			</div>
			<div class="search-footer">
				<span><kbd>‚Üë</kbd> <kbd>‚Üì</kbd> to navigate</span>
				<span><kbd>‚Üµ</kbd> to select</span>
				<span><kbd>ESC</kbd> to close</span>
			</div>
		</div>
	</div>

	<div class="col-sm-3 sidebar hidden-xs" style="">
		<!-- sidebar.html -->
<header class="sidebar-header" role="banner">
	<a href="/">
		<img src="//www.gravatar.com/avatar/e86fa0938976c38907a302ecb208f011?s=150" class="img-circle">
	</a>
	<h3 class="title">
        <a href="/">N+1 Blog</a>
    </h3>
</header>


<div id="bio" class="text-center">
	Jibber-jabbering about programming and IT.
</div>


<div id="contact-list" class="text-center">
	<ul class="list-unstyled list-inline">
		
		<li>
			<a class="btn btn-default btn-sm" href="https://github.com/nikiforovAll" target="_blank" rel="noopener noreferrer">
				<i class="fa-brands fa-github fa-lg"></i>
			</a>
		</li>
		
		
		<li>
			<a class="btn btn-default btn-sm" href="https://x.com/nikiforovall" target="_blank" rel="noopener noreferrer">
				<i class="fa-brands fa-x-twitter fa-lg"></i>
			</a>
		</li>
		
		
		<li>
			<a class="btn btn-default btn-sm" href="https://t.me/nikiforovallblog" target="_blank" rel="noopener noreferrer">
				<i class="fa-brands fa-telegram fa-lg"></i>
			</a>
		</li>
		
		
		<li>
			<a class="btn btn-default btn-sm" href="https://linkedin.com/in/nikiforov-oleksii" target="_blank" rel="noopener noreferrer">
				<i class="fa-brands fa-linkedin fa-lg"></i>
			</a>
		</li>
		
	</ul>
	<ul id="contact-list-secondary" class="list-unstyled list-inline">
		
		<li>
			<a class="btn btn-default btn-sm" href="mailto:alexey.nikiforovall@gmail.com">
				<i class="fa-solid fa-envelope fa-lg"></i>
			</a>
		</li>
		
		<li>
			<a class="btn btn-default btn-sm" href="/feed.xml">
				<i class="fa-solid fa-rss fa-lg"></i>
			</a>
		</li>
	</ul>
</div>
<!-- sidebar.html end -->

	</div>

	<div class="col-sm-9 col-sm-offset-3">
		<div class="page-header">
	<h1>Job Offloading Pattern with System.Threading.Channels. A way to deal with long-running tasks in .NET </h1>
</div>
<article>

	<div class="col-sm-10">

		<span class="post-date">
			
			April
			21st,
			
			2024
		</span>

	
	
	
	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	
	<div>
		<h5><a href="/dotnet/2024/08/22/async-enumerable-pipelines.html">Building pipelines with IAsyncEnumerable in .NET <span class="label label-default">dotnet</span>  <span class="label label-default">async</span>  <span class="label label-default">pipelines</span> </a></h5>
	</div>
	
	
	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	
	<div>
		<h5><a href="/dotnet/opentelemetry/2024/06/12/developer-guide-to-xunit-otel.html">A .NET Developer Guide to XUnit Test Instrumentation with OpenTelemetry and Aspire Dashboard <span class="label label-default">dotnet</span>  <span class="label label-default">aspnetcore</span>  <span class="label label-default">opentelemetry</span> </a></h5>
	</div>
	
	
	

	

	
	

	

	
	<div>
		<h5><a href="/dotnet/opentelemetry/2024/06/07/test-instrumentation-with-otel-aspire.html">Automated Tests instrumentation via OpenTelemetry and Aspire Dashboard <span class="label label-default">dotnet</span>  <span class="label label-default">aspnetcore</span>  <span class="label label-default">opentelemetry</span> </a></h5>
	</div>
	
	
	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	
	<div>
		<h5><a href="/dotnet/async/2024/04/21/channels-composition.html">Building pipelines with System.Threading.Channels <span class="label label-default">dotnet</span>  <span class="label label-default">aspnetcore</span>  <span class="label label-default">async</span>  <span class="label label-default">pipelines</span> </a></h5>
	</div>
	
	
	
	

	<div class="article_body" style="margin-top: 30px;">
		<p><em>Table of Contents</em>:</p>

<ul>
  <li><a href="#tldr">TL;DR</a></li>
  <li><a href="#introduction">Introduction</a></li>
  <li><a href="#defining-pipeline">Defining Pipeline</a></li>
  <li><a href="#adding-opentelemetry">Adding OpenTelemetry</a></li>
  <li>
<a href="#demo">Demo</a>
    <ul>
      <li><a href="#running-single-request">Running single request</a></li>
      <li><a href="#adding-custom-metrics-and-using-bombardier">Adding custom metrics and using Bombardier</a></li>
      <li><a href="#running-multiple-requests">Running multiple requests</a></li>
    </ul>
  </li>
  <li><a href="#conclusion">Conclusion</a></li>
  <li><a href="#references">References</a></li>
</ul>

<h2 id="tldr">TL;DR</h2>

<p>This post shows you how to implement Job Offloading Pattern using an a pipeline built with <code class="language-plaintext highlighter-rouge">System.Threading.Channels</code></p>

<blockquote>
  <p>Source code: <a href="https://github.com/NikiforovAll/channels-composition-and-otel" target="_blank" rel="noopener noreferrer">https://github.com/NikiforovAll/channels-composition-and-otel</a></p>
</blockquote>

<h2 id="introduction">Introduction</h2>

<p>The job offloading pattern is a technique for improving the performance and responsiveness of a system by delegating tasks to be completed outside of the main thread or process. This frees up the main thread to focus on critical tasks and keeps the user interface responsive.</p>

<p>Consider a Web API that receives requests to perform data-intensive operations, such as generating reports from large datasets. If these operations are performed synchronously within the API request, it could lead to long response times and potentially timeout errors. This would result in a poor user experience and could also impact the scalability of the API.</p>

<p>By using the job offloading pattern, these data-intensive operations can be offloaded to a background worker. When a request is received, the API can quickly respond with a message indicating that the operation is in progress. The actual operation is then performed in the background, without blocking the API from handling other requests.</p>

<p>Once the operation is complete, the result can be stored in a location from where the client can retrieve it, such as a database or a cloud storage. The client can periodically check for the result or the API can provide a notification mechanism to inform the client when the operation is complete.</p>

<p>This approach not only improves the responsiveness of the API, but also allows it to scale better by freeing up resources to handle more incoming requests while the background workers are performing the data-intensive operations.</p>

<p>There are several benefits to using the job offloading pattern:</p>

<ul>
  <li>
<strong>Improved responsiveness</strong>: By offloading long-running or resource-intensive tasks, the main thread is free to handle user interactions and keep the application responsive.</li>
  <li>
<strong>Increased scalability</strong>: Offloading jobs allows the system to distribute workload across multiple workers or machines, improving scalability as demand increases.</li>
  <li>
<strong>Enhanced reliability</strong>: If a job fails, it can be retried without impacting the main application.</li>
</ul>

<p>Here are some common ways to implement job offloading:</p>

<ul>
  <li>
<strong>Background Jobs</strong> üéØ(this article): These are tasks that are submitted to a queue and processed asynchronously by a background worker. This is a popular approach for tasks like sending emails, processing images, or updating databases.</li>
  <li>
<strong>Work Queues</strong>: A work queue is a data structure that stores jobs to be processed. The worker process retrieves jobs from the queue and executes them. There are various message queueing systems available to implement work queues.</li>
  <li>
<strong>Outbox Pattern</strong>: This pattern involves storing job information in a database table before it‚Äôs submitted to a queue. This ensures data consistency and allows for retries in case of queue failures.</li>
</ul>

<p>In this article we will focus on <strong>Background Jobs</strong> because this option is suitable for many scenarios and doesn‚Äôt require additional dependencies like databases, message queues, etc.</p>

<h2 id="defining-pipeline">Defining Pipeline</h2>

<p>As discussed in my <a href="https://nikiforovall.github.io/dotnet/async/2024/04/21/channels-composition.html">previous post</a> we can make use of <code class="language-plaintext highlighter-rouge">System.Threading.Channels</code> to build pipelines.</p>

<p>Assume we have a pipeline like following:</p>

<div class="mermaid">
graph LR
    A[QueueBackgroundWorkItemAsync] --&gt; B[InitPipeline]
    B --&gt; C[Step1]
    C --&gt; D[Step2]
    D --&gt; E[FinishPipeline]
</div>

<p>Take a look at code below, it shows some concepts like payload transformation, accessing a DI container and concurrent processing:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">class</span> <span class="nc">ProcessorChannel</span> <span class="p">:</span> <span class="n">IBackgroundProcessor</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="n">Channel</span><span class="p">&lt;</span><span class="n">Payload</span><span class="p">&gt;</span> <span class="n">_pipeline</span><span class="p">;</span>
    <span class="k">private</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">MinDelay</span> <span class="p">=</span> <span class="m">500</span><span class="p">;</span>
    <span class="k">private</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">MaxDelay</span> <span class="p">=</span> <span class="m">1000</span><span class="p">;</span>

    <span class="k">public</span> <span class="nf">ProcessorChannel</span><span class="p">(</span>
        <span class="n">IServiceProvider</span> <span class="n">serviceProvider</span><span class="p">,</span>
        <span class="n">IOptions</span><span class="p">&lt;</span><span class="n">ProcessorChannelSettings</span><span class="p">&gt;</span> <span class="n">processorOptions</span>
    <span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">options</span> <span class="p">=</span> <span class="n">processorOptions</span><span class="p">.</span><span class="n">Value</span><span class="p">;</span>
        <span class="n">_pipeline</span> <span class="p">=</span> <span class="n">Channel</span><span class="p">.</span><span class="n">CreateBounded</span><span class="p">&lt;</span><span class="n">Payload</span><span class="p">&gt;(</span><span class="n">options</span><span class="p">.</span><span class="n">Capacity</span><span class="p">);</span>

        <span class="n">Writer</span> <span class="p">=</span> <span class="n">_pipeline</span><span class="p">;</span>
        <span class="n">Reader</span> <span class="p">=</span> <span class="n">_pipeline</span>
            <span class="p">.</span><span class="nf">Pipe</span><span class="p">(</span>
                <span class="n">payload</span> <span class="p">=&gt;</span>
                    <span class="nf">InitPipeline</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="n">options</span><span class="p">.</span><span class="n">UseUnifiedSpanForAllPipelines</span><span class="p">,</span> <span class="n">serviceProvider</span><span class="p">),</span>
                <span class="n">options</span><span class="p">.</span><span class="n">Capacity</span>
            <span class="p">)</span>
            <span class="p">.</span><span class="nf">PipeAsync</span><span class="p">(</span>
                <span class="n">maxConcurrency</span><span class="p">:</span> <span class="n">options</span><span class="p">.</span><span class="n">Step1MaxConcurrency</span><span class="p">,</span>
                <span class="n">Step1</span><span class="p">,</span>
                <span class="n">capacity</span><span class="p">:</span> <span class="n">options</span><span class="p">.</span><span class="n">Step1Capacity</span>
            <span class="p">)</span>
            <span class="p">.</span><span class="nf">PipeAsync</span><span class="p">(</span>
                <span class="n">maxConcurrency</span><span class="p">:</span> <span class="n">options</span><span class="p">.</span><span class="n">Step2MaxConcurrency</span><span class="p">,</span>
                <span class="n">Step2</span><span class="p">,</span>
                <span class="n">capacity</span><span class="p">:</span> <span class="n">options</span><span class="p">.</span><span class="n">Step2Capacity</span>
            <span class="p">)</span>
            <span class="p">.</span><span class="nf">Pipe</span><span class="p">(</span><span class="n">FinishPipeline</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">async</span> <span class="n">ValueTask</span> <span class="nf">QueueBackgroundWorkItemAsync</span><span class="p">(</span>
        <span class="n">Payload</span> <span class="n">payload</span><span class="p">,</span>
        <span class="n">CancellationToken</span> <span class="n">cancellationToken</span> <span class="p">=</span> <span class="k">default</span>
    <span class="p">)</span>
    <span class="p">{</span>
        <span class="n">ArgumentNullException</span><span class="p">.</span><span class="nf">ThrowIfNull</span><span class="p">(</span><span class="n">payload</span><span class="p">);</span>

        <span class="k">await</span> <span class="n">Writer</span><span class="p">.</span><span class="nf">WriteAsync</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="n">cancellationToken</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">static</span> <span class="n">PayloadWithScope</span><span class="p">&lt;</span><span class="n">Payload</span><span class="p">&gt;</span> <span class="nf">InitPipeline</span><span class="p">(</span>
        <span class="n">Payload</span> <span class="n">payload</span><span class="p">,</span>
        <span class="kt">bool</span> <span class="n">useUnifiedSpanForAllPipelines</span><span class="p">,</span>
        <span class="n">IServiceProvider</span> <span class="n">serviceProvider</span>
    <span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">context</span> <span class="p">=</span> <span class="k">new</span> <span class="n">PayloadWithScope</span><span class="p">&lt;</span><span class="n">Payload</span><span class="p">&gt;(</span>
            <span class="n">payload</span><span class="p">,</span>
            <span class="n">serviceProvider</span><span class="p">.</span><span class="nf">CreateScope</span><span class="p">()</span>
        <span class="p">);</span>

        <span class="k">return</span> <span class="n">context</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="n">PayloadResult</span> <span class="nf">FinishPipeline</span><span class="p">(</span><span class="n">PayloadWithScope</span><span class="p">&lt;</span><span class="n">PayloadResult</span><span class="p">&gt;</span> <span class="n">context</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">context</span><span class="p">.</span><span class="n">ServiceScope</span><span class="p">?.</span><span class="nf">Dispose</span><span class="p">();</span>

        <span class="k">return</span> <span class="n">context</span><span class="p">.</span><span class="n">Payload</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">async</span> <span class="n">ValueTask</span><span class="p">&lt;</span><span class="n">PayloadWithScope</span><span class="p">&lt;</span><span class="n">Payload2</span><span class="p">&gt;&gt;</span> <span class="nf">Step1</span><span class="p">(</span><span class="n">PayloadWithScope</span><span class="p">&lt;</span><span class="n">Payload</span><span class="p">&gt;</span> <span class="n">context</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">timeProvider</span> <span class="p">=</span> <span class="n">context</span><span class="p">.</span><span class="n">GetRequiredService</span><span class="p">&lt;</span><span class="n">TimeProvider</span><span class="p">&gt;();</span>

        <span class="kt">var</span> <span class="n">delay</span> <span class="p">=</span> <span class="n">Random</span><span class="p">.</span><span class="n">Shared</span><span class="p">.</span><span class="nf">Next</span><span class="p">(</span><span class="n">MinDelay</span><span class="p">,</span> <span class="n">MaxDelay</span><span class="p">);</span>
        <span class="k">await</span> <span class="n">Task</span><span class="p">.</span><span class="nf">Delay</span><span class="p">(</span><span class="n">delay</span><span class="p">);</span>

        <span class="k">return</span> <span class="k">new</span><span class="p">(</span>
            <span class="k">new</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">Payload</span><span class="p">.</span><span class="n">Name</span><span class="p">,</span> <span class="n">timeProvider</span><span class="p">.</span><span class="nf">GetUtcNow</span><span class="p">(),</span> <span class="s">$"Waited </span><span class="p">{</span><span class="n">delay</span><span class="p">}</span><span class="s"> ms."</span><span class="p">),</span>
            <span class="n">context</span><span class="p">.</span><span class="n">ServiceScope</span>
        <span class="p">);</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">async</span> <span class="n">ValueTask</span><span class="p">&lt;</span><span class="n">PayloadWithScope</span><span class="p">&lt;</span><span class="n">PayloadResult</span><span class="p">&gt;&gt;</span> <span class="nf">Step2</span><span class="p">(</span>
        <span class="n">PayloadWithScope</span><span class="p">&lt;</span><span class="n">Payload2</span><span class="p">&gt;</span> <span class="n">context</span>
    <span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">payload</span> <span class="p">=</span> <span class="n">context</span><span class="p">.</span><span class="n">Payload</span><span class="p">;</span>
        <span class="kt">var</span> <span class="n">timeProvider</span> <span class="p">=</span> <span class="n">context</span><span class="p">.</span><span class="n">GetRequiredService</span><span class="p">&lt;</span><span class="n">TimeProvider</span><span class="p">&gt;();</span>

        <span class="kt">var</span> <span class="n">delay</span> <span class="p">=</span> <span class="n">Random</span><span class="p">.</span><span class="n">Shared</span><span class="p">.</span><span class="nf">Next</span><span class="p">(</span><span class="n">MinDelay</span><span class="p">,</span> <span class="n">MaxDelay</span><span class="p">);</span>
        <span class="k">await</span> <span class="n">Task</span><span class="p">.</span><span class="nf">Delay</span><span class="p">(</span><span class="n">delay</span><span class="p">);</span>

        <span class="k">return</span> <span class="k">new</span><span class="p">(</span>
            <span class="k">new</span><span class="p">(</span><span class="n">payload</span><span class="p">.</span><span class="n">Name</span><span class="p">,</span> <span class="n">payload</span><span class="p">.</span><span class="n">CreatedAt</span><span class="p">,</span> <span class="n">payload</span><span class="p">.</span><span class="n">Message</span><span class="p">,</span> <span class="n">timeProvider</span><span class="p">.</span><span class="nf">GetUtcNow</span><span class="p">()),</span>
            <span class="n">context</span><span class="p">.</span><span class="n">ServiceScope</span>
        <span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="n">ChannelWriter</span><span class="p">&lt;</span><span class="n">Payload</span><span class="p">&gt;</span> <span class="n">Writer</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">public</span> <span class="n">ChannelReader</span><span class="p">&lt;</span><span class="n">PayloadResult</span><span class="p">&gt;</span> <span class="n">Reader</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>In order to use the pipeline, we can register <code class="language-plaintext highlighter-rouge">IBackgroundProcessor</code>:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">interface</span> <span class="nc">IBackgroundProcessor</span>
<span class="p">{</span>
    <span class="n">ValueTask</span> <span class="nf">QueueBackgroundWorkItemAsync</span><span class="p">(</span>
        <span class="n">Payload</span> <span class="n">payload</span><span class="p">,</span>
        <span class="n">CancellationToken</span> <span class="n">cancellationToken</span> <span class="p">=</span> <span class="k">default</span>
    <span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Here is how DI registration looks like:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">var</span> <span class="n">builder</span> <span class="p">=</span> <span class="n">WebApplication</span><span class="p">.</span><span class="nf">CreateBuilder</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>

<span class="n">builder</span><span class="p">.</span><span class="n">Services</span><span class="p">.</span><span class="n">AddHostedService</span><span class="p">&lt;</span><span class="n">ProcessorBackgroundService</span><span class="p">&gt;();</span>
<span class="n">builder</span><span class="p">.</span><span class="n">Services</span><span class="p">.</span><span class="n">AddSingleton</span><span class="p">&lt;</span><span class="n">ProcessorChannel</span><span class="p">&gt;();</span>
<span class="n">builder</span><span class="p">.</span><span class="n">Services</span><span class="p">.</span><span class="n">AddSingleton</span><span class="p">&lt;</span><span class="n">IBackgroundProcessor</span><span class="p">,</span> <span class="n">ProcessorChannel</span><span class="p">&gt;();</span>
<span class="n">builder</span><span class="p">.</span><span class="n">Services</span><span class="p">.</span><span class="n">AddSingleton</span><span class="p">&lt;</span><span class="n">TimeProvider</span><span class="p">&gt;(</span><span class="n">_</span> <span class="p">=&gt;</span> <span class="n">TimeProvider</span><span class="p">.</span><span class="n">System</span><span class="p">);</span>

<span class="n">builder</span><span class="p">.</span><span class="n">Services</span><span class="p">.</span><span class="n">AddSingleton</span><span class="p">&lt;</span><span class="n">ChannelReader</span><span class="p">&lt;</span><span class="n">PayloadResult</span><span class="p">&gt;&gt;(</span><span class="n">sp</span> <span class="p">=&gt;</span>
    <span class="n">sp</span><span class="p">.</span><span class="n">GetRequiredService</span><span class="p">&lt;</span><span class="n">ProcessorChannel</span><span class="p">&gt;().</span><span class="n">Reader</span>
<span class="p">);</span>

<span class="n">builder</span><span class="p">.</span><span class="n">Services</span><span class="p">.</span><span class="n">Configure</span><span class="p">&lt;</span><span class="n">ProcessorChannelSettings</span><span class="p">&gt;(</span><span class="n">options</span> <span class="p">=&gt;</span>
<span class="p">{</span>
    <span class="n">options</span><span class="p">.</span><span class="n">Capacity</span> <span class="p">=</span> <span class="m">25</span><span class="p">;</span>
    <span class="n">options</span><span class="p">.</span><span class="n">Step1Capacity</span> <span class="p">=</span> <span class="m">10</span><span class="p">;</span>
    <span class="n">options</span><span class="p">.</span><span class="n">Step1MaxConcurrency</span> <span class="p">=</span> <span class="m">5</span><span class="p">;</span>
    <span class="n">options</span><span class="p">.</span><span class="n">Step2Capacity</span> <span class="p">=</span> <span class="m">10</span><span class="p">;</span>
    <span class="n">options</span><span class="p">.</span><span class="n">Step2MaxConcurrency</span> <span class="p">=</span> <span class="m">2</span><span class="p">;</span>
<span class="p">});</span>

<span class="kt">var</span> <span class="n">app</span> <span class="p">=</span> <span class="n">builder</span><span class="p">.</span><span class="nf">Build</span><span class="p">();</span>
</code></pre></div></div>

<p>Here is how to offload (dispatch) a task to the pipeline from an endpoint:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">app</span><span class="p">.</span><span class="nf">MapPost</span><span class="p">(</span>
    <span class="s">"/start"</span><span class="p">,</span>
    <span class="k">async</span> <span class="p">(</span>
        <span class="p">[</span><span class="n">FromBody</span><span class="p">]</span> <span class="n">Payload</span> <span class="n">payload</span><span class="p">,</span>
        <span class="n">IBackgroundProcessor</span> <span class="n">writer</span><span class="p">,</span>
        <span class="n">CancellationToken</span> <span class="n">cancellationToken</span>
    <span class="p">)</span> <span class="p">=&gt;</span>
    <span class="p">{</span>
        <span class="k">await</span> <span class="n">writer</span><span class="p">.</span><span class="nf">QueueBackgroundWorkItemAsync</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="n">cancellationToken</span><span class="p">);</span>

        <span class="k">return</span> <span class="n">TypedResults</span><span class="p">.</span><span class="nf">Ok</span><span class="p">(</span><span class="k">new</span> <span class="p">{</span> <span class="n">Success</span> <span class="p">=</span> <span class="k">true</span> <span class="p">});</span>
    <span class="p">}</span>
<span class="p">)</span>
</code></pre></div></div>

<p>On a receiving end, we have <code class="language-plaintext highlighter-rouge">ProcessorBackgroundService</code>:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">class</span> <span class="nc">ProcessorBackgroundService</span><span class="p">(</span>
    <span class="n">ChannelReader</span><span class="p">&lt;</span><span class="n">PayloadResult</span><span class="p">&gt;</span> <span class="n">reader</span><span class="p">,</span>
    <span class="n">ILogger</span><span class="p">&lt;</span><span class="n">ProcessorBackgroundService</span><span class="p">&gt;</span> <span class="n">logger</span>
<span class="p">)</span> <span class="p">:</span> <span class="n">BackgroundService</span>
<span class="p">{</span>
    <span class="k">protected</span> <span class="k">override</span> <span class="k">async</span> <span class="n">Task</span> <span class="nf">ExecuteAsync</span><span class="p">(</span><span class="n">CancellationToken</span> <span class="n">stoppingToken</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">await</span> <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">_</span> <span class="k">in</span> <span class="n">reader</span><span class="p">.</span><span class="nf">ReadAllAsync</span><span class="p">(</span><span class="n">stoppingToken</span><span class="p">))</span>
        <span class="p">{</span>
            <span class="n">logger</span><span class="p">.</span><span class="nf">LogProcessedByWorker</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The processing of item in the pipeline starts based on queue and <code class="language-plaintext highlighter-rouge">ProcessorBackgroundService</code> is only used as a receiving end (consumer) to retrieve the results.</p>

<h2 id="adding-opentelemetry">Adding OpenTelemetry</h2>

<p>OpenTelemetry is a powerful observability framework that helps you understand what happens inside your application‚Äôs pipeline. It provides a standardized way to collect, instrument, and export telemetry data, such as metrics, traces, and logs.</p>

<p>By integrating OpenTelemetry into your application, you gain visibility into the internal workings of your code. This visibility allows you to monitor and analyze the performance, behavior, and dependencies of your application components. Here‚Äôs how OpenTelemetry helps in understanding the pipeline:</p>

<ul>
  <li>
    <p><strong>Metrics</strong>: OpenTelemetry allows you to collect and analyze various metrics, such as CPU usage, memory consumption, request latency, and error rates. These metrics provide insights into the overall health and performance of your application. By monitoring these metrics, you can identify bottlenecks, optimize resource utilization, and detect anomalies.</p>
  </li>
  <li>
<strong>Tracing</strong>: OpenTelemetry enables distributed tracing, which helps you understand the flow of requests across different services and components in your application. With distributed tracing, you can track the path of a request as it traverses through various microservices, databases, and external dependencies. This helps you identify performance bottlenecks, latency issues, and problematic dependencies. Traces also provide a detailed timeline of events, allowing you to pinpoint the exact location of issues and optimize the critical path.</li>
  <li>
<strong>Logging</strong>: OpenTelemetry allows you to capture and analyze logs from your application. Logs provide valuable information about the execution flow, error messages, and other important events. By aggregating and analyzing logs, you can troubleshoot issues, detect errors, and gain insights into the behavior of your application.</li>
  <li>
<strong>Context Propagation</strong>: OpenTelemetry provides context propagation mechanisms that allow you to pass contextual information, such as request IDs and correlation IDs, across different services and components. This helps in correlating logs, traces, and metrics related to a specific request or transaction, making it easier to understand the end-to-end flow and troubleshoot issues.</li>
</ul>

<p>‚ùóüí°For this blog post I will not explain how to instrument pipelines using OpenTelemetry for the sake of simplicity, but I strongly recommend you taking a look at source code for more details: <a href="https://github.com/NikiforovAll/channels-composition-and-otel/tree/main" target="_blank" rel="noopener noreferrer">https://github.com/NikiforovAll/channels-composition-and-otel/tree/main</a></p>

<h2 id="demo">Demo</h2>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dotnet run <span class="nt">--project</span> ./src/AppHost
</code></pre></div></div>

<h3 id="running-single-request">Running single request</h3>

<p>Let‚Äôs run a single request:</p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>POST /start
Content-Type: application/json

{
    "name": "Task 1"
}
</code></pre></div></div>

<p>Here is the trace result for an operation:</p>

<p><img src="/assets/channels-composition/pipeline-trace.png"></p>

<p>The visualization shows the sequence and timing of each span in the trace, indicating the flow of the request through different components of the service. The longer bars represent spans that took more time to complete, and the gaps between bars indicate idle time or time spent waiting for a response from another service or component.</p>

<ul>
  <li>
<strong>Trace ID:</strong> ff2e438d-a6d6-4264-b06d-3a2b035a79d9</li>
  <li>
<strong>Endpoint:</strong> POST /start</li>
  <li>
<strong>Duration:</strong> 1.67s</li>
  <li>
<strong>Depth:</strong> 3</li>
  <li>
<strong>Total Spans:</strong> 5</li>
</ul>

<p>Spans:</p>

<ol>
  <li>
<strong>POST /start</strong>
    <ul>
      <li>
<strong>Duration:</strong> 114.82ms</li>
    </ul>
  </li>
  <li>
<strong>Queue item</strong>
    <ul>
      <li>
<strong>Duration:</strong> 652us</li>
    </ul>
  </li>
  <li>
<strong>ProcessPipeline</strong>
    <ul>
      <li>
<strong>Duration:</strong> 1.56s</li>
    </ul>
  </li>
  <li>
<strong>Step1</strong>
    <ul>
      <li>
<strong>Duration:</strong> 724.35ms</li>
    </ul>
  </li>
  <li>
<strong>Step2</strong>
    <ul>
      <li>
<strong>Duration:</strong> 827.59ms</li>
    </ul>
  </li>
</ol>

<h3 id="adding-custom-metrics-and-using-bombardier">Adding custom metrics and using Bombardier</h3>

<p>As mentioned above, I will not show use the details of OpenTelemetry instrumentation in this blog post, but in full-implementation I‚Äôve added a couple of metrics that allows us to inspect how many requests are under processing by the pipeline:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">static</span> <span class="k">class</span> <span class="nc">ServiceMetrics</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="k">static</span> <span class="n">Meter</span> <span class="n">_meter</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Meter</span><span class="p">(</span><span class="s">"MyService.Pipelines"</span><span class="p">);</span>

    <span class="k">public</span> <span class="k">static</span> <span class="n">Counter</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;</span> <span class="n">StartedCounter</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span> <span class="p">=</span>
        <span class="n">_meter</span><span class="p">.</span><span class="n">CreateCounter</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;(</span><span class="s">"pipelines.started"</span><span class="p">);</span>

    <span class="k">public</span> <span class="k">static</span> <span class="n">UpDownCounter</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;</span> <span class="n">InProgressCounter</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span> <span class="p">=</span>
        <span class="n">_meter</span><span class="p">.</span><span class="n">CreateUpDownCounter</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;(</span><span class="s">"pipelines.in-progress"</span><span class="p">);</span>

    <span class="k">public</span> <span class="k">static</span> <span class="n">UpDownCounter</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;</span> <span class="n">InProgressStep1Counter</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span> <span class="p">=</span>
        <span class="n">_meter</span><span class="p">.</span><span class="n">CreateUpDownCounter</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;(</span><span class="s">"pipelines.step1.in-progress"</span><span class="p">);</span>

    <span class="k">public</span> <span class="k">static</span> <span class="n">UpDownCounter</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;</span> <span class="n">InProgressStep2Counter</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span> <span class="p">=</span>
        <span class="n">_meter</span><span class="p">.</span><span class="n">CreateUpDownCounter</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;(</span><span class="s">"pipelines.step2.in-progress"</span><span class="p">);</span>
    <span class="k">public</span> <span class="k">static</span> <span class="n">Counter</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;</span> <span class="n">FinishedCounter</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span> <span class="p">=</span>
        <span class="n">_meter</span><span class="p">.</span><span class="n">CreateCounter</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;(</span><span class="s">"pipelines.finished"</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Here is how to inspect the metrics during the runtime (see the results in demo below):</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dotnet-counters monitor <span class="nt">-n</span> API <span class="nt">--counters</span> MyService.Pipelines
</code></pre></div></div>

<p>Bombardier is a powerful HTTP load testing tool. It‚Äôs a command-line utility that allows you to generate high volumes of HTTP traffic to test the performance and scalability of your web services. Here‚Äôs how you can use it:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash</span>

<span class="nv">url</span><span class="o">=</span><span class="s2">"http://localhost:5046/start"</span>
<span class="nv">requests</span><span class="o">=</span><span class="k">${</span><span class="nv">1</span><span class="k">:-</span><span class="nv">50</span><span class="k">}</span>

<span class="c"># Invoke bombardier with additional options</span>
bombardier <span class="nt">-m</span> POST <span class="nt">-H</span> <span class="s1">'Content-Type: application/json'</span> <span class="nt">-b</span> <span class="s1">'{"name": "Task"}'</span> <span class="nt">-n</span> <span class="nv">$requests</span> <span class="nv">$url</span>
</code></pre></div></div>

<h3 id="running-multiple-requests">Running multiple requests</h3>

<p>Here is an example of making additional 50 simultaneous requests via Bombardier (the image below also contains the result of previous 50 requests run). Note, on the right side we have <code class="language-plaintext highlighter-rouge">dotnet-counters</code> launched, it allows us to see the <code class="language-plaintext highlighter-rouge">MyService.Pipelines</code> metrics.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>./scripts/bombardier.sh 50
</code></pre></div></div>

<p><img src="/assets/channels-composition/metrics.png"></p>

<p>Also, I‚Äôve changed the way we collect traces for the demo (using <code class="language-plaintext highlighter-rouge">ProcessorChannelSettings.UseUnifiedSpanForAllPipelines=true</code> parameter), the traces are collected under <code class="language-plaintext highlighter-rouge">ProcessorBackgroundService</code> root Span for visualization purposes. Please don‚Äôt put huge number of traces under one Span in production scenarios.</p>

<p><img src="/assets/channels-composition/batch-trace.png"></p>

<p>In the image above, we can see how items are concurrently processed by the pipeline. It is interesting how various settings can impact the way our pipeline behaves.</p>

<p>I recommend you to play with it on your own:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">class</span> <span class="nc">ProcessorChannelSettings</span>
<span class="p">{</span>
    <span class="p">[</span><span class="nf">Range</span><span class="p">(</span><span class="m">1</span><span class="p">,</span> <span class="m">100</span><span class="p">,</span> <span class="n">ErrorMessage</span> <span class="p">=</span> <span class="s">"Capacity must be at least 1"</span><span class="p">)]</span>
    <span class="k">public</span> <span class="kt">int</span> <span class="n">Capacity</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

    <span class="p">[</span><span class="nf">Range</span><span class="p">(</span><span class="m">1</span><span class="p">,</span> <span class="m">100</span><span class="p">)]</span>
    <span class="k">public</span> <span class="kt">int</span> <span class="n">Step1Capacity</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

    <span class="p">[</span><span class="nf">Range</span><span class="p">(</span><span class="m">1</span><span class="p">,</span> <span class="m">10</span><span class="p">)]</span>
    <span class="k">public</span> <span class="kt">int</span> <span class="n">Step1MaxConcurrency</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

    <span class="p">[</span><span class="nf">Range</span><span class="p">(</span><span class="m">1</span><span class="p">,</span> <span class="m">100</span><span class="p">)]</span>
    <span class="k">public</span> <span class="kt">int</span> <span class="n">Step2Capacity</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

    <span class="p">[</span><span class="nf">Range</span><span class="p">(</span><span class="m">1</span><span class="p">,</span> <span class="m">10</span><span class="p">)]</span>
    <span class="k">public</span> <span class="kt">int</span> <span class="n">Step2MaxConcurrency</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

    <span class="p">[</span><span class="nf">Range</span><span class="p">(</span><span class="m">1</span><span class="p">,</span> <span class="m">10</span><span class="p">)]</span>
    <span class="k">public</span> <span class="kt">int</span> <span class="n">MaxConcurrency</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span> <span class="p">=</span> <span class="m">5</span><span class="p">;</span>

    <span class="k">public</span> <span class="kt">bool</span> <span class="n">UseUnifiedSpanForAllPipelines</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Here is how configuration looks like:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">builder</span><span class="p">.</span><span class="n">Services</span><span class="p">.</span><span class="n">Configure</span><span class="p">&lt;</span><span class="n">ProcessorChannelSettings</span><span class="p">&gt;(</span><span class="n">options</span> <span class="p">=&gt;</span>
<span class="p">{</span>
    <span class="n">options</span><span class="p">.</span><span class="n">Capacity</span> <span class="p">=</span> <span class="m">25</span><span class="p">;</span>
    <span class="n">options</span><span class="p">.</span><span class="n">Step1Capacity</span> <span class="p">=</span> <span class="m">10</span><span class="p">;</span>
    <span class="n">options</span><span class="p">.</span><span class="n">Step1MaxConcurrency</span> <span class="p">=</span> <span class="m">5</span><span class="p">;</span>
    <span class="n">options</span><span class="p">.</span><span class="n">Step2Capacity</span> <span class="p">=</span> <span class="m">10</span><span class="p">;</span>
    <span class="n">options</span><span class="p">.</span><span class="n">Step2MaxConcurrency</span> <span class="p">=</span> <span class="m">2</span><span class="p">;</span>

    <span class="n">options</span><span class="p">.</span><span class="n">UseUnifiedSpanForAllPipelines</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>
<span class="p">});</span>
</code></pre></div></div>

<h2 id="conclusion">Conclusion</h2>

<p>In conclusion, the job offloading pattern is a crucial design pattern in modern software development. It allows for efficient distribution of tasks, leading to improved performance and scalability of applications. By offloading tasks to background services or other systems, the main application thread remains unblocked, ensuring a smooth and responsive user experience.</p>

<p>Moreover, the importance of OpenTelemetry instrumentation cannot be overstated. It provides invaluable insights into the performance and behavior of your applications. With it, you can trace requests as they flow through various components, measure latencies, and gather other critical metrics. This data is essential for identifying bottlenecks, understanding system behavior, and making informed decisions to optimize your applications.</p>

<p>By combining the job offloading pattern with OpenTelemetry instrumentation, you can build robust, scalable, and observable pipelines that can handle high volumes of traffic and deliver superior performance.</p>

<h2 id="references">References</h2>

<ul>
  <li><a href="https://devblogs.microsoft.com/dotnet/an-introduction-to-system-threading-channels/" target="_blank" rel="noopener noreferrer">https://devblogs.microsoft.com/dotnet/an-introduction-to-system-threading-channels/</a></li>
  <li><a href="https://github.com/Open-NET-Libraries/Open.ChannelExtensions" target="_blank" rel="noopener noreferrer">https://github.com/Open-NET-Libraries/Open.ChannelExtensions</a></li>
  <li><a href="https://blog.maartenballiauw.be/post/2020/08/26/producer-consumer-pipelines-with-system-threading-channels.html" target="_blank" rel="noopener noreferrer">https://blog.maartenballiauw.be/post/2020/08/26/producer-consumer-pipelines-with-system-threading-channels.html</a></li>
  <li><a href="https://deniskyashif.com/2019/12/08/csharp-channels-part-1/" target="_blank" rel="noopener noreferrer">https://deniskyashif.com/2019/12/08/csharp-channels-part-1/</a></li>
  <li><a href="https://github.com/martinjt/dotnet-background-otel/tree/main" target="_blank" rel="noopener noreferrer">https://github.com/martinjt/dotnet-background-otel/tree/main</a></li>
  <li><a href="https://learn.microsoft.com/en-us/dotnet/core/diagnostics/distributed-tracing-instrumentation-walkthroughs" target="_blank" rel="noopener noreferrer">https://learn.microsoft.com/en-us/dotnet/core/diagnostics/distributed-tracing-instrumentation-walkthroughs</a></li>
  <li><a href="https://opentelemetry.io/docs/languages/net/instrumentation/" target="_blank" rel="noopener noreferrer">https://opentelemetry.io/docs/languages/net/instrumentation/</a></li>
  <li><a href="https://github.com/open-telemetry/opentelemetry-dotnet/tree/main/examples/MicroserviceExample" target="_blank" rel="noopener noreferrer">https://github.com/open-telemetry/opentelemetry-dotnet/tree/main/examples/MicroserviceExample</a></li>
  <li><a href="https://learn.microsoft.com/en-us/dotnet/core/diagnostics/metrics-instrumentation" target="_blank" rel="noopener noreferrer">https://learn.microsoft.com/en-us/dotnet/core/diagnostics/metrics-instrumentation</a></li>
</ul>

	</div>

	

	
	<ul class="list-inline">
		<li>
<i class="fa-solid fa-bookmark"></i> Topics:</li>
		
		
		
		<li>
			<a href="/topics.html#dotnet-cat-ref">
				dotnet <span>(58)</span>
			</a>
			 ¬∑
		</li>
		
		<li>
			<a href="/topics.html#async-cat-ref">
				async <span>(3)</span>
			</a>
			 ¬∑
		</li>
		
		
		
		
		
		<li>
			<a href="/topics.html#dotnet-tag-ref">
				dotnet <span>(63)</span>
			</a>
			 ¬∑
		</li>
		
		<li>
			<a href="/topics.html#aspnetcore-tag-ref">
				aspnetcore <span>(24)</span>
			</a>
			 ¬∑
		</li>
		
		<li>
			<a href="/topics.html#pipelines-tag-ref">
				pipelines <span>(4)</span>
			</a>
			 ¬∑
		</li>
		
		<li>
			<a href="/topics.html#async-tag-ref">
				async <span>(5)</span>
			</a>
			 ¬∑
		</li>
		
		<li>
			<a href="/topics.html#opentelemetry-tag-ref">
				opentelemetry <span>(4)</span>
			</a>
			
		</li>
		
		
		
	</ul>
	

	<hr>

	<div>
		<section class="share col-sm-6">
			<h4 class="section-title">Share Post</h4>
			<a class="btn btn-default btn-sm twitter" href="http://x.com/share?&amp;via=nikiforovall" onclick="window.open(this.href, 'x-share', 'width=550,height=235');return false;" target="_blank" rel="noopener noreferrer">
				<i class="fa-brands fa-x-twitter fa-lg"></i>
				X
			</a>
		</section>

		<section class="col-sm-6 author">
			<img src="//www.gravatar.com/avatar/e86fa0938976c38907a302ecb208f011" class="img-rounded author-image">
			<h4 class="section-title author-name">Oleksii Nikiforov</h4>
			<p class="author-bio">Jibber-jabbering about programming and IT.</p>
		</section>
	</div>

	<div class="clearfix"></div>

	<ul class="pager">
		
		<li class="previous"><a href="/dotnet/async/2024/04/21/channels-composition.html" title="Building pipelines with System.Threading.Channels">‚Üê
				Previous</a></li>
		
		
		<li class="next">
<a href="/dotnet/keycloak/2024/05/05/keycloak-v2-0-0.html" title="Announcement - Keycloak.AuthServices v2.0.0 is out üéâ!">Next ‚Üí</a>
		</li>
		
	</ul>

	<hr>
	</div>

	<div class="col-sm-2 sidebar-2">

	</div>

</article>
<div class="clearfix"></div>



    
    <script src="https://utteranc.es/client.js" repo="NikiforovAll/nikiforovall.github.io" issue-term="pathname" label="Blog" theme="preferred-color-scheme" crossorigin="anonymous" async>
    </script>





		<footer>
			<hr>
			<p>
				¬© 2025 Oleksii Nikiforov with <a href="http://jekyllrb.com/" target="_blank" rel="noopener noreferrer">Jekyll</a>. Theme: <a href="https://github.com/dbtek/dbyll" target="_blank" rel="noopener noreferrer">dbyll</a> by dbtek.
			</p>
		</footer>
	</div>

	<script type="text/javascript" src="/assets/resources/jquery/jquery.min.js"></script>
	<script type="text/javascript" src="/assets/resources/bootstrap/js/bootstrap.min.js"></script>
	<script type="text/javascript" src="/assets/js/app.js"></script>
	<script src="https://unpkg.com/lunr/lunr.js"></script>
	<script type="text/javascript" src="/assets/js/search.js"></script>
	
		<script type="text/javascript" src="https://unpkg.com/mermaid@10.9.0/dist/mermaid.min.js">
</script>
<script>
$(document).ready(function() {
    mermaid.initialize({
        theme: 'forest'
    });
});
</script>

	
</body>
</html>



<!-- Asynchronous Google Analytics snippet -->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-164555539-1', 'auto');
  ga('send', 'pageview');
</script>

