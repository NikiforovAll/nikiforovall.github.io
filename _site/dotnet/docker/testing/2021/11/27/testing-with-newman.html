<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<!-- <meta http-equiv="Content-Security-Policy" content="frame-src https://try.dot.net;"> -->
	<title>A developer guide to automated testing with Postman. Run postman collections inside Docker via newman CLI.</title>
	
	<meta name="author" content="Oleksii Nikiforov">

	<!-- Enable responsive viewport -->
	<meta name="viewport" content="width=device-width, initial-scale=1.0">

	<!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
	<!--[if lt IE 9]>
	<script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
	<![endif]-->

	<!-- Le styles -->
	<link href="https://nikiforovall.github.io/assets/resources/bootstrap/css/bootstrap.min.css" rel="stylesheet">
	<link href="https://nikiforovall.github.io/assets/resources/font-awesome/css/font-awesome.min.css" rel="stylesheet">
	<link href="https://nikiforovall.github.io/assets/resources/syntax/syntax.css" rel="stylesheet">
	<link href="https://nikiforovall.github.io/assets/css/style.css" rel="stylesheet">

	<!-- Le fav and touch icons -->
	<!-- Update these with your own images
	<link rel="shortcut icon" href="images/favicon.ico">
	<link rel="apple-touch-icon" href="images/apple-touch-icon.png">
	<link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
	<link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
	-->
	<link rel="shortcut icon" href="/assets/media/favicon.ico">

	<link rel="alternate" type="application/rss+xml" title="" href="https://nikiforovall.github.io/feed.xml">
</head>

<body>
	<nav class="navbar navbar-default visible-xs" role="navigation">
		<!-- Brand and toggle get grouped for better mobile display -->
		<div class="navbar-header">
			<button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
				<span class="sr-only">Toggle navigation</span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</button>
			
			<a type="button" class="navbar-toggle nav-link" href="http://github.com/nikiforovAll" target="_blank" rel="noopener noreferrer">
				<i class="fa fa-github"></i>
			</a>
			
			
			<a type="button" class="navbar-toggle nav-link" href="http://twitter.com/nikiforovall" target="_blank" rel="noopener noreferrer">
				<i class="fa fa-twitter"></i>
			</a>
			
			
			<a type="button" class="navbar-toggle nav-link" href="mailto:alexey.nikiforovall@gmail.com">
				<i class="fa fa-envelope"></i>
			</a>
			
			<a class="navbar-brand" href="https://nikiforovall.github.io/" target="_blank" rel="noopener noreferrer">
				<img src="//www.gravatar.com/avatar/e86fa0938976c38907a302ecb208f011?s=35" class="img-circle">
				N+1 Blog
			</a>
		</div>

		<!-- Collect the nav links, forms, and other content for toggling -->
		<div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
			<ul class="nav navbar-nav">
				<li class="active"><a href="https://nikiforovall.github.io/" target="_blank" rel="noopener noreferrer">Home</a></li>
				<li><a href="https://nikiforovall.github.io/categories.html" target="_blank" rel="noopener noreferrer">Categories</a></li>
				<li><a href="https://nikiforovall.github.io/tags.html" target="_blank" rel="noopener noreferrer">Tags</a></li>
				<li><a href="https://nikiforovall.github.io/about.html" target="_blank" rel="noopener noreferrer">About</a></li>
			</ul>
		</div>
<!-- /.navbar-collapse -->
	</nav>

	<!-- nav-menu-dropdown -->
	<div class="btn-group hidden-xs" id="nav-menu">
		<button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">
			<i class="fa fa-bars"></i>
		</button>
		<ul class="dropdown-menu" role="menu">
			<li><a href="https://nikiforovall.github.io/" target="_blank" rel="noopener noreferrer"><i class="fa fa-home"></i>Home</a></li>
			<li><a href="https://nikiforovall.github.io/categories.html" target="_blank" rel="noopener noreferrer"><i class="fa fa-folder"></i>Categories</a></li>
			<li><a href="https://nikiforovall.github.io/tags.html" target="_blank" rel="noopener noreferrer"><i class="fa fa-tags"></i>Tags</a></li>
			<li><a href="https://nikiforovall.github.io/about.html" target="_blank" rel="noopener noreferrer"><i class="fa fa-pencil"></i>About</a></li>
			<li class="divider">
			<li><a href="#"><i class="fa fa-arrow-up"></i>Top of Page</a></li>
		</ul>
	</div>

	<div class="col-sm-3 sidebar hidden-xs" style="">
		<!-- sidebar.html -->
<header class="sidebar-header" role="banner">
	<a href="https://nikiforovall.github.io/" target="_blank" rel="noopener noreferrer">
		<img src="//www.gravatar.com/avatar/e86fa0938976c38907a302ecb208f011?s=150" class="img-circle">
	</a>
	<h3 class="title">
        <a href="https://nikiforovall.github.io/" target="_blank" rel="noopener noreferrer">N+1 Blog</a>
    </h3>
</header>


<div id="bio" class="text-center">
	Jibber-jabbering about programming and IT.
</div>


<div id="contact-list" class="text-center">
	<ul class="list-unstyled list-inline">
		
		<li>
			<a class="btn btn-default btn-sm" href="https://github.com/nikiforovAll" target="_blank" rel="noopener noreferrer">
				<i class="fa fa-github-alt fa-lg"></i>
			</a>
		</li>
		
		
		<li>
			<a class="btn btn-default btn-sm" href="https://twitter.com/nikiforovall" target="_blank" rel="noopener noreferrer">
				<i class="fa fa-twitter fa-lg"></i>
			</a>
		</li>
		
		
		<li>
			<a class="btn btn-default btn-sm" href="https://t.me/nikiforovallblog" target="_blank" rel="noopener noreferrer">
				<i class="fa fa-pencil-square fa-lg"></i>
			</a>
		</li>
		
		
		<li>
			<a class="btn btn-default btn-sm" href="mailto:alexey.nikiforovall@gmail.com">
				<i class="fa fa-envelope fa-lg"></i>
			</a>
		</li>
		
	</ul>
	<ul id="contact-list-secondary" class="list-unstyled list-inline">
		
		
		<li>
			<a class="btn btn-default btn-sm" href="https://linkedin.com/in/nikiforov-oleksii" target="_blank" rel="noopener noreferrer">
				<i class="fa fa-linkedin fa-lg"></i>
			</a>
		</li>
		
		<li>
			<a class="btn btn-default btn-sm" href="https://nikiforovall.github.io/feed.xml" target="_blank" rel="noopener noreferrer">
				<i class="fa fa-rss fa-lg"></i>
			</a>
		</li>
	</ul>
</div>
<!-- sidebar.html end -->

	</div>

	<div class="col-sm-9 col-sm-offset-3">
		<div class="page-header">
	<h1>A developer guide to automated testing with Postman. Run postman collections inside Docker via newman CLI. </h1>
</div>
<article>

	<div class="col-sm-10">

		<span class="post-date">
			
			November
			27th,
			
			2021
		</span>

	
	
	
	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	
	

	<div class="article_body" style="margin-top: 30px;">
		<h2 id="tldr">TL;DR</h2>

<p>See a practical example of how to write and execute postman collections inside a Docker container. Source code <a href="https://github.com/NikiforovAll/testing-with-newman-demo" target="_blank" rel="noopener noreferrer">https://github.com/NikiforovAll/testing-with-newman-demo</a>.</p>

<h2 id="introduction">Introduction</h2>

<p>What is Automated Testing?</p>
<blockquote>
  <p>Tests are automated by creating test suites that can run again and again. Postman can be used to automate many types of tests including unit tests, functional tests, integration tests, end-to-end tests, regression tests, mock tests, etc. Automated testing prevents human error and streamlines testing.</p>
</blockquote>

<p>Postman offers a comprehensive <a href="https://www.postman.com/automated-testing/" target="_blank" rel="noopener noreferrer">API testing tool</a> that makes it easy to set up automated tests. Organizing your requests into Postman Collections enables you to run and automate a series of requests.</p>

<h3 id="an-example">An Example</h3>

<p>Let‚Äôs say we want to start refactoring of some microservice called ‚ÄúOrder Service‚Äù. Before we start our refactoring we want to make sure that we don‚Äôt break anything in the meantime. A very common migration strategy is to invest time into writing tests to lower the risk of regression bugs and migration errors. We will use postman and cover ‚ÄúOrder Service‚Äù with automated API tests to ensure a successful migration.</p>

<p>In this example, ‚ÄúOrder Service‚Äù is quite small and has one responsibility of order processing.</p>

<p>Use cases:</p>

<ol>
  <li>As a user I want to be able to create orders so it is possible to buy goods for money</li>
  <li>As a user I want to close order</li>
  <li>As a user I expect order status to be completed when someone successfully pays for it.</li>
</ol>

<p><img src="/assets/testing-with-newman/program-cs-code-snap.png" width="600">
<img src="/assets/testing-with-newman/routes-overview.png" width="600"></p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">static</span> <span class="k">class</span> <span class="nc">OrderApiRoutes</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">static</span> <span class="n">WebApplication</span> <span class="nf">MapOrderApiRoutes</span><span class="p">(</span><span class="k">this</span> <span class="n">WebApplication</span> <span class="n">app</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">app</span><span class="p">.</span><span class="nf">MapPost</span><span class="p">(</span><span class="s">"/orders/"</span><span class="p">,</span> <span class="n">CreateOrder</span><span class="p">);</span>
        <span class="n">app</span><span class="p">.</span><span class="nf">MapGet</span><span class="p">(</span><span class="s">"/orders"</span><span class="p">,</span> <span class="n">GetOrders</span><span class="p">);</span>
        <span class="n">app</span><span class="p">.</span><span class="nf">MapGet</span><span class="p">(</span><span class="s">"/orders/{id}"</span><span class="p">,</span> <span class="n">GetOrderById</span><span class="p">).</span><span class="nf">WithName</span><span class="p">(</span><span class="k">nameof</span><span class="p">(</span><span class="n">GetOrderById</span><span class="p">));</span>
        <span class="n">app</span><span class="p">.</span><span class="nf">MapPut</span><span class="p">(</span><span class="s">"/orders/{id}/cancel"</span><span class="p">,</span> <span class="n">CancelOrderById</span><span class="p">);</span>

        <span class="k">return</span> <span class="n">app</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">static</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">IResult</span><span class="p">&gt;</span> <span class="nf">CancelOrderById</span><span class="p">(</span><span class="kt">ulong</span> <span class="n">id</span><span class="p">,</span> <span class="n">IMongoClient</span> <span class="n">mongoClient</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">db</span> <span class="p">=</span> <span class="n">mongoClient</span><span class="p">.</span><span class="nf">GetOrderCollection</span><span class="p">();</span>
        <span class="kt">var</span> <span class="n">order</span> <span class="p">=</span> <span class="k">await</span> <span class="n">db</span><span class="p">.</span><span class="nf">Find</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">Id</span> <span class="p">==</span> <span class="n">id</span><span class="p">).</span><span class="nf">FirstOrDefaultAsync</span><span class="p">();</span>

        <span class="k">if</span><span class="p">(</span><span class="n">order</span> <span class="k">is</span> <span class="k">null</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="n">Results</span><span class="p">.</span><span class="nf">NotFound</span><span class="p">();</span>
        <span class="p">}</span>
        <span class="n">order</span><span class="p">.</span><span class="nf">Cancel</span><span class="p">();</span>
        <span class="k">await</span> <span class="n">db</span><span class="p">.</span><span class="nf">ReplaceOneAsync</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">Id</span> <span class="p">==</span> <span class="n">id</span><span class="p">,</span> <span class="n">order</span><span class="p">);</span>

        <span class="k">return</span> <span class="n">Results</span><span class="p">.</span><span class="nf">NoContent</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">static</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">Order</span><span class="p">&gt;</span> <span class="nf">GetOrderById</span><span class="p">(</span><span class="kt">ulong</span> <span class="n">id</span><span class="p">,</span> <span class="n">IMongoClient</span> <span class="n">mongoClient</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">db</span> <span class="p">=</span> <span class="n">mongoClient</span><span class="p">.</span><span class="nf">GetOrderCollection</span><span class="p">();</span>

        <span class="k">return</span> <span class="k">await</span> <span class="n">db</span><span class="p">.</span><span class="nf">Find</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">Id</span> <span class="p">==</span> <span class="n">id</span><span class="p">).</span><span class="nf">FirstOrDefaultAsync</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">static</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">IResult</span><span class="p">&gt;</span> <span class="nf">CreateOrder</span><span class="p">(</span>
        <span class="n">Order</span> <span class="n">order</span><span class="p">,</span> <span class="n">IMongoClient</span> <span class="n">mongoClient</span><span class="p">,</span> <span class="n">Generator</span> <span class="n">idGenerator</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">order</span> <span class="p">=</span> <span class="n">order</span> <span class="k">with</span>
        <span class="p">{</span>
            <span class="n">Id</span> <span class="p">=</span> <span class="n">idGenerator</span><span class="p">.</span><span class="nf">NextLong</span><span class="p">(),</span>
            <span class="n">CreatedAt</span> <span class="p">=</span> <span class="n">DateTime</span><span class="p">.</span><span class="n">Now</span>
        <span class="p">};</span>

        <span class="kt">var</span> <span class="n">db</span> <span class="p">=</span> <span class="n">mongoClient</span><span class="p">.</span><span class="nf">GetOrderCollection</span><span class="p">();</span>

        <span class="k">await</span> <span class="n">db</span><span class="p">.</span><span class="nf">InsertOneAsync</span><span class="p">(</span><span class="n">order</span><span class="p">);</span>

        <span class="k">return</span> <span class="n">Results</span><span class="p">.</span><span class="nf">CreatedAtRoute</span><span class="p">(</span><span class="k">nameof</span><span class="p">(</span><span class="n">GetOrderById</span><span class="p">),</span> <span class="k">new</span> <span class="p">{</span> <span class="n">id</span> <span class="p">=</span> <span class="n">order</span><span class="p">.</span><span class="n">Id</span> <span class="p">});</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">static</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">Order</span><span class="p">&gt;&gt;</span> <span class="nf">GetOrders</span><span class="p">(</span><span class="n">IMongoClient</span> <span class="n">mongoClient</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">db</span> <span class="p">=</span> <span class="n">mongoClient</span><span class="p">.</span><span class="nf">GetOrderCollection</span><span class="p">();</span>

        <span class="k">return</span> <span class="k">await</span> <span class="n">db</span><span class="p">.</span><span class="nf">Find</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="k">true</span><span class="p">).</span><span class="nf">ToListAsync</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Please see source code for more details: <a href="https://github.com/NikiforovAll/testing-with-newman-demo" target="_blank" rel="noopener noreferrer">https://github.com/NikiforovAll/testing-with-newman-demo</a></p>

<h3 id="writing-requests">Writing requests</h3>

<p>Personally, I‚Äôm a big fan of Postman because it has an intuitive UI that drastically improves your performance. I recommend you invest some time into learning it.</p>

<p>I will keep it straightforward and will show you how to create order in the system and then close it. Before we start sending HTTP requests we want to create ‚ÄúPostman Collection‚Äù and ‚ÄúPostman Environment‚Äù.</p>

<ol>
  <li>See: <a href="https://learning.postman.com/docs/getting-started/creating-the-first-collection/" target="_blank" rel="noopener noreferrer">‚ÄúCreating your first collection‚Äù</a>
    <ol>
      <li>Create ‚Äútesting-with-newman‚Äù collection</li>
      <li>Add folder ‚Äúmain-flow‚Äù</li>
    </ol>
  </li>
  <li>Create environment ‚Äútesting-with-newman‚Äù and add <code class="language-plaintext highlighter-rouge">base-url</code> and <code class="language-plaintext highlighter-rouge">rabbitmq-host</code> variables. Select newly created environment on the top-right.
<img src="/assets/testing-with-newman/postman-env.png" alt="postman-env">
</li>
  <li>Add ‚ÄúCreate Order‚Äù request to the main-flow folder. As you can see, we want to send HTTP POST to <code class="language-plaintext highlighter-rouge">{base-url}/orders</code> with the JSON body. Now, we are ready <a href="https://learning.postman.com/docs/getting-started/sending-the-first-request/" target="_blank" rel="noopener noreferrer">to send</a> the request and see how it works.
<img src="/assets/testing-with-newman/postman-create-order.png" alt="postman-create-order">
</li>
  <li>Start the server <code class="language-plaintext highlighter-rouge">cd ./src/OrderService &amp;&amp; dotnet run</code> and send HTTP request through Postman UI. It looks like the order has been accepted and <a href="https://httpstatuses.com/201" target="_blank" rel="noopener noreferrer">‚Äú201 CREATED‚Äù</a> was returned. You can check the ‚ÄúLocation‚Äù header to see the address of the created resource.<br>
<img src="/assets/testing-with-newman/create-order-response.png" alt="postman-create-order">
</li>
  <li>Once we are comfortable with Postman and ‚ÄúOrder Service‚Äù we can start writing ‚ÄúPostman Tests‚Äù to verify expected behavior. Tests are written based on JavaScript. Postman UI helps you to write tests by providing tons of examples, see the right sidebar. Down below, we make sure that the order request return status is 201 and the customer field contains ‚ÄúJohn Doe‚Äù. As you can see, we also writing ‚ÄúorderId‚Äù into the environment variable to use it in the next requests.</li>
</ol>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">pm</span><span class="p">.</span><span class="nf">test</span><span class="p">(</span><span class="dl">"</span><span class="s2">Status code is 201</span><span class="dl">"</span><span class="p">,</span> <span class="nf">function </span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">pm</span><span class="p">.</span><span class="nx">response</span><span class="p">.</span><span class="nx">to</span><span class="p">.</span><span class="nx">have</span><span class="p">.</span><span class="nf">status</span><span class="p">(</span><span class="mi">201</span><span class="p">);</span>
<span class="p">});</span>

<span class="nx">pm</span><span class="p">.</span><span class="nf">sendRequest</span><span class="p">(</span><span class="nx">pm</span><span class="p">.</span><span class="nx">response</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="dl">"</span><span class="s2">Location</span><span class="dl">"</span><span class="p">),</span> <span class="nf">function </span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">pm</span><span class="p">.</span><span class="nf">test</span><span class="p">(</span><span class="dl">"</span><span class="s2">Order created</span><span class="dl">"</span><span class="p">,</span> <span class="nf">function </span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">pm</span><span class="p">.</span><span class="nf">expect</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">code</span><span class="p">).</span><span class="nx">to</span><span class="p">.</span><span class="nf">eql</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>
        <span class="nx">pm</span><span class="p">.</span><span class="nx">environment</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="dl">"</span><span class="s2">orderId</span><span class="dl">"</span><span class="p">,</span> <span class="nx">res</span><span class="p">.</span><span class="nf">json</span><span class="p">().</span><span class="nx">id</span><span class="p">);</span>
        <span class="nx">pm</span><span class="p">.</span><span class="nf">test</span><span class="p">(</span><span class="dl">"</span><span class="s2">Order has customer</span><span class="dl">"</span><span class="p">,</span> <span class="nf">function </span><span class="p">()</span> <span class="p">{</span>
            <span class="nx">pm</span><span class="p">.</span><span class="nf">expect</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nf">json</span><span class="p">().</span><span class="nx">customer</span><span class="p">).</span><span class="nx">to</span><span class="p">.</span><span class="nf">eql</span><span class="p">(</span><span class="dl">'</span><span class="s1">John Doe</span><span class="dl">'</span><span class="p">);</span>
        <span class="p">});</span>
    <span class="p">});</span>
<span class="p">});</span>
</code></pre></div></div>

<h3 id="writing-requests-publish-to-rabbitmq">Writing requests. Publish to RabbitMQ</h3>

<p>Also, you can publish messages to RabbitMQ from Postman. It is possible because RabbitMQ exposes HTTP client that enables management. To publish a message, you need to specify an exchange in the URL  <code class="language-plaintext highlighter-rouge">{rabbitmq-host}/api/exchanges/%2F/amq.default/publish</code> and provide the message as part of JSON body. Note <em>%2F</em> is the url-encoded default Virtual Host ‚Äú/‚Äù.</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="nl">"properties"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"content_type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"application/json"</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nl">"routing_key"</span><span class="p">:</span><span class="w"> </span><span class="s2">"order-paid"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"payload"</span><span class="p">:</span><span class="w"> </span><span class="s2">"{</span><span class="se">\"</span><span class="s2">orderId</span><span class="se">\"</span><span class="s2">: </span><span class="se">\"</span><span class="s2">244165178826752</span><span class="se">\"</span><span class="s2">}"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"payload_encoding"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>Because publishing a message it is by nature async operation. All we can do at this point is to verify that it was <em>routed</em> (stored in a queue).</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">pm</span><span class="p">.</span><span class="nf">test</span><span class="p">(</span><span class="dl">"</span><span class="s2">Is Routed</span><span class="dl">"</span><span class="p">,</span> <span class="nf">function </span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">jsonData</span> <span class="o">=</span> <span class="nx">pm</span><span class="p">.</span><span class="nx">response</span><span class="p">.</span><span class="nf">json</span><span class="p">();</span>
    <span class="nx">pm</span><span class="p">.</span><span class="nf">expect</span><span class="p">(</span><span class="nx">jsonData</span><span class="p">.</span><span class="nx">routed</span><span class="p">).</span><span class="nx">to</span><span class="p">.</span><span class="nf">eql</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></div></div>

<p>Finally, we want to see that the order has been completed as the result of the previous operation, we do it by sending <code class="language-plaintext highlighter-rouge">GET {base-url}/orders/{orderId}</code> and running the tests:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">pm</span><span class="p">.</span><span class="nf">test</span><span class="p">(</span><span class="dl">"</span><span class="s2">Status code is 200</span><span class="dl">"</span><span class="p">,</span> <span class="nf">function </span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">pm</span><span class="p">.</span><span class="nx">response</span><span class="p">.</span><span class="nx">to</span><span class="p">.</span><span class="nx">have</span><span class="p">.</span><span class="nf">status</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>
<span class="p">});</span>

<span class="nx">pm</span><span class="p">.</span><span class="nf">test</span><span class="p">(</span><span class="dl">"</span><span class="s2">Order is Completed</span><span class="dl">"</span><span class="p">,</span> <span class="nf">function </span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">pm</span><span class="p">.</span><span class="nf">expect</span><span class="p">(</span><span class="nx">pm</span><span class="p">.</span><span class="nx">response</span><span class="p">.</span><span class="nf">json</span><span class="p">().</span><span class="nx">status</span><span class="p">).</span><span class="nx">to</span><span class="p">.</span><span class="nf">eql</span><span class="p">(</span><span class="dl">"</span><span class="s2">Completed</span><span class="dl">"</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></div></div>

<p>That was ‚Äúmain-flow‚Äù. I suggest you check ‚Äúcancel-flow‚Äù on your own. Let‚Äôs see how to run Postman collections from CLI.</p>

<h2 id="running-postman-collections-from-cli-via-newman">Running Postman Collections from CLI via <code class="language-plaintext highlighter-rouge">newman</code>
</h2>

<p>You can export collections and environments from Postman UI and use exported files locally. We are going to set up collection run inside <code class="language-plaintext highlighter-rouge">docker-compose</code></p>

<p>Running postman collections inside Docker has many benefits:</p>

<ul>
  <li>Easy to write integration tests. Testing allows you to investigate how the system works. Huge productivity boost. Try it and you will like it.</li>
  <li>Short feedback cycle. You can use it during your inner developer-loop.</li>
  <li>Integration testing could be outsourced to a different team/people.</li>
</ul>

<p>Here is <code class="language-plaintext highlighter-rouge">docker-compose.postman.yml</code>:</p>

<div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">version</span><span class="pi">:</span> <span class="s2">"</span><span class="s">3.4"</span>

<span class="na">services</span><span class="pi">:</span>
  <span class="na">main-flow</span><span class="pi">:</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">postman/newman_alpine33</span>
    <span class="na">command</span><span class="pi">:</span>
      <span class="s">run testing-with-newman.postman_collection.json</span>
      <span class="s">--environment testing-with-newman.postman_environment.json</span>
      <span class="s">--folder main-flow</span>
      <span class="s">-r cli</span>
      <span class="s">--delay-request </span><span class="m">500</span>
      <span class="s">--iteration-count </span><span class="m">1</span>
      <span class="s">--color on</span>
    <span class="na">volumes</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">./tests/postman:/etc/newman</span>
    <span class="na">networks</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">newman-tests</span>
  <span class="na">cancel-flow</span><span class="pi">:</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">postman/newman_alpine33</span>
    <span class="na">command</span><span class="pi">:</span>
      <span class="s">run testing-with-newman.postman_collection.json</span>
      <span class="s">--environment testing-with-newman.postman_environment.json</span>
      <span class="s">--folder cancel-flow</span>
      <span class="s">-r cli</span>
      <span class="s">--iteration-count </span><span class="m">1</span>
      <span class="s">--color on</span>
    <span class="na">volumes</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">./tests/postman:/etc/newman</span>
    <span class="na">networks</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">newman-tests</span>

<span class="na">networks</span><span class="pi">:</span>
  <span class="na">newman-tests</span><span class="pi">:</span>
    <span class="na">external</span><span class="pi">:</span> <span class="kc">true</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">newman-tests</span>

</code></pre></div></div>

<p>To run an e2e scenarios - execute</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker compose <span class="nt">-f</span> docker-compose.postman.yml up main-flow
docker compose <span class="nt">-f</span> docker-compose.postman.yml up cancel-flow
</code></pre></div></div>

<p><img src="/assets/testing-with-newman/main-flow-run-demo.png" alt="main-flow-run-demo">
<img src="/assets/testing-with-newman/cancel-flow-run-demo.png" alt="cancel-flow-run-demo"></p>

<h3 id="running-newman-as-part-of-the-continuous-integration-process-github-actions-example">Running newman as part of the continuous integration process. GitHub Actions example</h3>

<p>One of the greatest benefits of <code class="language-plaintext highlighter-rouge">newman</code> is that you can use it as part of your CI.</p>

<div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">name</span><span class="pi">:</span> <span class="s">tests</span>
<span class="na">on</span><span class="pi">:</span>
  <span class="na">push</span><span class="pi">:</span>

<span class="na">jobs</span><span class="pi">:</span>
  <span class="na">build</span><span class="pi">:</span>
    <span class="na">runs-on</span><span class="pi">:</span> <span class="s">ubuntu-latest</span>
    <span class="na">steps</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">uses</span><span class="pi">:</span> <span class="s">actions/checkout@v2</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Setup network</span>
        <span class="na">run</span><span class="pi">:</span> <span class="s">docker network create newman-tests</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Build the docker-compose stack</span>
        <span class="na">run</span><span class="pi">:</span> <span class="s">docker-compose -f docker-compose.override.yml -f docker-compose.yml up -d</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Check running containers</span>
        <span class="na">run</span><span class="pi">:</span> <span class="s">docker ps -a</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Check logs</span>
        <span class="na">run</span><span class="pi">:</span> <span class="s">docker-compose logs order-service</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Run test suite main-flow</span>
        <span class="na">run</span><span class="pi">:</span> <span class="s">docker-compose -f docker-compose.postman.yml up main-flow</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Run test suite cancel-flow</span>
        <span class="na">run</span><span class="pi">:</span> <span class="s">docker-compose -f docker-compose.postman.yml up cancel-flow</span>
</code></pre></div></div>

<p>üí° Hint: to run github actions locally use <a href="https://github.com/nektos/act" target="_blank" rel="noopener noreferrer">https://github.com/nektos/act</a></p>

<p><img src="/assets/testing-with-newman/github-testing-with-newman.png" alt="github-action"></p>

<hr>

<h2 id="summary">Summary</h2>

<p>Writing tests is what makes a good developer an excellent developer. In this blog post, we‚Äôve covered how to set up integration tests as runnable postman collections inside Docker.</p>

<h3 id="reference">Reference</h3>

<ul>
  <li><a href="https://www.postman.com/automated-testing/" target="_blank" rel="noopener noreferrer">https://www.postman.com/automated-testing/</a></li>
  <li><a href="https://www.sm-cloud.com/testing-api-with-postman/" target="_blank" rel="noopener noreferrer">https://www.sm-cloud.com/testing-api-with-postman/</a></li>
  <li><a href="https://github.com/nektos/act" target="_blank" rel="noopener noreferrer">https://github.com/nektos/act</a></li>
</ul>

	</div>

	

	
	<ul class="tag_box list-unstyled list-inline">
		<li><i class="fa fa-folder-open"></i></li>
		
		
		
		<li><a href="https://nikiforovall.github.io/categories.html#dotnet-ref" target="_blank" rel="noopener noreferrer">
				dotnet <span>(40)</span>
				,
			</a></li>
		
		<li><a href="https://nikiforovall.github.io/categories.html#docker-ref" target="_blank" rel="noopener noreferrer">
				docker <span>(3)</span>
				,
			</a></li>
		
		<li><a href="https://nikiforovall.github.io/categories.html#testing-ref" target="_blank" rel="noopener noreferrer">
				testing <span>(1)</span>
				
			</a></li>
		
		
	</ul>
	

	
	<ul class="list-inline">
		<li><i class="fa fa-tags"></i></li>
		
		
		
		<li>
			<a href="https://nikiforovall.github.io/tags.html#dotnet-ref" target="_blank" rel="noopener noreferrer">
				dotnet <span>(46)</span>
				,
			</a>
		</li>
		
		<li>
			<a href="https://nikiforovall.github.io/tags.html#docker-ref" target="_blank" rel="noopener noreferrer">
				docker <span>(4)</span>
				,
			</a>
		</li>
		
		<li>
			<a href="https://nikiforovall.github.io/tags.html#testing-ref" target="_blank" rel="noopener noreferrer">
				testing <span>(1)</span>
				,
			</a>
		</li>
		
		<li>
			<a href="https://nikiforovall.github.io/tags.html#postman-ref" target="_blank" rel="noopener noreferrer">
				postman <span>(1)</span>
				,
			</a>
		</li>
		
		<li>
			<a href="https://nikiforovall.github.io/tags.html#cli-ref" target="_blank" rel="noopener noreferrer">
				cli <span>(7)</span>
				
			</a>
		</li>
		
		
		
	</ul>
	

	<hr>

	<div>
		<section class="share col-sm-6">
			<h4 class="section-title">Share Post</h4>
			<a class="btn btn-default btn-sm twitter" href="http://twitter.com/share?&amp;via=nikiforovall" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;" target="_blank" rel="noopener noreferrer">
				<i class="fa fa-twitter fa-lg"></i>
				Twitter
			</a>
		</section>

		<section class="col-sm-6 author">
			<img src="//www.gravatar.com/avatar/e86fa0938976c38907a302ecb208f011" class="img-rounded author-image">
			<h4 class="section-title author-name">Oleksii Nikiforov</h4>
			<p class="author-bio">Jibber-jabbering about programming and IT.</p>
		</section>
	</div>

	<div class="clearfix"></div>

	<ul class="pager">
		
		<li class="previous"><a href="https://nikiforovall.github.io/dotnet/microservices/csharp/2021/11/06/rapid-microservices-development-part1-build-project.html" title="Rapid Microservices Development in .NET. An introduction." target="_blank" rel="noopener noreferrer">‚Üê
				Previous</a></li>
		
		
		<li class="next">
<a href="https://nikiforovall.github.io/dotnet/2021/12/20/dotnet-global-tool-copy-paster.html" title="Use System.CommandLine to write .NET global tools. Copy-paste-driven development with copy-paster." target="_blank" rel="noopener noreferrer">Next ‚Üí</a>
		</li>
		
	</ul>

	<hr>
	</div>

	<div class="col-sm-2 sidebar-2">

	</div>

</article>
<div class="clearfix"></div>



    
    <script src="https://utteranc.es/client.js" repo="NikiforovAll/nikiforovall.github.io" issue-term="pathname" label="Blog" theme="preferred-color-scheme" crossorigin="anonymous" async>
    </script>





		<footer>
			<hr>
			<p>
				¬© 2024 Oleksii Nikiforov with <a href="http://jekyllrb.com/" target="_blank" rel="noopener noreferrer">Jekyll</a>. Theme: <a href="https://github.com/dbtek/dbyll" target="_blank" rel="noopener noreferrer">dbyll</a> by dbtek.
			</p>
		</footer>
	</div>

	<script type="text/javascript" src="https://nikiforovall.github.io/assets/resources/jquery/jquery.min.js"></script>
	<script type="text/javascript" src="https://nikiforovall.github.io/assets/resources/bootstrap/js/bootstrap.min.js"></script>
	<script type="text/javascript" src="https://nikiforovall.github.io/assets/js/app.js"></script>
	
</body>
</html>



<!-- Asynchronous Google Analytics snippet -->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-164555539-1', 'auto');
  ga('send', 'pageview');
</script>

