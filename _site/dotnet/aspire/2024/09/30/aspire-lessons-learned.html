<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<!-- <meta http-equiv="Content-Security-Policy" content="frame-src https://try.dot.net;"> -->
	<title>10 Lessons I Learned from Using Aspire in Production</title>
	
	<meta name="author" content="Oleksii Nikiforov">

	<!-- Enable responsive viewport -->
	<meta name="viewport" content="width=device-width, initial-scale=1.0">

	<!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
	<!--[if lt IE 9]>
	<script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
	<![endif]-->

	<!-- Le styles -->
	<link href="https://nikiforovall.github.io/assets/resources/bootstrap/css/bootstrap.min.css" rel="stylesheet">
	<link href="https://nikiforovall.github.io/assets/resources/font-awesome/css/font-awesome.min.css" rel="stylesheet">
	<link href="https://nikiforovall.github.io/assets/resources/syntax/syntax.css" rel="stylesheet">
	<link href="https://nikiforovall.github.io/assets/css/style.css" rel="stylesheet">

	<!-- Le fav and touch icons -->
	<!-- Update these with your own images
	<link rel="shortcut icon" href="images/favicon.ico">
	<link rel="apple-touch-icon" href="images/apple-touch-icon.png">
	<link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
	<link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
	-->
	<link rel="shortcut icon" href="/assets/media/favicon.ico">

	<link rel="alternate" type="application/rss+xml" title="" href="https://nikiforovall.github.io/feed.xml">
</head>

<body>
	<nav class="navbar navbar-default visible-xs" role="navigation">
		<!-- Brand and toggle get grouped for better mobile display -->
		<div class="navbar-header">
			<button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
				<span class="sr-only">Toggle navigation</span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</button>
			
			<a type="button" class="navbar-toggle nav-link" href="http://github.com/nikiforovAll" target="_blank" rel="noopener noreferrer">
				<i class="fa fa-github"></i>
			</a>
			
			
			<a type="button" class="navbar-toggle nav-link" href="http://twitter.com/nikiforovall" target="_blank" rel="noopener noreferrer">
				<i class="fa fa-twitter"></i>
			</a>
			
			
			<a type="button" class="navbar-toggle nav-link" href="mailto:alexey.nikiforovall@gmail.com">
				<i class="fa fa-envelope"></i>
			</a>
			
			<a class="navbar-brand" href="https://nikiforovall.github.io/" target="_blank" rel="noopener noreferrer">
				<img src="//www.gravatar.com/avatar/e86fa0938976c38907a302ecb208f011?s=35" class="img-circle">
				N+1 Blog
			</a>
		</div>

		<!-- Collect the nav links, forms, and other content for toggling -->
		<div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
			<ul class="nav navbar-nav">
				<li class="active"><a href="https://nikiforovall.github.io/" target="_blank" rel="noopener noreferrer">Home</a></li>
				<li><a href="https://nikiforovall.github.io/categories.html" target="_blank" rel="noopener noreferrer">Categories</a></li>
				<li><a href="https://nikiforovall.github.io/tags.html" target="_blank" rel="noopener noreferrer">Tags</a></li>
				<li><a href="https://nikiforovall.github.io/about.html" target="_blank" rel="noopener noreferrer">About</a></li>
			</ul>
		</div>
<!-- /.navbar-collapse -->
	</nav>

	<!-- nav-menu-dropdown -->
	<div class="btn-group hidden-xs" id="nav-menu">
		<button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">
			<i class="fa fa-bars"></i>
		</button>
		<ul class="dropdown-menu" role="menu">
			<li><a href="https://nikiforovall.github.io/" target="_blank" rel="noopener noreferrer"><i class="fa fa-home"></i>Home</a></li>
			<li><a href="https://nikiforovall.github.io/categories.html" target="_blank" rel="noopener noreferrer"><i class="fa fa-folder"></i>Categories</a></li>
			<li><a href="https://nikiforovall.github.io/tags.html" target="_blank" rel="noopener noreferrer"><i class="fa fa-tags"></i>Tags</a></li>
			<li><a href="https://nikiforovall.github.io/about.html" target="_blank" rel="noopener noreferrer"><i class="fa fa-pencil"></i>About</a></li>
			<li class="divider">
			<li><a href="#"><i class="fa fa-arrow-up"></i>Top of Page</a></li>
		</ul>
	</div>

	<div class="col-sm-3 sidebar hidden-xs" style="">
		<!-- sidebar.html -->
<header class="sidebar-header" role="banner">
	<a href="https://nikiforovall.github.io/" target="_blank" rel="noopener noreferrer">
		<img src="//www.gravatar.com/avatar/e86fa0938976c38907a302ecb208f011?s=150" class="img-circle">
	</a>
	<h3 class="title">
        <a href="https://nikiforovall.github.io/" target="_blank" rel="noopener noreferrer">N+1 Blog</a>
    </h3>
</header>


<div id="bio" class="text-center">
	Jibber-jabbering about programming and IT.
</div>


<div id="contact-list" class="text-center">
	<ul class="list-unstyled list-inline">
		
		<li>
			<a class="btn btn-default btn-sm" href="https://github.com/nikiforovAll" target="_blank" rel="noopener noreferrer">
				<i class="fa fa-github-alt fa-lg"></i>
			</a>
		</li>
		
		
		<li>
			<a class="btn btn-default btn-sm" href="https://twitter.com/nikiforovall" target="_blank" rel="noopener noreferrer">
				<i class="fa fa-twitter fa-lg"></i>
			</a>
		</li>
		
		
		<li>
			<a class="btn btn-default btn-sm" href="https://t.me/nikiforovallblog" target="_blank" rel="noopener noreferrer">
				<i class="fa fa-pencil-square fa-lg"></i>
			</a>
		</li>
		
		
		<li>
			<a class="btn btn-default btn-sm" href="mailto:alexey.nikiforovall@gmail.com">
				<i class="fa fa-envelope fa-lg"></i>
			</a>
		</li>
		
	</ul>
	<ul id="contact-list-secondary" class="list-unstyled list-inline">
		
		
		<li>
			<a class="btn btn-default btn-sm" href="https://linkedin.com/in/nikiforov-oleksii" target="_blank" rel="noopener noreferrer">
				<i class="fa fa-linkedin fa-lg"></i>
			</a>
		</li>
		
		<li>
			<a class="btn btn-default btn-sm" href="https://nikiforovall.github.io/feed.xml" target="_blank" rel="noopener noreferrer">
				<i class="fa fa-rss fa-lg"></i>
			</a>
		</li>
	</ul>
</div>
<!-- sidebar.html end -->

	</div>

	<div class="col-sm-9 col-sm-offset-3">
		<div class="page-header">
	<h1>10 Lessons I Learned from Using Aspire in Production </h1>
</div>
<article>

	<div class="col-sm-10">

		<span class="post-date">
			
			September
			30th,
			
			2024
		</span>

	
	
	
	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	
	

	<div class="article_body" style="margin-top: 30px;">
		<h2 id="tldr">TL;DR</h2>

<p>I have been using .NET Aspire for a while now and have learned a lot along the way. In this blog post, I will share some of the lessons I have learned from using .NET Aspire in production.</p>

<blockquote>
  <p>.NET Aspire version: <strong>8.2.1</strong></p>
</blockquote>

<center>
  <img src="/assets/aspire-lessons-learned/aspire-brand.png" style="margin: 15px;" width="40%">
</center>

<ul>
  <li><a href="#tldr">TL;DR</a></li>
  <li><a href="#case-study">Case Study</a></li>
  <li><a href="#lesson-1-adding-aspire-is-quite-straightforward-and-incremental">Lesson 1. Adding Aspire is quite straightforward and incremental</a></li>
  <li><a href="#lesson-2-be-ready-to-write-custom-integrations">Lesson 2. Be ready to write custom integrations</a></li>
  <li><a href="#lesson-3-aspire-workload-should-be-installed-every-time-you-run-the-cicd-pipeline">Lesson 3. Aspire workload should be installed every time you run the CI/CD pipeline</a></li>
  <li><a href="#lesson-4-managing-startup-dependencies-is-a-must-have">Lesson 4. Managing Startup Dependencies is a must have</a></li>
  <li><a href="#lesson-5-aspire-project-can-take-some-time-to-boot-up">Lesson 5. Aspire project can take some time to boot up</a></li>
  <li><a href="#lesson-6-it-can-be-challenging-to-run-things-without-aspire">Lesson 6. It can be challenging to run things without Aspire</a></li>
  <li><a href="#lesson-7-there-is-no-easy-way-to-run-a-partial-setup">Lesson 7. There is no easy way to run a partial setup</a></li>
  <li><a href="#lesson-8-using-podman-instead-of-docker-can-be-troublesome">Lesson 8. Using Podman instead of Docker can be troublesome</a></li>
  <li><a href="#lesson-9-aspire-client-integrations-require-ihostapplicationbuilder">Lesson 9. Aspire client integrations require IHostApplicationBuilder</a></li>
  <li><a href="#lesson-10-learn-by-example">Lesson 10. Learn by example</a></li>
  <li><a href="#conclusion">Conclusion</a></li>
</ul>

<h2 id="case-study">Case Study</h2>

<p>Assume we have a project, it is a <strong>web application</strong> with advanced enterprise search capabilities, utilizing <code class="language-plaintext highlighter-rouge">Elasticsearch</code> for data querying. It features a <strong>background jobs</strong> for scraping and processing data from various sources, storing structured data in <code class="language-plaintext highlighter-rouge">PostgreSQL</code> and files in <code class="language-plaintext highlighter-rouge">Azure Blob Storage</code>. Additionally, we have a <strong>CLI</strong> tool for essential administrative tasks such as reindexing and database migrations, ensuring system maintenance and automation.</p>

<center>
<div class="mermaid">
graph LR;
    subgraph BS [Backing Services]
        B[Elasticsearch]
        C[PostgreSQL]
        D[Azure Blob Storage]
    end
    A[Web App] --&gt; B[Elasticsearch]
    E[Jobs] --&gt; B
    E --&gt; C[PostgreSQL]
    E --&gt; D[Blob Storage]
    F[CLI] --&gt; B
    F --&gt; C
    F --&gt; D
</div>
</center>

<hr>

<p>🎯 Our objective was to improve the developer experience by integrating <strong>.NET Aspire</strong>. We aimed to create a seamless so called <em>F5</em> setup for every team member.</p>

<p>💡 An “F5 setup” refers to a development environment configuration where a developer can simply press the F5 key (commonly used to start debugging in many IDEs, including Visual Studio) to run the application. This setup aims to streamline the development process by ensuring that all necessary services, dependencies, and configurations are automatically handled, allowing developers to focus on coding without worrying about manual setup or configuration.</p>

<ul>
  <li>For existing developers, this means more efficient development and debugging workflows.</li>
  <li>For new developers, this means they can start working on the project without the hassle of manually configuring and setting up the underlying infrastructure. This approach ensures a smoother onboarding process and a more efficient development workflow.</li>
</ul>

<p>Furthermore, <code class="language-plaintext highlighter-rouge">AppHost</code> serves as a composition root of the solution. If done correctly, you can reason what this solution is about just by looking at it.</p>

<hr>

<p>🚀 Down below, I will share some of the lessons learned from this experience. Let’s dive in!</p>

<h2 id="lesson-1-adding-aspire-is-quite-straightforward-and-incremental">Lesson 1. Adding Aspire is quite straightforward and incremental</h2>

<p>It turns out that transitioning your entire project to Aspire doesn’t have to be an all-or-nothing endeavor. You can begin by adding the <code class="language-plaintext highlighter-rouge">AppHost</code> and progressively migrate your backing services at your own pace.</p>

<p>For example, if you already have <code class="language-plaintext highlighter-rouge">Elasticsearch</code> configured in a non-Aspire way, you don’t have to use the official Aspire <code class="language-plaintext highlighter-rouge">Elasticsearch</code> <strong>client</strong> integration. You can just use the <strong>hosting</strong> integration and write adapter code to bridge the gap between Aspire and your existing code. My suggestion is to make these changes to <code class="language-plaintext highlighter-rouge">AppHost</code> to limit the amount of changes and avoid altering existing working code.</p>

<p>💡 Additionally, we didn’t really want to change the way we configure and manage cross-cutting concerns, so we abandoned the idea of using <code class="language-plaintext highlighter-rouge">ServiceDefaults</code> altogether.We simply added an OpenTelemetry integration to enable logs, traces, and metrics in the Aspire Dashboard.</p>

<p>🗒️ References:</p>

<ul>
  <li><a href="https://learn.microsoft.com/en-us/dotnet/aspire/get-started/add-aspire-existing-app?tabs=unix&amp;pivots=dotnet-cli" target="_blank" rel="noopener noreferrer">Tutorial: Add .NET Aspire to an existing .NET app</a></li>
</ul>

<h2 id="lesson-2-be-ready-to-write-custom-integrations">Lesson 2. Be ready to write custom integrations</h2>

<p>We adopted Aspire at an early stage, and during our migration to Aspire, there was no official integration for <code class="language-plaintext highlighter-rouge">Elasticsearch</code>. Consequently, we developed a custom integration to configure <code class="language-plaintext highlighter-rouge">Elasticsearch</code> with Aspire by creating a custom <code class="language-plaintext highlighter-rouge">ElasticsearchResource</code>.</p>

<p>Custom hosting integrations often depend on an existing Dockerfile or Docker image. Therefore, creating one involves using <code class="language-plaintext highlighter-rouge">IDistributedApplicationBuilder</code> to define the Docker equivalents.</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">static</span> <span class="n">IResourceBuilder</span><span class="p">&lt;</span><span class="n">ElasticsearchResource</span><span class="p">&gt;</span> <span class="nf">AddElasticsearch</span><span class="p">(</span>
    <span class="k">this</span> <span class="n">IDistributedApplicationBuilder</span> <span class="n">builder</span><span class="p">,</span>
    <span class="kt">string</span> <span class="n">name</span><span class="p">,</span>
    <span class="n">IResourceBuilder</span><span class="p">&lt;</span><span class="n">ParameterResource</span><span class="p">&gt;?</span> <span class="n">password</span> <span class="p">=</span> <span class="k">null</span><span class="p">,</span>
    <span class="kt">int</span><span class="p">?</span> <span class="n">port</span> <span class="p">=</span> <span class="k">null</span><span class="p">,</span>
    <span class="kt">int</span><span class="p">?</span> <span class="n">internalPort</span> <span class="p">=</span> <span class="k">null</span>
<span class="p">)</span>
<span class="p">{</span>
    <span class="n">ArgumentNullException</span><span class="p">.</span><span class="nf">ThrowIfNull</span><span class="p">(</span><span class="n">builder</span><span class="p">);</span>

    <span class="kt">var</span> <span class="n">passwordParameter</span> <span class="p">=</span>
        <span class="n">password</span><span class="p">?.</span><span class="n">Resource</span>
        <span class="p">??</span> <span class="n">ParameterResourceBuilderExtensions</span><span class="p">.</span><span class="nf">CreateDefaultPasswordParameter</span><span class="p">(</span>
            <span class="n">builder</span><span class="p">,</span>
            <span class="s">$"</span><span class="p">{</span><span class="n">name</span><span class="p">}</span><span class="s">-password"</span>
        <span class="p">);</span>

    <span class="kt">var</span> <span class="n">elasticsearch</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">ElasticsearchResource</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">passwordParameter</span><span class="p">);</span>

    <span class="k">return</span> <span class="n">builder</span>
        <span class="p">.</span><span class="nf">AddResource</span><span class="p">(</span><span class="n">elasticsearch</span><span class="p">)</span>
        <span class="p">.</span><span class="nf">WithImage</span><span class="p">(</span><span class="n">ElasticsearchContainerImageTags</span><span class="p">.</span><span class="n">Image</span><span class="p">,</span> <span class="n">ElasticsearchContainerImageTags</span><span class="p">.</span><span class="n">Tag</span><span class="p">)</span>
        <span class="p">.</span><span class="nf">WithImageRegistry</span><span class="p">(</span><span class="n">ElasticsearchContainerImageTags</span><span class="p">.</span><span class="n">Registry</span><span class="p">)</span>
        <span class="p">.</span><span class="nf">WithHttpEndpoint</span><span class="p">(</span>
            <span class="n">targetPort</span><span class="p">:</span> <span class="n">ElasticsearchPort</span><span class="p">,</span>
            <span class="n">port</span><span class="p">:</span> <span class="n">port</span><span class="p">,</span>
            <span class="n">name</span><span class="p">:</span> <span class="n">ElasticsearchResource</span><span class="p">.</span><span class="n">PrimaryEndpointName</span>
        <span class="p">)</span>
        <span class="p">.</span><span class="nf">WithEndpoint</span><span class="p">(</span>
            <span class="n">targetPort</span><span class="p">:</span> <span class="n">ElasticsearchInternalPort</span><span class="p">,</span>
            <span class="n">port</span><span class="p">:</span> <span class="n">internalPort</span><span class="p">,</span>
            <span class="n">name</span><span class="p">:</span> <span class="n">ElasticsearchResource</span><span class="p">.</span><span class="n">InternalEndpointName</span>
        <span class="p">)</span>
        <span class="p">.</span><span class="nf">WithEnvironment</span><span class="p">(</span><span class="s">"discovery.type"</span><span class="p">,</span> <span class="s">"single-node"</span><span class="p">)</span>
        <span class="p">.</span><span class="nf">WithEnvironment</span><span class="p">(</span><span class="s">"xpack.security.http.ssl.enabled"</span><span class="p">,</span> <span class="s">"false"</span><span class="p">)</span>
        <span class="p">.</span><span class="nf">WithEnvironment</span><span class="p">(</span><span class="s">"xpack.security.enabled"</span><span class="p">,</span> <span class="s">"true"</span><span class="p">)</span>
        <span class="p">.</span><span class="nf">WithEnvironment</span><span class="p">(</span><span class="s">"ELASTIC_PASSWORD"</span><span class="p">,</span> <span class="n">elasticsearch</span><span class="p">.</span><span class="n">PasswordParameter</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>As you can see above, we created a custom <code class="language-plaintext highlighter-rouge">AddElasticsearch</code> extension method to configure <code class="language-plaintext highlighter-rouge">Elasticsearch</code> with Aspire. This method adds an <code class="language-plaintext highlighter-rouge">ElasticsearchResource</code> to the <code class="language-plaintext highlighter-rouge">IDistributedApplicationBuilder</code> and configures the necessary settings for the <code class="language-plaintext highlighter-rouge">Elasticsearch</code> Docker container.</p>

<p>It is a good idea to put separate custom integrations in a separate project to keep the codebase clean and organized. This approach also makes it easier to manage and maintain custom integrations as your project grows.</p>

<p>💡To gracefully migrate to Aspire and limit the amount of changes, we employed a previously mentioned technique (Lesson 1). I call this approach <strong>hosting integration adapter method</strong>.</p>

<p>You can provide an overload of <code class="language-plaintext highlighter-rouge">WithReference</code> to configure a custom integration in an opinionated way.</p>

<p>For example, here is how to provide a connection string and environment variables simultaneously:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">static</span> <span class="n">IResourceBuilder</span><span class="p">&lt;</span><span class="n">TDestination</span><span class="p">&gt;</span> <span class="n">WithReference</span><span class="p">&lt;</span><span class="n">TDestination</span><span class="p">&gt;(</span>
    <span class="k">this</span> <span class="n">IResourceBuilder</span><span class="p">&lt;</span><span class="n">TDestination</span><span class="p">&gt;</span> <span class="n">builder</span><span class="p">,</span>
    <span class="n">IResourceBuilder</span><span class="p">&lt;</span><span class="n">ElasticsearchResource</span><span class="p">&gt;</span> <span class="n">source</span>
<span class="p">)</span>
    <span class="k">where</span> <span class="n">TDestination</span> <span class="p">:</span> <span class="n">IResourceWithEnvironment</span>
<span class="p">{</span>
    <span class="n">ArgumentNullException</span><span class="p">.</span><span class="nf">ThrowIfNull</span><span class="p">(</span><span class="n">source</span><span class="p">);</span>
    
    <span class="kt">var</span> <span class="n">resource</span> <span class="p">=</span> <span class="n">source</span><span class="p">.</span><span class="n">Resource</span><span class="p">;</span>
    <span class="k">const</span> <span class="kt">string</span> <span class="n">Prefix</span> <span class="p">=</span> <span class="s">"Elastic"</span><span class="p">;</span>

    <span class="c1">// Add connection string as is (Aspire-way)</span>
    <span class="n">IResourceBuilder</span><span class="p">&lt;</span><span class="n">IResourceWithConnectionString</span><span class="p">&gt;</span> <span class="n">connectionSTringResource</span> <span class="p">=</span> <span class="n">source</span><span class="p">;</span>
    <span class="n">builder</span><span class="p">.</span><span class="nf">WithReference</span><span class="p">(</span><span class="n">connectionSTringResource</span><span class="p">);</span>

    <span class="c1">// Adapter code (Custom-way)</span>
    <span class="n">builder</span><span class="p">.</span><span class="nf">WithEnvironment</span><span class="p">(</span><span class="s">$"</span><span class="p">{</span><span class="n">Prefix</span><span class="p">}</span><span class="s">__Url"</span><span class="p">,</span> <span class="n">resource</span><span class="p">.</span><span class="n">PrimaryEndpoint</span><span class="p">);</span>
    <span class="n">builder</span><span class="p">.</span><span class="nf">WithEnvironment</span><span class="p">(</span><span class="s">$"</span><span class="p">{</span><span class="n">Prefix</span><span class="p">}</span><span class="s">__Login"</span><span class="p">,</span> <span class="n">ElasticsearchResource</span><span class="p">.</span><span class="n">UserName</span><span class="p">);</span>
    <span class="n">builder</span><span class="p">.</span><span class="nf">WithEnvironment</span><span class="p">(</span><span class="s">$"</span><span class="p">{</span><span class="n">Prefix</span><span class="p">}</span><span class="s">__Password"</span><span class="p">,</span> <span class="n">resource</span><span class="p">.</span><span class="n">PasswordParameter</span><span class="p">.</span><span class="n">Value</span><span class="p">);</span>

    <span class="k">return</span> <span class="n">builder</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The benefit of this approach is that you can just conform to an existing way you configure your services and minimize the changes.</p>

<p>💡 Often, managing backing services requires additional tools such as <strong>pgAdmin</strong> for PostgreSQL, <strong>Kibana</strong> for Elasticsearch, or <strong>Azure Storage Explorer</strong> for Azure Blob Storage. A growing <em>pattern</em> is to add tooling support for hosting integrations using <code class="language-plaintext highlighter-rouge">With{ToolName}</code>. Here is an example:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">static</span> <span class="n">IResourceBuilder</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">WithKibana</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span>
    <span class="k">this</span> <span class="n">IResourceBuilder</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">builder</span><span class="p">,</span>
    <span class="n">Action</span><span class="p">&lt;</span><span class="n">IResourceBuilder</span><span class="p">&lt;</span><span class="n">KibanaContainerResource</span><span class="p">&gt;&gt;?</span> <span class="n">configureContainer</span> <span class="p">=</span> <span class="k">null</span><span class="p">,</span>
    <span class="kt">string</span><span class="p">?</span> <span class="n">containerName</span> <span class="p">=</span> <span class="k">null</span>
<span class="p">)</span>
    <span class="k">where</span> <span class="n">T</span> <span class="p">:</span> <span class="n">ElasticsearchResource</span>
<span class="p">{</span>
  <span class="c1">// implementation goes here</span>
<span class="p">}</span>
</code></pre></div></div>

<p>This approach works well because it is easier to encapsulate two Aspire resources and use them together since their lifecycles are the same. I call this approach <strong>hosting integration tool</strong>.</p>

<p>References:</p>

<ul>
  <li><a href="https://learn.microsoft.com/en-us/dotnet/aspire/fundamentals/integrations-overview" target="_blank" rel="noopener noreferrer">.NET Aspire integrations overview</a></li>
</ul>

<h2 id="lesson-3-aspire-workload-should-be-installed-every-time-you-run-the-cicd-pipeline">Lesson 3. Aspire workload should be installed every time you run the CI/CD pipeline</h2>

<p>Installing the Aspire workload is necessary for it to function, but this can be cumbersome, especially in a CI/CD pipeline. The workload must be installed every time the pipeline runs, which can be time-consuming and tedious.</p>

<p>To address this, we created a separate solution for Aspire AppHost and its dependencies, excluding it from the main solution. This effectively removes the Aspire component from the CI/CD pipeline.</p>

<p>🙌🆕 Luckily, you don’t have to do it in Aspire 9.0. A standalone MSBuild SDK - <code class="language-plaintext highlighter-rouge">Aspire.AppHost.Sdk</code> should be referenced from the <code class="language-plaintext highlighter-rouge">AppHost</code> project.</p>

<p>See the related GitHub issue: <a href="https://github.com/dotnet/aspire/issues/5444" target="_blank" rel="noopener noreferrer">Remove Aspire.Hosting.SDK from the Workload #5444</a></p>

<h2 id="lesson-4-managing-startup-dependencies-is-a-must-have">Lesson 4. Managing Startup Dependencies is a must have</h2>

<p>In real-world applications, managing startup dependencies is crucial. For instance, you may need to ensure that a database is up and running before starting a migration CLI tool. Once the migration is complete, you might need to start the web application.</p>

<p>Although Aspire does not support this out of the box, you can achieve it using Aspire’s extension points.</p>

<p>For a detailed guide, refer to my blog post <a href="https://nikiforovall.github.io/dotnet/aspire/2024/06/28/startup-dependencies-aspire.html" target="_blank" rel="noopener noreferrer">Managing Startup Dependencies in .NET Aspire</a>. Basically, I have created a NuGet package <a href="https://www.nuget.org/packages/Nall.Aspire.Hosting.DependsOn" target="_blank" rel="noopener noreferrer">Nall.Aspire.Hosting.DependsOn</a> to address this issue.</p>

<p>Here is an example of how you can use it:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">var</span> <span class="n">builder</span> <span class="p">=</span> <span class="n">DistributedApplication</span><span class="p">.</span><span class="nf">CreateBuilder</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>

<span class="kt">var</span> <span class="n">dbServer</span> <span class="p">=</span> <span class="n">builder</span>
    <span class="p">.</span><span class="nf">AddPostgres</span><span class="p">(</span><span class="s">"db-server"</span><span class="p">)</span>
    <span class="p">.</span><span class="nf">WithHealthCheck</span><span class="p">();</span>

<span class="n">dbServer</span><span class="p">.</span><span class="nf">WithPgAdmin</span><span class="p">(</span><span class="n">c</span> <span class="p">=&gt;</span> <span class="n">c</span><span class="p">.</span><span class="nf">WithHostPort</span><span class="p">(</span><span class="m">5050</span><span class="p">).</span><span class="nf">WaitFor</span><span class="p">(</span><span class="n">dbServer</span><span class="p">));</span>

<span class="kt">var</span> <span class="n">db</span> <span class="p">=</span> <span class="n">dbServer</span><span class="p">.</span><span class="nf">AddDatabase</span><span class="p">(</span><span class="s">"db"</span><span class="p">);</span>

<span class="kt">var</span> <span class="n">migrator</span> <span class="p">=</span> <span class="n">builder</span><span class="p">.</span><span class="n">AddProject</span><span class="p">&lt;</span><span class="n">Projects</span><span class="p">.</span><span class="n">MigrationService</span><span class="p">&gt;(</span><span class="s">"migrator"</span><span class="p">)</span>
    <span class="p">.</span><span class="nf">WithReference</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
    <span class="p">.</span><span class="nf">WaitFor</span><span class="p">(</span><span class="n">db</span><span class="p">);</span>

<span class="kt">var</span> <span class="n">api</span> <span class="p">=</span> <span class="n">builder</span><span class="p">.</span><span class="n">AddProject</span><span class="p">&lt;</span><span class="n">Projects</span><span class="p">.</span><span class="n">Api</span><span class="p">&gt;(</span><span class="s">"api"</span><span class="p">)</span>
    <span class="p">.</span><span class="nf">WithReference</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
    <span class="p">.</span><span class="nf">WaitForCompletion</span><span class="p">(</span><span class="n">migrator</span><span class="p">);</span>

<span class="n">builder</span><span class="p">.</span><span class="nf">Build</span><span class="p">().</span><span class="nf">Run</span><span class="p">();</span>
</code></pre></div></div>

<p>In the code above, we use <code class="language-plaintext highlighter-rouge">WithHealthCheck</code>, <code class="language-plaintext highlighter-rouge">WaitFor</code>, <code class="language-plaintext highlighter-rouge">WaitForCompletion</code> to define dependency graph. This ensures that the database is up and running before starting the migration service, and the migration service is completed before starting the API.</p>

<p>🙌🆕 I have another good news for you! In Aspire 9.0, this is now a built-in feature.</p>

<p>See the related GitHub issue: <a href="https://github.com/dotnet/aspire/pull/5394" target="_blank" rel="noopener noreferrer">WaitFor/WaitForCompletion implementation. #5394</a></p>

<h2 id="lesson-5-aspire-project-can-take-some-time-to-boot-up">Lesson 5. Aspire project can take some time to boot up</h2>

<p>Since there is no hot-reload support for <code class="language-plaintext highlighter-rouge">AppHost</code>, you have to rebuild and restart the project every time you make a change. This can be time-consuming, especially if your project is large and has many dependencies.</p>

<p>In our case, the <code class="language-plaintext highlighter-rouge">Elasticsearch</code> container took some time to start up, which slowed down the development process. It can take 30-60 seconds to start up, which at first glance seems like not a lot, but trust me, things add up.</p>

<p>To overcome this, we’ve implemented a mechanism to run only infrastructure services when needed. It is like a <code class="language-plaintext highlighter-rouge">docker-compose.infrastructure.yml</code> file, but for Aspire.</p>

<p>🙌🆕 There is a solution to this problem! One of my favorite improvements in Aspire 9.0 is the - <a href="https://github.com/dotnet/aspire/issues/923" target="_blank" rel="noopener noreferrer">option to set up and keep resources (containers) after AppHost shutdown #923</a>. It saves us from the headache of restarting <code class="language-plaintext highlighter-rouge">Elasticsearch</code> every time we make a change.</p>

<h2 id="lesson-6-it-can-be-challenging-to-run-things-without-aspire">Lesson 6. It can be challenging to run things without Aspire</h2>

<p>Sometimes you need to run things without Aspire, but it is not easy because everything is tightly integrated with Aspire, and a lot of things are abstracted away.
For example, assume I want to run a Blazor application in hot-reload mode without starting the Aspire <code class="language-plaintext highlighter-rouge">AppHost</code> but still utilize the infrastructure provisioned and managed by Aspire.</p>

<p>To overcome this, we created a specific project called <code class="language-plaintext highlighter-rouge">EnvDumper</code> that dumps the environment variables and connection strings to a file called <code class="language-plaintext highlighter-rouge">appsettings.Development.Aspire.json</code>. The idea is that you can run the application without Aspire by using this file.</p>

<p>So the scenario is like this:</p>

<ol>
  <li>You exclude a project from the Aspire <code class="language-plaintext highlighter-rouge">AppHost</code> by using configuration.</li>
  <li>When you do this, the excluded projects are replaced by the <code class="language-plaintext highlighter-rouge">EnvDumper</code> project.</li>
  <li>The <code class="language-plaintext highlighter-rouge">EnvDumper</code> project dumps the environment variables and connection strings to a file.</li>
  <li>You add the corresponding file to an excluded project and run it without Aspire in hot-reload mode.</li>
</ol>

<p>From <code class="language-plaintext highlighter-rouge">AppHost</code> perspective it looks like this:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">var</span> <span class="n">builder</span> <span class="p">=</span> <span class="n">DistributedApplication</span><span class="p">.</span><span class="nf">CreateBuilder</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>

<span class="n">builder</span><span class="p">.</span><span class="n">RegisterProject</span><span class="p">&lt;</span><span class="n">Projects</span><span class="p">.</span><span class="n">WebApp</span><span class="p">&gt;(</span><span class="s">"web-app"</span><span class="p">)</span>
    <span class="p">.</span><span class="nf">WithReference</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
    <span class="p">.</span><span class="nf">WithReference</span><span class="p">(</span><span class="n">blobStorage</span><span class="p">)</span>
    <span class="p">.</span><span class="nf">WithReference</span><span class="p">(</span><span class="n">elastic</span><span class="p">);</span>
</code></pre></div></div>

<p>Here is <code class="language-plaintext highlighter-rouge">RegisterProject</code> extension method:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">static</span> <span class="n">IResourceBuilder</span><span class="p">&lt;</span><span class="n">IResourceWithEnvironment</span><span class="p">&gt;</span> <span class="n">RegisterProject</span><span class="p">&lt;</span><span class="n">TProject</span><span class="p">&gt;(</span>
    <span class="k">this</span> <span class="n">IDistributedApplicationBuilder</span> <span class="n">builder</span><span class="p">,</span>
    <span class="kt">string</span> <span class="n">name</span>
<span class="p">)</span>
    <span class="k">where</span> <span class="n">TProject</span> <span class="p">:</span> <span class="n">IProjectMetadata</span><span class="p">,</span> <span class="k">new</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">IResourceBuilder</span><span class="p">&lt;</span><span class="n">IResourceWithEnvironment</span><span class="p">&gt;?</span> <span class="n">project</span> <span class="p">=</span> 
        <span class="nf">IsExcludedProject</span><span class="p">(</span><span class="n">builder</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="p">?</span> <span class="n">builder</span><span class="p">.</span><span class="n">AddProject</span><span class="p">&lt;</span><span class="n">Projects</span><span class="p">.</span><span class="n">EnvDumper</span><span class="p">&gt;(</span><span class="n">componentName</span><span class="p">)</span>
        <span class="p">:</span> <span class="n">builder</span><span class="p">.</span><span class="n">AddProject</span><span class="p">&lt;</span><span class="n">TProject</span><span class="p">&gt;(</span><span class="n">name</span><span class="p">);</span>

    <span class="k">return</span> <span class="n">project</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>🙌🆕 Alternatively, to speed up the development process, consider exploring the new feature in Aspire 9.0 - <a href="https://github.com/dotnet/aspire/issues/295" target="_blank" rel="noopener noreferrer">Add support for restarting services from the dashboard #295</a>. Although I haven’t tried it yet, I believe this feature will address many of my requirements.</p>

<h2 id="lesson-7-there-is-no-easy-way-to-run-a-partial-setup">Lesson 7. There is no easy way to run a partial setup</h2>

<p>Sometimes you need to run a partial setup, for example, to test a specific feature or component without starting the entire application. However, Aspire does not provide an easy way to do this out of the box. As you already know, we added the feature to exclude projects from the Aspire <code class="language-plaintext highlighter-rouge">AppHost</code> by using configuration. (See Lesson 5)</p>

<h2 id="lesson-8-using-podman-instead-of-docker-can-be-troublesome">Lesson 8. Using Podman instead of Docker can be troublesome</h2>

<p>💥 Networking issues can arise when using Podman instead of Docker from Windows. For example, we encountered problems with the Kibana container not being able to connect to the Elasticsearch container.</p>

<p>The problem exists to this day, and there are no workarounds available.</p>

<p>See the related GitHub issue: <a href="https://github.com/dotnet/aspire/issues/4136" target="_blank" rel="noopener noreferrer">Podman-hosted containers may not be able to reach Aspire services #4136</a></p>

<h2 id="lesson-9-aspire-client-integrations-require-ihostapplicationbuilder">Lesson 9. Aspire client integrations require IHostApplicationBuilder</h2>

<p>Aspire client integrations require <code class="language-plaintext highlighter-rouge">IHostApplicationBuilder</code>, which might not always be available. For instance, if you want to use client integrations and add dependencies to <code class="language-plaintext highlighter-rouge">IServiceCollection</code> in a console application, or if you have existing code that uses <code class="language-plaintext highlighter-rouge">IServiceCollection</code> and <code class="language-plaintext highlighter-rouge">ConfigurationManager</code> separately, you may find out your self in a tricky situation. Now, you have to refactor entire codebase just to use a client integration.</p>

<p>This is what happened to us, take a look at:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">AddNpgsqlDataSource</span><span class="p">(</span>
    <span class="k">this</span> <span class="n">IHostApplicationBuilder</span> <span class="n">builder</span><span class="p">,</span>
    <span class="kt">string</span> <span class="n">connectionName</span><span class="p">,</span>
    <span class="n">Action</span><span class="p">&lt;</span><span class="n">NpgsqlSettings</span><span class="p">&gt;?</span> <span class="n">configureSettings</span> <span class="p">=</span> <span class="k">null</span><span class="p">,</span>
    <span class="n">Action</span><span class="p">&lt;</span><span class="n">NpgsqlDataSourceBuilder</span><span class="p">&gt;?</span> <span class="n">configureDataSourceBuilder</span> <span class="p">=</span> <span class="k">null</span><span class="p">);</span>
</code></pre></div></div>

<p>As you can see, we should provide an instance of <code class="language-plaintext highlighter-rouge">IHostApplicationBuilder</code> to use this extension method. This was a problem in our case because we had a lot of existing code that uses <code class="language-plaintext highlighter-rouge">IServiceCollection</code>, and since our solution consists of a hierarchy of projects with different configurations, it takes some time to refactor everything.</p>

<p>🤔 I think this design choice breaks the Postel’s Law principle, which states that you should be liberal in what you accept and conservative in what you send. In other words, it should be easy to use and hard to misuse. I would imagine an overload that does less but requires <code class="language-plaintext highlighter-rouge">IServiceCollection</code> instead. It would make client integrations more composable.</p>

<h2 id="lesson-10-learn-by-example">Lesson 10. Learn by example</h2>

<p>The best way to learn how to use Aspire is by example. I recommend checking out the official Aspire samples and the Aspire GitHub repository.</p>

<p>⭐ Here are some of my favorite reference applications:</p>

<ul>
  <li>
<a href="https://github.com/dotnet/eShopSupport" target="_blank" rel="noopener noreferrer">eShopSupport</a> - A reference .NET application using AI for a customer support ticketing system</li>
  <li>
<a href="https://github.com/dotnet/eShop" target="_blank" rel="noopener noreferrer">eShop</a> - A reference .NET application implementing an eCommerce site</li>
  <li>
<a href="https://github.com/Azure-Samples/eShopOnAzure" target="_blank" rel="noopener noreferrer">eShopOnAzure</a> - A variant of eShop that uses Azure services</li>
  <li>
<a href="https://github.com/cecilphillip/shadowshop" target="_blank" rel="noopener noreferrer">cecilphillip/shadowShop</a> - A modified version of the Aspire Shop sample application that adds integration with Stripe for payment processing, temporal for durable workflows, other customer Aspire Integrations</li>
  <li>
<a href="https://github.com/thangchung/practical-dotnet-aspire" target="_blank" rel="noopener noreferrer">thangchung/practical-dotnet-aspire</a> - The practical .NET Aspire builds on the coffeeshop app business domain</li>
  <li>
<a href="https://github.com/aspirant-project/aspirant" target="_blank" rel="noopener noreferrer">Aspirant</a> - Aspirant is a set of extensions and experiments for .NET Aspire App Host projects</li>
</ul>

<h2 id="conclusion">Conclusion</h2>

<p>Aspire is more than just an alternative to docker-compose; it is a comprehensive ecosystem designed to simplify the building, running, and management of your applications. The key feature of Aspire is its <strong>programmability</strong>, which enables you to extend and customize the platform to meet your specific requirements.</p>

<blockquote>
  <p>🙌 I hope you found it helpful. If you have any questions, please feel free to reach out.</p>
</blockquote>

	</div>

	

	
	<ul class="tag_box list-unstyled list-inline">
		<li><i class="fa fa-folder-open"></i></li>
		
		
		
		<li><a href="https://nikiforovall.github.io/categories.html#dotnet-ref" target="_blank" rel="noopener noreferrer">
				dotnet <span>(55)</span>
				,
			</a></li>
		
		<li><a href="https://nikiforovall.github.io/categories.html#aspire-ref" target="_blank" rel="noopener noreferrer">
				aspire <span>(4)</span>
				
			</a></li>
		
		
	</ul>
	

	
	<ul class="list-inline">
		<li><i class="fa fa-tags"></i></li>
		
		
		
		<li>
			<a href="https://nikiforovall.github.io/tags.html#dotnet-ref" target="_blank" rel="noopener noreferrer">
				dotnet <span>(60)</span>
				,
			</a>
		</li>
		
		<li>
			<a href="https://nikiforovall.github.io/tags.html#aspire-ref" target="_blank" rel="noopener noreferrer">
				aspire <span>(18)</span>
				
			</a>
		</li>
		
		
		
	</ul>
	

	<hr>

	<div>
		<section class="share col-sm-6">
			<h4 class="section-title">Share Post</h4>
			<a class="btn btn-default btn-sm twitter" href="http://twitter.com/share?&amp;via=nikiforovall" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;" target="_blank" rel="noopener noreferrer">
				<i class="fa fa-twitter fa-lg"></i>
				Twitter
			</a>
		</section>

		<section class="col-sm-6 author">
			<img src="//www.gravatar.com/avatar/e86fa0938976c38907a302ecb208f011" class="img-rounded author-image">
			<h4 class="section-title author-name">Oleksii Nikiforov</h4>
			<p class="author-bio">Jibber-jabbering about programming and IT.</p>
		</section>
	</div>

	<div class="clearfix"></div>

	<ul class="pager">
		
		<li class="previous"><a href="https://nikiforovall.github.io/dotnet/2024/09/14/quality-gates-dotnet.html" title="A Tyrant Guide to Code Quality Gates featuring CSharpier, Husky.NET, and SonarCloud" target="_blank" rel="noopener noreferrer">←
				Previous</a></li>
		
		
		<li class="next">
<a href="https://nikiforovall.github.io/dotnet/2024/10/19/semantic-search-via-elastic-dotnet.html" title="Semantic Search with Elasticsearch in .NET" target="_blank" rel="noopener noreferrer">Next →</a>
		</li>
		
	</ul>

	<hr>
	</div>

	<div class="col-sm-2 sidebar-2">

	</div>

</article>
<div class="clearfix"></div>



    
    <script src="https://utteranc.es/client.js" repo="NikiforovAll/nikiforovall.github.io" issue-term="pathname" label="Blog" theme="preferred-color-scheme" crossorigin="anonymous" async>
    </script>





		<footer>
			<hr>
			<p>
				© 2025 Oleksii Nikiforov with <a href="http://jekyllrb.com/" target="_blank" rel="noopener noreferrer">Jekyll</a>. Theme: <a href="https://github.com/dbtek/dbyll" target="_blank" rel="noopener noreferrer">dbyll</a> by dbtek.
			</p>
		</footer>
	</div>

	<script type="text/javascript" src="https://nikiforovall.github.io/assets/resources/jquery/jquery.min.js"></script>
	<script type="text/javascript" src="https://nikiforovall.github.io/assets/resources/bootstrap/js/bootstrap.min.js"></script>
	<script type="text/javascript" src="https://nikiforovall.github.io/assets/js/app.js"></script>
	
		<script type="text/javascript" src="https://unpkg.com/mermaid@10.9.0/dist/mermaid.min.js">
</script>
<script>
$(document).ready(function() {
    mermaid.initialize({
        theme: 'forest'
    });
});
</script>

	
</body>
</html>



<!-- Asynchronous Google Analytics snippet -->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-164555539-1', 'auto');
  ga('send', 'pageview');
</script>

