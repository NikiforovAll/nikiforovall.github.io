<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<title>Hybrid Search with Elasticsearch in .NET | N+1 Blog</title>

	<!-- Meta Description -->
	
	<meta name="description" content="Use the reciprocal rank fusion algorithm to combine the results of BM25 and kNN semantic search.">
	

	<meta name="author" content="Oleksii Nikiforov">

	<!-- Canonical URL -->
	<link rel="canonical" href="http://localhost:4000/dotnet/2024/11/02/elastic-hybrid-search.html">

	<!-- Open Graph -->
	<meta property="og:title" content="Hybrid Search with Elasticsearch in .NET">
	<meta property="og:description" content="Use the reciprocal rank fusion algorithm to combine the results of BM25 and kNN semantic search.">
	<meta property="og:url" content="http://localhost:4000/dotnet/2024/11/02/elastic-hybrid-search.html">
	<meta property="og:site_name" content="N+1 Blog">
	<meta property="og:type" content="article">
	
	<meta property="article:published_time" content="2024-11-02T00:00:00+02:00">
	
	<meta property="og:image" content="http://localhost:4000/assets/media/default-post-image.png">

	<!-- Twitter Card -->
	<meta name="twitter:card" content="summary_large_image">
	<meta name="twitter:site" content="@nikiforovall">
	<meta name="twitter:title" content="Hybrid Search with Elasticsearch in .NET">
	<meta name="twitter:description" content="Use the reciprocal rank fusion algorithm to combine the results of BM25 and kNN semantic search.">
	<meta name="twitter:image" content="http://localhost:4000/assets/media/default-post-image.png">

	<!-- Enable responsive viewport -->
	<meta name="viewport" content="width=device-width, initial-scale=1.0">

	<!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
	<!--[if lt IE 9]>
	<script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
	<![endif]-->

	<!-- Le styles -->
	<link href="/assets/resources/bootstrap/css/bootstrap.min.css" rel="stylesheet">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" integrity="sha512-Evv84Mr4kqVGRNSgIGL/F/aIDqQb7xQ2vcrdIwxfjThSH8CSR7PBEakCr51Ck+w+/U6swU2Im1vVX0SVk9ABhg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
	<link href="/assets/resources/syntax/syntax.css" rel="stylesheet">
	<link href="/assets/css/style.css" rel="stylesheet">

	<!-- Search Feature Styles -->
	<style>
		.layout-page .search-trigger { position: fixed; top: 45px; right: 100px; z-index: 1000; display: flex; align-items: center; gap: 10px; padding: 6px 12px; background: #f5f5f5; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; min-width: 220px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); transition: all 0.15s ease; height: 34px; box-sizing: border-box; }
		.layout-post .search-trigger { position: fixed; top: 45px; right: 100px; z-index: 1000; display: flex; align-items: center; justify-content: center; padding: 0; background: #f5f5f5; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; width: 34px; height: 34px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); transition: all 0.15s ease; box-sizing: border-box; }
		.search-trigger:hover { background: #ebebeb; border-color: #c0c0c0; box-shadow: 0 2px 5px rgba(0,0,0,0.08); }
		.search-icon { color: #666; font-size: 14px; display: flex; align-items: center; }
		.search-placeholder { flex: 1; color: #999; font-size: 14px; user-select: none; }
		.search-keybind { display: flex; gap: 4px; align-items: center; }
		.search-key { font-family: 'Courier New', monospace; font-size: 11px; padding: 2px 6px; background: #e0e0e0; border: 1px solid #ccc; border-bottom: 2px solid #bbb; border-radius: 3px; color: #333; line-height: 1.2; box-shadow: 0 1px 1px rgba(0,0,0,0.1); }
		.layout-post .search-placeholder { display: none; }
		.layout-post .search-keybind { display: none; }
		.search-modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: 10000; display: none; align-items: flex-start; justify-content: center; padding-top: 10vh; }
		.search-modal.open { display: flex; animation: fadeIn 0.2s ease; }
		@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
		.search-backdrop { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); backdrop-filter: blur(2px); }
		.search-modal-container { position: relative; width: 90%; max-width: 600px; background: white; border-radius: 8px; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3); overflow: hidden; }
		.search-input-container { display: flex; align-items: center; padding: 16px 20px; border-bottom: 1px solid #e0e0e0; gap: 12px; }
		.search-modal-icon { color: #666; font-size: 18px; }
		.search-modal-input { flex: 1; border: none; outline: none; font-size: 16px; color: #333; background: transparent; }
		.search-modal-input::placeholder { color: #999; }
		.search-close-btn { background: transparent; border: none; color: #999; font-size: 18px; cursor: pointer; padding: 4px 8px; border-radius: 4px; transition: all 0.15s ease; }
		.search-close-btn:hover { background: #f0f0f0; color: #333; }
		.search-results { max-height: 60vh; overflow-y: auto; padding: 8px; }
		.search-hint { padding: 40px 20px; text-align: center; color: #999; font-size: 14px; }
		.search-result-item { padding: 12px 16px; border-radius: 6px; cursor: pointer; transition: background-color 0.15s ease; border: 2px solid transparent; margin-bottom: 4px; }
		.search-result-item:hover { background: #f5f5f5; }
		.search-result-item.selected { background: #e8f4f8; border-color: #4a90e2; }
		.search-footer { display: flex; justify-content: center; gap: 20px; padding: 12px 20px; border-top: 1px solid #e0e0e0; background: #fafafa; font-size: 12px; color: #666; }
		.search-footer kbd { font-family: 'Courier New', monospace; font-size: 11px; padding: 2px 5px; background: white; border: 1px solid #ddd; border-radius: 3px; color: #333; box-shadow: 0 1px 1px rgba(0,0,0,0.1); }
		@media (max-width: 768px) { .layout-page .search-trigger, .layout-post .search-trigger { display: none; } .search-modal { padding-top: 5vh; } .search-modal-container { width: 95%; max-width: none; margin: 0 10px; } .search-results { max-height: 50vh; } .search-footer { flex-wrap: wrap; gap: 10px; } }
	</style>

	<!-- Le fav and touch icons -->
	<!-- Update these with your own images
	<link rel="shortcut icon" href="images/favicon.ico">
	<link rel="apple-touch-icon" href="images/apple-touch-icon.png">
	<link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
	<link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
	-->
	<link rel="shortcut icon" href="/assets/media/favicon.ico">

	<link rel="alternate" type="application/rss+xml" title="" href="http://localhost:4000/feed.xml">

	
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Hybrid Search with Elasticsearch in .NET",
  
  
  "description": "Use the reciprocal rank fusion algorithm to combine the results of BM25 and kNN semantic search.",
  
  "image": ["http://localhost:4000/assets/media/default-post-image.png"],
  "datePublished": "2024-11-02T00:00:00+02:00",
  "dateModified": "2024-11-02T00:00:00+02:00",
  "author": {
    "@type": "Person",
    "name": "Oleksii Nikiforov",
    "url": "http://localhost:4000/about.html",
    "sameAs": [
      "https://github.com/nikiforovAll",
      "https://twitter.com/nikiforovall",
      "https://www.linkedin.com/in/nikiforov-oleksii",
      "https://t.me/nikiforovallblog"
    ]
  },
  "publisher": {
    "@type": "Person",
    "name": "Oleksii Nikiforov",
    "logo": {
      "@type": "ImageObject",
      "url": "https://www.gravatar.com/avatar/e86fa0938976c38907a302ecb208f011?s=200"
    }
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "http://localhost:4000/dotnet/2024/11/02/elastic-hybrid-search.html"
  },
  
  "articleSection": "dotnet",
  
  
  "keywords": "dotnet, elasticsearch, search, ai",
  
  "inLanguage": "en-US"
}
</script>


</head>

<body class="layout-post">
	<nav class="navbar navbar-default visible-xs" role="navigation">
		<!-- Brand and toggle get grouped for better mobile display -->
		<div class="navbar-header">
			<button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
				<span class="sr-only">Toggle navigation</span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</button>
			
			<a type="button" class="navbar-toggle nav-link" href="http://github.com/nikiforovAll" target="_blank" rel="noopener noreferrer noopener noreferrer">
				<i class="fa-brands fa-github"></i>
			</a>
			
			
			<a type="button" class="navbar-toggle nav-link" href="http://x.com/nikiforovall" target="_blank" rel="noopener noreferrer noopener noreferrer">
				<i class="fa-brands fa-x-twitter"></i>
			</a>
			
			
			<a type="button" class="navbar-toggle nav-link" href="mailto:alexey.nikiforovall@gmail.com">
				<i class="fa-solid fa-envelope"></i>
			</a>
			
			<a class="navbar-brand" href="/">
				<img src="//www.gravatar.com/avatar/e86fa0938976c38907a302ecb208f011?s=35" class="img-circle">
				N+1 Blog
			</a>
		</div>

		<!-- Collect the nav links, forms, and other content for toggling -->
		<div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
			<ul class="nav navbar-nav">
				<li class="active"><a href="/">Home</a></li>
				<li><a href="/topics.html">Topics</a></li>
				<li><a href="/about.html">About</a></li>
			</ul>
		</div>
<!-- /.navbar-collapse -->
	</nav>

	<!-- nav-menu-dropdown -->
	<div class="btn-group hidden-xs" id="nav-menu">
		<button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">
			<i class="fa-solid fa-bars"></i>
		</button>
		<ul class="dropdown-menu" role="menu">
			<li><a href="/"><i class="fa-solid fa-home"></i>Home</a></li>
			<li><a href="/topics.html"><i class="fa-solid fa-bookmark"></i>Topics</a></li>
			<li><a href="/about.html"><i class="fa-solid fa-pencil"></i>About</a></li>
			<li class="divider">
			<li><a href="#"><i class="fa-solid fa-arrow-up"></i>Top of Page</a></li>
		</ul>
	</div>

	<!-- Search Control -->
	<button id="search-trigger" class="search-trigger" type="button" aria-label="Open search">
		<span class="search-icon"><i class="fa-solid fa-search"></i></span>
		<span class="search-placeholder">Search</span>
		<div class="search-keybind">
			<kbd class="search-key" id="search-modifier">ctrl</kbd>
			<kbd class="search-key">K</kbd>
		</div>
	</button>

	<!-- Search Modal -->
	<div id="search-modal" class="search-modal">
		<div class="search-backdrop"></div>
		<div class="search-modal-container">
			<div class="search-input-container">
				<i class="fa-solid fa-search search-modal-icon"></i>
				<input type="text" id="search-input" class="search-modal-input" placeholder="Search blog posts..." autocomplete="off">
				<button id="search-close" class="search-close-btn" title="Close (ESC)">
					<i class="fa-solid fa-times"></i>
				</button>
			</div>
			<div id="search-results" class="search-results">
				<div class="search-hint">Type at least 2 characters to search...</div>
			</div>
			<div class="search-footer">
				<span><kbd>‚Üë</kbd> <kbd>‚Üì</kbd> to navigate</span>
				<span><kbd>‚Üµ</kbd> to select</span>
				<span><kbd>ESC</kbd> to close</span>
			</div>
		</div>
	</div>

	<div class="col-sm-3 sidebar hidden-xs" style="">
		<!-- sidebar.html -->
<header class="sidebar-header" role="banner">
	<a href="/" class="profile-link">
		<img src="//www.gravatar.com/avatar/e86fa0938976c38907a302ecb208f011?s=150" class="img-circle profile-image">
		<div class="profile-accent"></div>
	</a>
	<h3 class="title">
        <a href="/">N+1 Blog</a>
    </h3>
</header>


<div id="bio" class="text-center">
	Jibber-jabbering about programming and IT.
</div>


<div id="contact-list" class="text-center">
	<ul class="list-unstyled list-inline">
		
		<li>
			<a class="btn btn-default btn-sm" href="https://github.com/nikiforovAll" target="_blank" rel="noopener noreferrer noopener noreferrer">
				<i class="fa-brands fa-github fa-xl"></i>
			</a>
		</li>
		
		
		<li>
			<a class="btn btn-default btn-sm" href="https://x.com/nikiforovall" target="_blank" rel="noopener noreferrer noopener noreferrer">
				<i class="fa-brands fa-x-twitter fa-xl"></i>
			</a>
		</li>
		
		
		<li>
			<a class="btn btn-default btn-sm" href="https://t.me/nikiforovallblog" target="_blank" rel="noopener noreferrer noopener noreferrer">
				<i class="fa-brands fa-telegram fa-xl"></i>
			</a>
		</li>
		
		
		<li>
			<a class="btn btn-default btn-sm" href="https://linkedin.com/in/nikiforov-oleksii" target="_blank" rel="noopener noreferrer noopener noreferrer">
				<i class="fa-brands fa-linkedin fa-xl"></i>
			</a>
		</li>
		
	</ul>
	<ul id="contact-list-secondary" class="list-unstyled list-inline">
		
		<li>
			<a class="btn btn-default btn-sm" href="mailto:alexey.nikiforovall@gmail.com">
				<i class="fa-solid fa-envelope fa-xl"></i>
			</a>
		</li>
		
		<li>
			<a class="btn btn-default btn-sm" href="/feed.xml" target="_blank" rel="noopener noreferrer">
				<i class="fa-solid fa-rss fa-xl"></i>
			</a>
		</li>
	</ul>
</div>
<!-- sidebar.html end -->

	</div>

	<div class="col-sm-9 col-sm-offset-3">
		<div class="page-header">
	<h1>Hybrid Search with Elasticsearch in .NET </h1>
</div>
<article>

	<div class="col-sm-10">

		<span class="post-date">
			
			November
			2nd,
			
			2024
		</span>

	
	
	
	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	
	<div>
		<h5><a href="/dotnet/2024/10/20/querying-and-filtering-elastic-dotnet.html">Querying and Filtering via Elastic.Clients.Elasticsearch in .NET <span class="label label-default">dotnet</span>  <span class="label label-default">elasticsearch</span>  <span class="label label-default">search</span> </a></h5>
	</div>
	
	
	

	

	
	

	

	
	<div>
		<h5><a href="/dotnet/2024/10/19/semantic-search-via-elastic-dotnet.html">Semantic Search with Elasticsearch in .NET <span class="label label-default">dotnet</span>  <span class="label label-default">elasticsearch</span>  <span class="label label-default">ai</span>  <span class="label label-default">search</span> </a></h5>
	</div>
	
	
	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	
	

	<div class="article_body" style="margin-top: 30px;">
		<h2 id="tldr">TL;DR</h2>

<p>Use the reciprocal rank fusion algorithm to combine the results of BM25 and kNN semantic search.</p>

<p><strong>Source code:</strong> <a href="https://github.com/NikiforovAll/elasticsearch-dotnet-playground/blob/main/src/elasticsearch-getting-started/02-hybrid-search.ipynb" target="_blank" rel="noopener noreferrer">https://github.com/NikiforovAll/elasticsearch-dotnet-playground/blob/main/src/elasticsearch-getting-started/02-hybrid-search.ipynb</a></p>

<h2 id="introduction">Introduction</h2>

<p>I‚Äôve prepared a Jupyter notebook that demonstrates how to use the reciprocal rank fusion algorithm using <code class="language-plaintext highlighter-rouge">Elastic.Clients.Elasticsearch</code>. You can find the source code <a href="https://github.com/NikiforovAll/elasticsearch-dotnet-playground/blob/main/src/elasticsearch-getting-started/02-hybrid-search.ipynb" target="_blank" rel="noopener noreferrer">here</a>.</p>

<center>
    <video src="https://github.com/user-attachments/assets/cf989ebc-64c8-4c8a-937a-d04016a8c403" width="90%" controls="controls"></video>
</center>

<h2 id="hybrid-search">Hybrid Search</h2>

<p>In my previous blog posts, you have seen two different approaches to search a collection of documents (<a href="https://nikiforovall.github.io/dotnet/2024/10/19/semantic-search-via-elastic-dotnet.html" target="_blank" rel="noopener noreferrer">Semantic Search with Elasticsearch in .NET</a> and <a href="https://nikiforovall.github.io/dotnet/2024/10/20/querying-and-filtering-elastic-dotnet.html" target="_blank" rel="noopener noreferrer">Querying and Filtering via Elastic.Clients.Elasticsearch in .NET</a>), each with its own particular benefits. If one of these methods matches your needs then you don‚Äôt need anything else, but in many cases each method of searching returns valuable results that the other method would miss, so the best option is to offer a combined result set.</p>

<p>For these cases, Elasticsearch offers <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/rrf.html" target="_blank" rel="noopener noreferrer">Reciprocal Rank Fusion</a>, an algorithm that combines results from two or more lists into a single list.</p>

<h3 id="how-rrf-works-in-elasticsearch">How RRF Works in Elasticsearch</h3>

<p>‚òùÔ∏è RRF is based on the concept of reciprocal rank, which is the inverse of the rank of the first relevant document in a list of search results. The goal of the technique is to take into account the position of the items in the original rankings, and give higher importance to items that are ranked higher in multiple lists. This can help improve the overall quality and reliability of the final ranking, making it more useful for the task of fusing multiple ordered search results.</p>

<p>Elasticsearch integrates the <em>RRF algorithm</em> into the search query. Consider the following example, which has <code class="language-plaintext highlighter-rouge">query</code> and <code class="language-plaintext highlighter-rouge">knn</code> sections to request full-text and vector searches respectively, and a <code class="language-plaintext highlighter-rouge">rrf</code> section that combines them into a single result list.</p>

<div class="language-jsonc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="nl">"query"</span><span class="p">:{</span><span class="w">
        </span><span class="c1">// full-text search query here</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nl">"knn"</span><span class="p">:{</span><span class="w">
        </span><span class="c1">// vector search query here</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nl">"rank"</span><span class="p">:{</span><span class="w">
        </span><span class="nl">"rrf"</span><span class="p">:</span><span class="w"> </span><span class="p">{}</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>While RRF works fairly well for short lists of results without any configuration, there are some parameters that can be tuned to provide the best results. Consult the <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/rrf.html#rrf-api" target="_blank" rel="noopener noreferrer">documentation</a> to learn about these in detail.</p>

<h3 id="demo">Demo</h3>

<p>‚ö†Ô∏è I assume you already have the ‚Äúbook_index‚Äù dataset from my previous post <a href="https://nikiforovall.github.io/dotnet/2024/10/19/semantic-search-via-elastic-dotnet.html" target="_blank" rel="noopener noreferrer">Semantic Search with Elasticsearch in .NET</a>. If you don‚Äôt, please follow the instructions in that post to set up the dataset.</p>

<p>1Ô∏è‚É£ First, let‚Äôs define a method to convert a search query to an embedding vector. I will use <a href="https://devblogs.microsoft.com/dotnet/introducing-microsoft-extensions-ai-preview/" target="_blank" rel="noopener noreferrer">Microsoft.Extensions.AI</a>. It requires Azure Open AI model to generate embeddings. I will go with (<code class="language-plaintext highlighter-rouge">text-embedding-3-small</code>) because it allows you to specify embedding size. This is important because the size of the embedding vector should match the size of the vector field in the Elasticsearch index and Elasticsearch has a limit of 512 dimensions for vector fields.</p>

<p>üí° Larger embeddings can capture more nuances and subtle relationships in the data, potentially leading to better model accuracy. However, very large embeddings can also lead to overfitting, where the model performs well on training data but poorly on unseen data. This is because the model might learn to memorize the training data rather than generalize from it.</p>

<p>Here is the code to generate an embedding vector for a given text:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">using</span> <span class="nn">Azure.AI.OpenAI</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Microsoft.Extensions.AI</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.ClientModel</span><span class="p">;</span>

<span class="n">AzureOpenAIClient</span> <span class="n">aiClient</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">AzureOpenAIClient</span><span class="p">(</span>
    <span class="k">new</span> <span class="nf">Uri</span><span class="p">(</span><span class="n">envs</span><span class="p">[</span><span class="s">"AZURE_OPENAI_ENDPOINT"</span><span class="p">]),</span>
    <span class="k">new</span> <span class="nf">ApiKeyCredential</span><span class="p">(</span><span class="n">envs</span><span class="p">[</span><span class="s">"AZURE_OPENAI_APIKEY"</span><span class="p">]));</span>

<span class="kt">var</span> <span class="n">generator</span> <span class="p">=</span> <span class="n">aiClient</span><span class="p">.</span><span class="nf">AsEmbeddingGenerator</span><span class="p">(</span><span class="n">modelId</span><span class="p">:</span> <span class="s">"text-embedding-3-small"</span><span class="p">);</span>

<span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="kt">float</span><span class="p">[</span><span class="k">]&gt;</span> <span class="nf">ToEmbedding</span><span class="p">(</span><span class="kt">string</span> <span class="n">text</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">var</span> <span class="n">textEmbeddingDimension</span> <span class="p">=</span> <span class="m">384</span><span class="p">;</span>
    <span class="kt">var</span> <span class="n">embeddings</span> <span class="p">=</span> <span class="k">await</span> <span class="n">generator</span><span class="p">.</span><span class="nf">GenerateAsync</span><span class="p">([</span><span class="n">text</span><span class="p">],</span> <span class="k">new</span> <span class="n">EmbeddingGenerationOptions</span> <span class="p">{</span>
        <span class="n">Dimensions</span> <span class="p">=</span> <span class="n">textEmbeddingDimension</span>
    <span class="p">});</span>

    <span class="k">return</span> <span class="n">embeddings</span><span class="p">.</span><span class="nf">First</span><span class="p">().</span><span class="n">Vector</span><span class="p">.</span><span class="nf">ToArray</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div></div>

<p>2Ô∏è‚É£ Now we can use this method to generate an embedding vector for a search query and use it in both full-text and vector search queries.</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">var</span> <span class="n">searchQuery</span> <span class="p">=</span> <span class="s">"python programming"</span><span class="p">;</span>
<span class="kt">var</span> <span class="n">queryEmbedding</span> <span class="p">=</span> <span class="k">await</span> <span class="nf">ToEmbedding</span><span class="p">(</span><span class="n">searchQuery</span><span class="p">);</span>

<span class="kt">var</span> <span class="n">searchResponse</span> <span class="p">=</span> <span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="n">SearchAsync</span><span class="p">&lt;</span><span class="n">Book</span><span class="p">&gt;(</span><span class="n">s</span> <span class="p">=&gt;</span> <span class="n">s</span>
    <span class="p">.</span><span class="nf">Index</span><span class="p">(</span><span class="s">"book_index"</span><span class="p">)</span>
    <span class="p">.</span><span class="nf">Query</span><span class="p">(</span><span class="n">d</span> <span class="p">=&gt;</span> <span class="n">d</span><span class="p">.</span><span class="nf">Match</span><span class="p">(</span><span class="n">m</span> <span class="p">=&gt;</span> <span class="n">m</span><span class="p">.</span><span class="nf">Field</span><span class="p">(</span><span class="n">f</span> <span class="p">=&gt;</span> <span class="n">f</span><span class="p">.</span><span class="n">Summary</span><span class="p">).</span><span class="nf">Query</span><span class="p">(</span><span class="n">searchQuery</span><span class="p">)))</span>
    <span class="p">.</span><span class="nf">Knn</span><span class="p">(</span><span class="n">d</span> <span class="p">=&gt;</span> <span class="n">d</span>
        <span class="p">.</span><span class="nf">Field</span><span class="p">(</span><span class="n">f</span> <span class="p">=&gt;</span> <span class="n">f</span><span class="p">.</span><span class="n">TitleVector</span><span class="p">)</span>
        <span class="p">.</span><span class="nf">QueryVector</span><span class="p">(</span><span class="n">queryEmbedding</span><span class="p">)</span>
        <span class="p">.</span><span class="nf">k</span><span class="p">(</span><span class="m">5</span><span class="p">)</span>
        <span class="p">.</span><span class="nf">NumCandidates</span><span class="p">(</span><span class="m">10</span><span class="p">))</span>
    <span class="p">.</span><span class="nf">Rank</span><span class="p">(</span><span class="n">r</span> <span class="p">=&gt;</span> <span class="n">r</span><span class="p">.</span><span class="nf">Rrf</span><span class="p">(</span><span class="n">rrf</span> <span class="p">=&gt;</span> <span class="p">{}))</span>
<span class="p">);</span>

<span class="nf">PrettyPrint</span><span class="p">(</span><span class="n">searchResponse</span><span class="p">);</span>
</code></pre></div></div>

<center>‚öôÔ∏èOutput: <b>Hybrid Search</b>
</center>

<center>
  <img src="/assets/hybrid-search-elastic/hybrid-query.png" style="margin: 15px;">
</center>

<h2 id="conclusion">Conclusion</h2>

<blockquote>
  <p>üôå I hope you found it helpful. If you have any questions, please feel free to reach out. If you‚Äôd like to support my work, a star on GitHub would be greatly appreciated! üôè</p>
</blockquote>

<h2 id="references">References</h2>

<ul>
  <li><a href="https://github.com/NikiforovAll/elasticsearch-dotnet-playground/tree/main/src/elasticsearch-getting-started" target="_blank" rel="noopener noreferrer">https://github.com/NikiforovAll/elasticsearch-dotnet-playground/tree/main/src/elasticsearch-getting-started</a></li>
  <li><a href="https://github.com/NikiforovAll/elasticsearch-dotnet-playground/blob/main/src/elasticsearch-getting-started/02-hybrid-search.ipynb" target="_blank" rel="noopener noreferrer">https://github.com/NikiforovAll/elasticsearch-dotnet-playground/blob/main/src/elasticsearch-getting-started/02-hybrid-search.ipynb</a></li>
  <li><a href="https://www.elastic.co/search-labs/tutorials/search-tutorial/welcome" target="_blank" rel="noopener noreferrer">https://www.elastic.co/search-labs/tutorials/search-tutorial/welcome</a></li>
  <li><a href="https://learn.microsoft.com/en-us/azure/search/hybrid-search-ranking" target="_blank" rel="noopener noreferrer">https://learn.microsoft.com/en-us/azure/search/hybrid-search-ranking</a></li>
</ul>

	</div>

	

	
	<ul class="list-inline">
		<li>
<i class="fa-solid fa-bookmark"></i> Topics:</li>
		
		
		
		<li>
			<a href="/topics.html#dotnet-cat-ref">
				dotnet <span>(58)</span>
			</a>
			 ¬∑
		</li>
		
		
		
		
		
		<li>
			<a href="/topics.html#dotnet-tag-ref">
				dotnet <span>(63)</span>
			</a>
			 ¬∑
		</li>
		
		<li>
			<a href="/topics.html#elasticsearch-tag-ref">
				elasticsearch <span>(3)</span>
			</a>
			 ¬∑
		</li>
		
		<li>
			<a href="/topics.html#search-tag-ref">
				search <span>(3)</span>
			</a>
			 ¬∑
		</li>
		
		<li>
			<a href="/topics.html#ai-tag-ref">
				ai <span>(26)</span>
			</a>
			
		</li>
		
		
		
	</ul>
	

	<hr>

	<div>
		<section class="share col-sm-6">
			<h4 class="section-title">Share Post</h4>
			<a class="btn btn-default btn-sm twitter" href="http://x.com/share?&amp;via=nikiforovall" onclick="window.open(this.href, 'x-share', 'width=550,height=235');return false;" target="_blank" rel="noopener noreferrer">
				<i class="fa-brands fa-x-twitter fa-lg"></i>
				X
			</a>
		</section>

		<section class="col-sm-6 author">
			<img src="//www.gravatar.com/avatar/e86fa0938976c38907a302ecb208f011" class="img-rounded author-image">
			<h4 class="section-title author-name">Oleksii Nikiforov</h4>
			<p class="author-bio">Jibber-jabbering about programming and IT.</p>
		</section>
	</div>

	<div class="clearfix"></div>

	<ul class="pager">
		
		<li class="previous"><a href="/dotnet/2024/10/20/querying-and-filtering-elastic-dotnet.html" title="Querying and Filtering via Elastic.Clients.Elasticsearch in .NET">‚Üê
				Previous</a></li>
		
		
		<li class="next">
<a href="/dotnet/2024/12/22/azd-bot-service.html" title="Deploy Your Bot to Azure in 5 Minutes with Azure Developer CLI (azd)">Next ‚Üí</a>
		</li>
		
	</ul>

	<hr>
	</div>

	<div class="col-sm-2 sidebar-2">

	</div>

</article>
<div class="clearfix"></div>



    
    <script src="https://utteranc.es/client.js" repo="NikiforovAll/nikiforovall.github.io" issue-term="pathname" label="Blog" theme="preferred-color-scheme" crossorigin="anonymous" async>
    </script>





		<footer>
			<hr>
			<p>
				¬© 2026 Oleksii Nikiforov with <a href="http://jekyllrb.com/" target="_blank" rel="noopener noreferrer">Jekyll</a>. Theme: <a href="https://github.com/dbtek/dbyll" target="_blank" rel="noopener noreferrer">dbyll</a> by dbtek.
			</p>
		</footer>
	</div>

	<script type="text/javascript" src="/assets/resources/jquery/jquery.min.js"></script>
	<script type="text/javascript" src="/assets/resources/bootstrap/js/bootstrap.min.js"></script>
	<script type="text/javascript" src="/assets/js/app.js"></script>
	<script src="https://unpkg.com/lunr/lunr.js"></script>
	<script type="text/javascript" src="/assets/js/search.js"></script>
	<script type="text/javascript" src="/assets/js/copy-code.js"></script>
	
		<script type="text/javascript" src="https://unpkg.com/mermaid@10.9.0/dist/mermaid.min.js">
</script>
<script>
$(document).ready(function() {
    mermaid.initialize({
        theme: 'forest'
    });
});
</script>

	
</body>
</html>



<!-- Asynchronous Google Analytics snippet -->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-164555539-1', 'auto');
  ga('send', 'pageview');
</script>

