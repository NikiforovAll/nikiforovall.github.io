<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<!-- <meta http-equiv="Content-Security-Policy" content="frame-src https://try.dot.net;"> -->
	<title>Add Authentication to MCP Servers using Microsoft Entra ID</title>
	
	<meta name="author" content="Oleksii Nikiforov">

	<!-- Enable responsive viewport -->
	<meta name="viewport" content="width=device-width, initial-scale=1.0">

	<!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
	<!--[if lt IE 9]>
	<script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
	<![endif]-->

	<!-- Le styles -->
	<link href="/assets/resources/bootstrap/css/bootstrap.min.css" rel="stylesheet">
	<link href="/assets/resources/font-awesome/css/font-awesome.min.css" rel="stylesheet">
	<link href="/assets/resources/syntax/syntax.css" rel="stylesheet">
	<link href="/assets/css/style.css" rel="stylesheet">

	<!-- Search Feature Styles -->
	<style>
		.search-trigger { position: fixed; top: 45px; right: 100px; z-index: 1000; display: flex; align-items: center; gap: 10px; padding: 6px 12px; background: #f5f5f5; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; min-width: 200px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); transition: all 0.15s ease; height: 34px; box-sizing: border-box; }
		.search-trigger:hover { background: #ebebeb; border-color: #c0c0c0; box-shadow: 0 2px 5px rgba(0,0,0,0.08); }
		.search-icon { color: #666; font-size: 14px; display: flex; align-items: center; }
		.search-placeholder { flex: 1; color: #999; font-size: 14px; user-select: none; }
		.search-keybind { display: flex; gap: 4px; align-items: center; }
		.search-key { font-family: 'Courier New', monospace; font-size: 11px; padding: 2px 6px; background: #e0e0e0; border: 1px solid #ccc; border-bottom: 2px solid #bbb; border-radius: 3px; color: #333; line-height: 1.2; box-shadow: 0 1px 1px rgba(0,0,0,0.1); }
		.search-modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: 10000; display: none; align-items: flex-start; justify-content: center; padding-top: 10vh; }
		.search-modal.open { display: flex; animation: fadeIn 0.2s ease; }
		@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
		.search-backdrop { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); backdrop-filter: blur(2px); }
		.search-modal-container { position: relative; width: 90%; max-width: 600px; background: white; border-radius: 8px; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3); overflow: hidden; }
		.search-input-container { display: flex; align-items: center; padding: 16px 20px; border-bottom: 1px solid #e0e0e0; gap: 12px; }
		.search-modal-icon { color: #666; font-size: 18px; }
		.search-modal-input { flex: 1; border: none; outline: none; font-size: 16px; color: #333; background: transparent; }
		.search-modal-input::placeholder { color: #999; }
		.search-close-btn { background: transparent; border: none; color: #999; font-size: 18px; cursor: pointer; padding: 4px 8px; border-radius: 4px; transition: all 0.15s ease; }
		.search-close-btn:hover { background: #f0f0f0; color: #333; }
		.search-results { max-height: 60vh; overflow-y: auto; padding: 8px; }
		.search-hint { padding: 40px 20px; text-align: center; color: #999; font-size: 14px; }
		.search-result-item { padding: 12px 16px; border-radius: 6px; cursor: pointer; transition: background-color 0.15s ease; border: 2px solid transparent; margin-bottom: 4px; }
		.search-result-item:hover { background: #f5f5f5; }
		.search-result-item.selected { background: #e8f4f8; border-color: #4a90e2; }
		.search-footer { display: flex; justify-content: center; gap: 20px; padding: 12px 20px; border-top: 1px solid #e0e0e0; background: #fafafa; font-size: 12px; color: #666; }
		.search-footer kbd { font-family: 'Courier New', monospace; font-size: 11px; padding: 2px 5px; background: white; border: 1px solid #ddd; border-radius: 3px; color: #333; box-shadow: 0 1px 1px rgba(0,0,0,0.1); }
	</style>

	<!-- Le fav and touch icons -->
	<!-- Update these with your own images
	<link rel="shortcut icon" href="images/favicon.ico">
	<link rel="apple-touch-icon" href="images/apple-touch-icon.png">
	<link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
	<link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
	-->
	<link rel="shortcut icon" href="/assets/media/favicon.ico">

	<link rel="alternate" type="application/rss+xml" title="" href="http://localhost:4000/feed.xml">
</head>

<body>
	<nav class="navbar navbar-default visible-xs" role="navigation">
		<!-- Brand and toggle get grouped for better mobile display -->
		<div class="navbar-header">
			<button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
				<span class="sr-only">Toggle navigation</span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</button>
			
			<a type="button" class="navbar-toggle nav-link" href="http://github.com/nikiforovAll" target="_blank" rel="noopener noreferrer">
				<i class="fa fa-github"></i>
			</a>
			
			
			<a type="button" class="navbar-toggle nav-link" href="http://twitter.com/nikiforovall" target="_blank" rel="noopener noreferrer">
				<i class="fa fa-twitter"></i>
			</a>
			
			
			<a type="button" class="navbar-toggle nav-link" href="mailto:alexey.nikiforovall@gmail.com">
				<i class="fa fa-envelope"></i>
			</a>
			
			<a class="navbar-brand" href="/">
				<img src="//www.gravatar.com/avatar/e86fa0938976c38907a302ecb208f011?s=35" class="img-circle">
				N+1 Blog
			</a>
		</div>

		<!-- Collect the nav links, forms, and other content for toggling -->
		<div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
			<ul class="nav navbar-nav">
				<li class="active"><a href="/">Home</a></li>
				<li><a href="/categories.html">Categories</a></li>
				<li><a href="/tags.html">Tags</a></li>
				<li><a href="/about.html">About</a></li>
			</ul>
		</div>
<!-- /.navbar-collapse -->
	</nav>

	<!-- nav-menu-dropdown -->
	<div class="btn-group hidden-xs" id="nav-menu">
		<button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">
			<i class="fa fa-bars"></i>
		</button>
		<ul class="dropdown-menu" role="menu">
			<li><a href="/"><i class="fa fa-home"></i>Home</a></li>
			<li><a href="/categories.html"><i class="fa fa-folder"></i>Categories</a></li>
			<li><a href="/tags.html"><i class="fa fa-tags"></i>Tags</a></li>
			<li><a href="/about.html"><i class="fa fa-pencil"></i>About</a></li>
			<li class="divider">
			<li><a href="#"><i class="fa fa-arrow-up"></i>Top of Page</a></li>
		</ul>
	</div>

	<!-- Search Control -->
	<div id="search-trigger" class="search-trigger">
		<span class="search-icon"><i class="fa fa-search"></i></span>
		<span class="search-placeholder">Search</span>
		<div class="search-keybind">
			<kbd class="search-key" id="search-modifier">ctrl</kbd>
			<kbd class="search-key">K</kbd>
		</div>
	</div>

	<!-- Search Modal -->
	<div id="search-modal" class="search-modal">
		<div class="search-backdrop"></div>
		<div class="search-modal-container">
			<div class="search-input-container">
				<i class="fa fa-search search-modal-icon"></i>
				<input type="text" id="search-input" class="search-modal-input" placeholder="Search blog posts..." autocomplete="off">
				<button id="search-close" class="search-close-btn" title="Close (ESC)">
					<i class="fa fa-times"></i>
				</button>
			</div>
			<div id="search-results" class="search-results">
				<div class="search-hint">Type at least 2 characters to search...</div>
			</div>
			<div class="search-footer">
				<span><kbd>‚Üë</kbd> <kbd>‚Üì</kbd> to navigate</span>
				<span><kbd>‚Üµ</kbd> to select</span>
				<span><kbd>ESC</kbd> to close</span>
			</div>
		</div>
	</div>

	<div class="col-sm-3 sidebar hidden-xs" style="">
		<!-- sidebar.html -->
<header class="sidebar-header" role="banner">
	<a href="/">
		<img src="//www.gravatar.com/avatar/e86fa0938976c38907a302ecb208f011?s=150" class="img-circle">
	</a>
	<h3 class="title">
        <a href="/">N+1 Blog</a>
    </h3>
</header>


<div id="bio" class="text-center">
	Jibber-jabbering about programming and IT.
</div>


<div id="contact-list" class="text-center">
	<ul class="list-unstyled list-inline">
		
		<li>
			<a class="btn btn-default btn-sm" href="https://github.com/nikiforovAll" target="_blank" rel="noopener noreferrer">
				<i class="fa fa-github-alt fa-lg"></i>
			</a>
		</li>
		
		
		<li>
			<a class="btn btn-default btn-sm" href="https://twitter.com/nikiforovall" target="_blank" rel="noopener noreferrer">
				<i class="fa fa-twitter fa-lg"></i>
			</a>
		</li>
		
		
		<li>
			<a class="btn btn-default btn-sm" href="https://t.me/nikiforovallblog" target="_blank" rel="noopener noreferrer">
				<i class="fa fa-pencil-square fa-lg"></i>
			</a>
		</li>
		
		
		<li>
			<a class="btn btn-default btn-sm" href="mailto:alexey.nikiforovall@gmail.com">
				<i class="fa fa-envelope fa-lg"></i>
			</a>
		</li>
		
	</ul>
	<ul id="contact-list-secondary" class="list-unstyled list-inline">
		
		
		<li>
			<a class="btn btn-default btn-sm" href="https://linkedin.com/in/nikiforov-oleksii" target="_blank" rel="noopener noreferrer">
				<i class="fa fa-linkedin fa-lg"></i>
			</a>
		</li>
		
		<li>
			<a class="btn btn-default btn-sm" href="/feed.xml">
				<i class="fa fa-rss fa-lg"></i>
			</a>
		</li>
	</ul>
</div>
<!-- sidebar.html end -->

	</div>

	<div class="col-sm-9 col-sm-offset-3">
		<div class="page-header">
	<h1>Add Authentication to MCP Servers using Microsoft Entra ID </h1>
</div>
<article>

	<div class="col-sm-10">

		<span class="post-date">
			
			September
			2nd,
			
			2025
		</span>

	
	
	
	

	

	
	

	

	
	<div>
		<h5><a href="/dotnet/ai/2025/11/11/dotnet-format-agent.html">Transform .NET Diagnostics into a Specialized AI Agent with Claude Agent SDK <span class="label label-default">dotnet</span>  <span class="label label-default">ai</span>  <span class="label label-default">mcp</span> </a></h5>
	</div>
	
	
	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	
	<div>
		<h5><a href="/dotnet/2025/05/29/hangfire-mcp-standalone.html">Hangfire MCP Server in Standalone Mode <span class="label label-default">dotnet</span>  <span class="label label-default">ai</span>  <span class="label label-default">mcp</span>  <span class="label label-default">mcp-server</span> </a></h5>
	</div>
	
	
	

	

	
	

	

	
	<div>
		<h5><a href="/dotnet/2025/05/25/hangfire-mcp.html">Background Job Scheduling Using Hangfire MCP Server <span class="label label-default">dotnet</span>  <span class="label label-default">ai</span>  <span class="label label-default">mcp</span>  <span class="label label-default">mcp-server</span> </a></h5>
	</div>
	
	
	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	
	<div>
		<h5><a href="/dotnet/2025/04/08/hybrid-mcp-template.html">Learn how to use Model Context Protocol (MCP) Server Template in Hybrid Mode <span class="label label-default">dotnet</span>  <span class="label label-default">ai</span>  <span class="label label-default">mcp</span>  <span class="label label-default">mcp-server</span> </a></h5>
	</div>
	
	
	
	

	<div class="article_body" style="margin-top: 30px;">
		<h2 id="tldr">TL;DR</h2>

<p>Learn how to add authentication to MCP servers using Microsoft Entra ID with a ready-to-use .NET template.</p>

<p><strong>Source code:</strong> <a href="https://github.com/NikiforovAll/mcp-template-dotnet" target="_blank" rel="noopener noreferrer">https://github.com/NikiforovAll/mcp-template-dotnet</a></p>

<h2 id="introduction">Introduction</h2>

<p>Without proper authentication, sensitive data and critical business operations become vulnerable to unauthorized access, potentially leading to security breaches, data leaks, and compliance violations. This fundamental security principle applies not only to traditional Web Applications and APIs but also extends to emerging technologies and protocols such as the <em>Model Context Protocol (MCP)</em>. Recently, the <a href="https://modelcontextprotocol.io/" target="_blank" rel="noopener noreferrer">MCP Specification</a> has been extended to include <strong>OAuth 2.1</strong> support. <a href="https://modelcontextprotocol.io/specification/draft/basic/authorization" target="_blank" rel="noopener noreferrer">This specification</a> defines the authorization flow for HTTP-based transports.</p>

<p>The <em>Model Context Protocol</em> provides authorization capabilities at the transport level, enabling MCP clients to make requests to restricted MCP servers on behalf of resource owners.</p>

<p>üí° It is a good idea to read the specification before you proceed with this blog post. But if you are short on time, take a look at the diagram below. It shows a sequence diagram of the authorization flow between an MCP client, an MCP server (resource server), and an authorization server.</p>

<div class="mermaid" style="margin-left:20%; margin-right:20%">
sequenceDiagram
    participant C as Client
    participant M as MCP Server (Resource Server)
    participant A as Authorization Server

    C-&gt;&gt;M: MCP request without token
    M--&gt;&gt;C: HTTP 401 Unauthorized with WWW-Authenticate header
    Note over C: Extract resource_metadata<br>from WWW-Authenticate

    C-&gt;&gt;M: GET /.well-known/oauth-protected-resource
    M--&gt;&gt;C: Resource metadata with authorization server URL
    Note over C: Validate RS metadata,<br>build AS metadata URL

    C-&gt;&gt;A: GET Authorization server metadata endpoint
    Note over C,A: Try OAuth 2.0 and OpenID Connect<br>discovery endpoints in priority order
    A--&gt;&gt;C: Authorization server metadata

    Note over C,A: OAuth 2.1 authorization flow happens here

    C-&gt;&gt;A: Token request
    A--&gt;&gt;C: Access token

    C-&gt;&gt;M: MCP request with access token
    M--&gt;&gt;C: MCP response
    Note over C,M: MCP communication continues with valid token
</div>

<p>What this means in practice is that every MCP server will now be able to provide this document in a well-known location: <code class="language-plaintext highlighter-rouge">https://my-mcp.io/.well-known/oauth-protected-resource</code></p>

<p>MCP clients are supposed to check for well-known <a href="https://datatracker.ietf.org/doc/html/rfc9728" target="_blank" rel="noopener noreferrer">OAuth 2.0 Protected Resource Metadata (RFC9728)</a> before making requests to MCP servers. This metadata will include information about the authorization servers that the MCP server trusts.</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"resource"</span><span class="p">:</span><span class="w"> </span><span class="s2">"https://localhost:7000"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"authorization_servers"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="s2">"https://login.microsoftonline.com/9763c9ca-4551-4032-b438-43a1397592e2/v2.0"</span><span class="w">
  </span><span class="p">],</span><span class="w">
  </span><span class="nl">"bearer_methods_supported"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="s2">"header"</span><span class="w">
  </span><span class="p">],</span><span class="w">
  </span><span class="nl">"scopes_supported"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="s2">"api://6ae92ebf-ab73-4722-afd8-042259671aee/Mcp.User"</span><span class="w">
  </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<h2 id="getting-started">Getting Started</h2>

<p>I‚Äôve prepared a <code class="language-plaintext highlighter-rouge">dotnet new</code> template that will help you quickly scaffold a new MCP Server project.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dotnet new <span class="nb">install </span>Nall.ModelContextProtocol.Template
<span class="c"># Template Name      Short Name         Language  Tags</span>
<span class="c"># -----------------  -----------------  --------  -------------</span>
<span class="c"># Template Name         Short Name            Language  Tags</span>
<span class="c"># --------------------  --------------------  --------  -------------</span>
<span class="c"># MCP Server            mcp-server            [C#]      dotnet/ai/mcp</span>
<span class="c"># MCP Server HTTP       mcp-server-http       [C#]      dotnet/ai/mcp</span>
<span class="c"># MCP Server HTTP Auth  mcp-server-http-auth  [C#]      dotnet/ai/mcp</span>
<span class="c"># MCP Server Hybrid     mcp-server-hybrid     [C#]      dotnet/ai/mcp</span>
</code></pre></div></div>

<p>Now, we can create a new MCP Server project using the template.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dotnet new mcp-server-http-auth <span class="nt">-n</span> McpAuth <span class="nt">-o</span> McpAuth
<span class="c"># The template "MCP Server HTTP Auth" was created successfully.</span>
</code></pre></div></div>

<p>Let‚Äôs take a look at <code class="language-plaintext highlighter-rouge">Program.cs</code>:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">var</span> <span class="n">builder</span> <span class="p">=</span> <span class="n">WebApplication</span><span class="p">.</span><span class="nf">CreateBuilder</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>

<span class="n">builder</span><span class="p">.</span><span class="n">Services</span><span class="p">.</span><span class="nf">AddHttpContextAccessor</span><span class="p">();</span>
<span class="n">builder</span><span class="p">.</span><span class="n">Services</span><span class="p">.</span><span class="n">AddScoped</span><span class="p">&lt;</span><span class="n">UserService</span><span class="p">&gt;();</span>

<span class="n">builder</span>
    <span class="p">.</span><span class="n">Services</span><span class="p">.</span><span class="nf">AddAuthentication</span><span class="p">(</span><span class="n">options</span> <span class="p">=&gt;</span>
    <span class="p">{</span>
        <span class="n">options</span><span class="p">.</span><span class="n">DefaultAuthenticateScheme</span> <span class="p">=</span> <span class="n">JwtBearerDefaults</span><span class="p">.</span><span class="n">AuthenticationScheme</span><span class="p">;</span>
        <span class="n">options</span><span class="p">.</span><span class="n">DefaultChallengeScheme</span> <span class="p">=</span> <span class="n">McpAuthenticationDefaults</span><span class="p">.</span><span class="n">AuthenticationScheme</span><span class="p">;</span>
    <span class="p">})</span>
    <span class="p">.</span><span class="nf">AddMcp</span><span class="p">(</span><span class="n">options</span> <span class="p">=&gt;</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">identityOptions</span> <span class="p">=</span> <span class="n">builder</span>
            <span class="p">.</span><span class="n">Configuration</span><span class="p">.</span><span class="nf">GetSection</span><span class="p">(</span><span class="s">"AzureAd"</span><span class="p">)</span>
            <span class="p">.</span><span class="n">Get</span><span class="p">&lt;</span><span class="n">MicrosoftIdentityOptions</span><span class="p">&gt;()!;</span>

        <span class="n">options</span><span class="p">.</span><span class="n">ResourceMetadata</span> <span class="p">=</span> <span class="k">new</span> <span class="n">ProtectedResourceMetadata</span>
        <span class="p">{</span>
            <span class="n">Resource</span> <span class="p">=</span> <span class="nf">GetMcpServerUrl</span><span class="p">(),</span>
            <span class="n">AuthorizationServers</span> <span class="p">=</span> <span class="p">[</span><span class="nf">GetAuthorizationServerUrl</span><span class="p">(</span><span class="n">identityOptions</span><span class="p">)],</span>
            <span class="n">ScopesSupported</span> <span class="p">=</span> <span class="p">[</span><span class="s">$"api://</span><span class="p">{</span><span class="n">identityOptions</span><span class="p">.</span><span class="n">ClientId</span><span class="p">}</span><span class="s">/Mcp.User"</span><span class="p">],</span>
        <span class="p">};</span>
    <span class="p">})</span>
    <span class="p">.</span><span class="nf">AddMicrosoftIdentityWebApi</span><span class="p">(</span><span class="n">builder</span><span class="p">.</span><span class="n">Configuration</span><span class="p">.</span><span class="nf">GetSection</span><span class="p">(</span><span class="s">"AzureAd"</span><span class="p">));</span>

<span class="n">builder</span><span class="p">.</span><span class="n">Services</span><span class="p">.</span><span class="nf">AddMcpServer</span><span class="p">().</span><span class="nf">WithToolsFromAssembly</span><span class="p">().</span><span class="nf">WithHttpTransport</span><span class="p">();</span>

<span class="kt">var</span> <span class="n">app</span> <span class="p">=</span> <span class="n">builder</span><span class="p">.</span><span class="nf">Build</span><span class="p">();</span>

<span class="n">app</span><span class="p">.</span><span class="nf">UseAuthentication</span><span class="p">();</span>
<span class="n">app</span><span class="p">.</span><span class="nf">UseAuthorization</span><span class="p">();</span>

<span class="n">app</span><span class="p">.</span><span class="nf">MapMcp</span><span class="p">().</span><span class="nf">RequireAuthorization</span><span class="p">();</span>

<span class="c1">// Run the web server</span>
<span class="n">app</span><span class="p">.</span><span class="nf">Run</span><span class="p">();</span>

<span class="c1">// Helper method to get authorization server URL</span>
<span class="k">static</span> <span class="n">Uri</span> <span class="nf">GetAuthorizationServerUrl</span><span class="p">(</span><span class="n">MicrosoftIdentityOptions</span> <span class="n">o</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="k">new</span><span class="p">(</span><span class="s">$"</span><span class="p">{</span><span class="n">o</span><span class="p">.</span><span class="n">Instance</span><span class="p">?.</span><span class="nf">TrimEnd</span><span class="p">(</span><span class="sc">'/'</span><span class="p">)}</span><span class="s">/</span><span class="p">{</span><span class="n">o</span><span class="p">.</span><span class="n">TenantId</span><span class="p">}</span><span class="s">/v2.0"</span><span class="p">);</span>
<span class="n">Uri</span> <span class="nf">GetMcpServerUrl</span><span class="p">()</span> <span class="p">=&gt;</span> <span class="n">builder</span><span class="p">.</span><span class="n">Configuration</span><span class="p">.</span><span class="n">GetValue</span><span class="p">&lt;</span><span class="n">Uri</span><span class="p">&gt;(</span><span class="s">"McpServerUrl"</span><span class="p">);</span>
</code></pre></div></div>

<p>As you can see, this project template uses <code class="language-plaintext highlighter-rouge">Microsoft.Identity.Web</code> to authenticate users with Microsoft Entra ID (formerly Microsoft Active Directory). The interesting part here is the use of <code class="language-plaintext highlighter-rouge">McpAuthenticationDefaults</code> to configure the <code class="language-plaintext highlighter-rouge">DefaultChallengeScheme</code>. This is a special scheme that is used to challenge a user and MCP Client for credentials.</p>

<p>‚òùÔ∏è As a developer, you don‚Äôt even need to know how this works under the hood. All you need to do is to carefully configure all components:</p>

<ol>
  <li>
<code class="language-plaintext highlighter-rouge">McpAuthenticationHandler : AuthenticationHandler&lt;McpAuthenticationOptions&gt;, IAuthenticationRequestHandler</code> by using <code class="language-plaintext highlighter-rouge">Microsoft.AspNetCore.Authentication.AuthenticationBuilder.AddMcp</code> method.</li>
  <li>
<code class="language-plaintext highlighter-rouge">ProtectedResourceMetadata</code> is used to describe the protected resource that the MCP server exposes, including its URL, the authorization servers it trusts, and the scopes it supports.</li>
  <li>
<code class="language-plaintext highlighter-rouge">DefaultChallengeScheme</code> as <code class="language-plaintext highlighter-rouge">McpAuthenticationDefaults.AuthenticationScheme</code>. Thus, the ‚Äúdance‚Äù of OAuth 2.1 begins.</li>
</ol>

<h3 id="configure-microsoft-entra-id">Configure Microsoft Entra ID</h3>

<p>As you may have noticed, the configuration relies on <code class="language-plaintext highlighter-rouge">MicrosoftIdentityOptions</code>. When you call <code class="language-plaintext highlighter-rouge">AddMicrosoftIdentityWebApi</code>, it automatically adds them to the DI based on configuration.</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"AzureAd"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"Instance"</span><span class="p">:</span><span class="w"> </span><span class="s2">"https://login.microsoftonline.com/"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"Domain"</span><span class="p">:</span><span class="w"> </span><span class="s2">"t4mwx.onmicrosoft.com"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"TenantId"</span><span class="p">:</span><span class="w"> </span><span class="s2">"9763c9ca-4551-4032-b438-43a1397592e2"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"ClientId"</span><span class="p">:</span><span class="w"> </span><span class="s2">"6ae92ebf-ab73-4722-afd8-042259671aee"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"ClientSecret"</span><span class="p">:</span><span class="w"> </span><span class="s2">"&lt;my_very_secure_secret&gt;"</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>To get them, you will need to create App Registrations in Azure AD.</p>

<ol>
  <li>Go to Azure and click ‚Äú+New Registration‚Äù</li>
  <li>Specify ‚ÄúName‚Äù and ‚ÄúSupported account types‚Äù.</li>
  <li>Add Single-page redirect URLs: <a href="https://localhost:7000/">https://localhost:7000/</a> and create a new app.</li>
  <li>Generate a secret by using the ‚ÄúCertificates &amp; secrets‚Äù tab.</li>
  <li>Click ‚ÄúExpose an API‚Äù and add a new scope called <code class="language-plaintext highlighter-rouge">Mcp.Read</code>.</li>
  <li>Add Pre-Authorized Applications. This is the well-known ID of VSCode - ‚Äúea5a67f6-b6f3-4338-b240-c655ddc3cc8e‚Äù. Note: if you want to support additional applications, you will need to add their client IDs here.</li>
</ol>

<center><img src="/assets/mcp-auth/app-registration.png" style="margin-bottom: 2rem;"></center>

<h3 id="demo">Demo</h3>

<p>Create a <code class="language-plaintext highlighter-rouge">.vscode/mcp.json</code> with the following content and run the ‚ÄúEcho‚Äù MCP Server:</p>

<center>
    <video src="https://github.com/user-attachments/assets/8cb012ef-50cb-45ce-9e4c-e16414bc562c" width="100%" controls="controls"></video>
</center>

<hr>

<p>As you can see, we were able to authenticate to Microsoft Entra ID and obtain an access token for the MCP server. The user‚Äôs identity was successfully retrieved from the access token using <code class="language-plaintext highlighter-rouge">UserService</code>.</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">class</span> <span class="nc">UserService</span><span class="p">(</span><span class="n">IHttpContextAccessor</span> <span class="n">httpContextAccessor</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="kt">string</span><span class="p">?</span> <span class="n">UserName</span> <span class="p">=&gt;</span> <span class="n">httpContextAccessor</span><span class="p">.</span><span class="n">HttpContext</span><span class="p">?.</span><span class="n">User</span><span class="p">.</span><span class="n">Identity</span><span class="p">?.</span><span class="n">Name</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>And the <code class="language-plaintext highlighter-rouge">EchoTool</code> with injected <code class="language-plaintext highlighter-rouge">UserService</code>:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">/// &lt;summary&gt;</span>
<span class="c1">/// This is a simple tool that echoes the message back to the client.</span>
<span class="c1">/// &lt;/summary&gt;</span>
<span class="p">[</span><span class="n">McpServerToolType</span><span class="p">]</span>
<span class="k">public</span> <span class="k">class</span> <span class="nc">EchoTool</span><span class="p">(</span><span class="n">UserService</span> <span class="n">userService</span><span class="p">)</span>
<span class="p">{</span>
    <span class="p">[</span><span class="nf">McpServerTool</span><span class="p">(</span>
        <span class="n">Name</span> <span class="p">=</span> <span class="s">"Echo"</span><span class="p">,</span>
        <span class="n">Title</span> <span class="p">=</span> <span class="s">"Echoes the message back to the client."</span><span class="p">,</span>
        <span class="n">UseStructuredContent</span> <span class="p">=</span> <span class="k">true</span>
    <span class="p">)]</span>
    <span class="p">[</span><span class="nf">Description</span><span class="p">(</span><span class="s">"This tool echoes the message back to the client."</span><span class="p">)]</span>
    <span class="k">public</span> <span class="n">EchoResponse</span> <span class="nf">Echo</span><span class="p">(</span><span class="kt">string</span> <span class="n">message</span><span class="p">)</span> <span class="p">=&gt;</span>
        <span class="k">new</span><span class="p">(</span><span class="s">$"hello </span><span class="p">{</span><span class="n">message</span><span class="p">}</span><span class="s"> from </span><span class="p">{</span><span class="n">userService</span><span class="p">.</span><span class="n">UserName</span><span class="p">}</span><span class="s">"</span><span class="p">,</span> <span class="n">userService</span><span class="p">.</span><span class="n">UserName</span><span class="p">!);</span>
<span class="p">}</span>
<span class="k">public</span> <span class="k">record</span> <span class="nc">EchoResponse</span><span class="p">(</span><span class="kt">string</span> <span class="n">Message</span><span class="p">,</span> <span class="kt">string</span> <span class="n">UserName</span><span class="p">);</span>

</code></pre></div></div>

<h2 id="references">References</h2>

<ul>
  <li><a href="https://github.com/NikiforovAll/mcp-template-dotnet" target="_blank" rel="noopener noreferrer">https://github.com/NikiforovAll/mcp-template-dotnet</a></li>
  <li><a href="https://modelcontextprotocol.io/specification/draft/basic/authorization" target="_blank" rel="noopener noreferrer">https://modelcontextprotocol.io/specification/draft/basic/authorization</a></li>
  <li><a href="https://den.dev/blog/mcp-prm-auth/" target="_blank" rel="noopener noreferrer">https://den.dev/blog/mcp-prm-auth/</a></li>
  <li><a href="https://den.dev/blog/mcp-csharp-sdk-authorization/" target="_blank" rel="noopener noreferrer">https://den.dev/blog/mcp-csharp-sdk-authorization/</a></li>
  <li><a href="https://github.com/modelcontextprotocol/csharp-sdk/blob/main/samples/ProtectedMcpServer/Program.cs" target="_blank" rel="noopener noreferrer">https://github.com/modelcontextprotocol/csharp-sdk/blob/main/samples/ProtectedMcpServer/Program.cs</a></li>
  <li><a href="https://www.youtube.com/watch?v=EXxIeOfJsqA&amp;ab_channel=MicrosoftDeveloper" target="_blank" rel="noopener noreferrer">https://www.youtube.com/watch?v=EXxIeOfJsqA&amp;ab_channel=MicrosoftDeveloper</a></li>
</ul>

	</div>

	

	
	<ul class="tag_box list-unstyled list-inline">
		<li><i class="fa fa-folder-open"></i></li>
		
		
		
		<li><a href="/categories.html#dotnet-ref">
				dotnet <span>(58)</span>
				
			</a></li>
		
		
	</ul>
	

	
	<ul class="list-inline">
		<li><i class="fa fa-tags"></i></li>
		
		
		
		<li>
			<a href="/tags.html#dotnet-ref">
				dotnet <span>(63)</span>
				,
			</a>
		</li>
		
		<li>
			<a href="/tags.html#ai-ref">
				ai <span>(22)</span>
				,
			</a>
		</li>
		
		<li>
			<a href="/tags.html#mcp-ref">
				mcp <span>(9)</span>
				,
			</a>
		</li>
		
		<li>
			<a href="/tags.html#mcp-server-ref">
				mcp-server <span>(6)</span>
				
			</a>
		</li>
		
		
		
	</ul>
	

	<hr>

	<div>
		<section class="share col-sm-6">
			<h4 class="section-title">Share Post</h4>
			<a class="btn btn-default btn-sm twitter" href="http://twitter.com/share?&amp;via=nikiforovall" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;" target="_blank" rel="noopener noreferrer">
				<i class="fa fa-twitter fa-lg"></i>
				Twitter
			</a>
		</section>

		<section class="col-sm-6 author">
			<img src="//www.gravatar.com/avatar/e86fa0938976c38907a302ecb208f011" class="img-rounded author-image">
			<h4 class="section-title author-name">Oleksii Nikiforov</h4>
			<p class="author-bio">Jibber-jabbering about programming and IT.</p>
		</section>
	</div>

	<div class="clearfix"></div>

	<ul class="pager">
		
		<li class="previous"><a href="/ai/2025/08/09/tech-debt-master.html" title="Introducing Technical Debt Master: AI-Powered Code Analysis with Local LLMs">‚Üê
				Previous</a></li>
		
		
		<li class="next">
<a href="/ai/2025/09/06/playwright-claude-code-testing.html" title="Testing with Playwright and Claude Code">Next ‚Üí</a>
		</li>
		
	</ul>

	<hr>
	</div>

	<div class="col-sm-2 sidebar-2">

	</div>

</article>
<div class="clearfix"></div>



    
    <script src="https://utteranc.es/client.js" repo="NikiforovAll/nikiforovall.github.io" issue-term="pathname" label="Blog" theme="preferred-color-scheme" crossorigin="anonymous" async>
    </script>





		<footer>
			<hr>
			<p>
				¬© 2025 Oleksii Nikiforov with <a href="http://jekyllrb.com/" target="_blank" rel="noopener noreferrer">Jekyll</a>. Theme: <a href="https://github.com/dbtek/dbyll" target="_blank" rel="noopener noreferrer">dbyll</a> by dbtek.
			</p>
		</footer>
	</div>

	<script type="text/javascript" src="/assets/resources/jquery/jquery.min.js"></script>
	<script type="text/javascript" src="/assets/resources/bootstrap/js/bootstrap.min.js"></script>
	<script type="text/javascript" src="/assets/js/app.js"></script>
	<script src="https://unpkg.com/lunr/lunr.js"></script>
	<script type="text/javascript" src="/assets/js/search.js"></script>
	
		<script type="text/javascript" src="https://unpkg.com/mermaid@10.9.0/dist/mermaid.min.js">
</script>
<script>
$(document).ready(function() {
    mermaid.initialize({
        theme: 'forest'
    });
});
</script>

	
</body>
</html>



<!-- Asynchronous Google Analytics snippet -->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-164555539-1', 'auto');
  ga('send', 'pageview');
</script>

