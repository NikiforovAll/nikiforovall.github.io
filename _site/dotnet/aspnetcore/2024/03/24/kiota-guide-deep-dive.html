<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<title>A Guide to OpenAPI Client Generation with Kiota. Deep dive (Part 2) | N+1 Blog</title>

	<!-- Meta Description -->
	
	<meta name="description" content="This post provides a deep dive into OpenAPI client generation with Kiota, covering topics such as SDK generation, dependency injection, typed HTTP clients, cross-cutting concerns, and testing.">
	

	<meta name="author" content="Oleksii Nikiforov">

	<!-- Canonical URL -->
	<link rel="canonical" href="http://localhost:4000/dotnet/aspnetcore/2024/03/24/kiota-guide-deep-dive.html">

	<!-- Open Graph -->
	<meta property="og:title" content="A Guide to OpenAPI Client Generation with Kiota. Deep dive (Part 2)">
	<meta property="og:description" content="This post provides a deep dive into OpenAPI client generation with Kiota, covering topics such as SDK generation, dependency injection, typed HTTP clients, cross-cutting concerns, and testing.">
	<meta property="og:url" content="http://localhost:4000/dotnet/aspnetcore/2024/03/24/kiota-guide-deep-dive.html">
	<meta property="og:site_name" content="N+1 Blog">
	<meta property="og:type" content="article">
	
	<meta property="article:published_time" content="2024-03-24T00:00:00+02:00">
	
	<meta property="og:image" content="http://localhost:4000/assets/media/default-post-image.png">

	<!-- Twitter Card -->
	<meta name="twitter:card" content="summary_large_image">
	<meta name="twitter:site" content="@nikiforovall">
	<meta name="twitter:title" content="A Guide to OpenAPI Client Generation with Kiota. Deep dive (Part 2)">
	<meta name="twitter:description" content="This post provides a deep dive into OpenAPI client generation with Kiota, covering topics such as SDK generation, dependency injection, typed HTTP clients, cross-cutting concerns, and testing.">
	<meta name="twitter:image" content="http://localhost:4000/assets/media/default-post-image.png">

	<!-- Enable responsive viewport -->
	<meta name="viewport" content="width=device-width, initial-scale=1.0">

	<!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
	<!--[if lt IE 9]>
	<script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
	<![endif]-->

	<!-- Le styles -->
	<link href="/assets/resources/bootstrap/css/bootstrap.min.css" rel="stylesheet">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" integrity="sha512-Evv84Mr4kqVGRNSgIGL/F/aIDqQb7xQ2vcrdIwxfjThSH8CSR7PBEakCr51Ck+w+/U6swU2Im1vVX0SVk9ABhg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
	<link href="/assets/resources/syntax/syntax.css" rel="stylesheet">
	<link href="/assets/css/style.css" rel="stylesheet">

	<!-- Search Feature Styles -->
	<style>
		.layout-page .search-trigger { position: fixed; top: 45px; right: 100px; z-index: 1000; display: flex; align-items: center; gap: 10px; padding: 6px 12px; background: #f5f5f5; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; min-width: 220px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); transition: all 0.15s ease; height: 34px; box-sizing: border-box; }
		.layout-post .search-trigger { position: fixed; top: 45px; right: 100px; z-index: 1000; display: flex; align-items: center; justify-content: center; padding: 0; background: #f5f5f5; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; width: 34px; height: 34px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); transition: all 0.15s ease; box-sizing: border-box; }
		.search-trigger:hover { background: #ebebeb; border-color: #c0c0c0; box-shadow: 0 2px 5px rgba(0,0,0,0.08); }
		.search-icon { color: #666; font-size: 14px; display: flex; align-items: center; }
		.search-placeholder { flex: 1; color: #999; font-size: 14px; user-select: none; }
		.search-keybind { display: flex; gap: 4px; align-items: center; }
		.search-key { font-family: 'Courier New', monospace; font-size: 11px; padding: 2px 6px; background: #e0e0e0; border: 1px solid #ccc; border-bottom: 2px solid #bbb; border-radius: 3px; color: #333; line-height: 1.2; box-shadow: 0 1px 1px rgba(0,0,0,0.1); }
		.layout-post .search-placeholder { display: none; }
		.layout-post .search-keybind { display: none; }
		.search-modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: 10000; display: none; align-items: flex-start; justify-content: center; padding-top: 10vh; }
		.search-modal.open { display: flex; animation: fadeIn 0.2s ease; }
		@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
		.search-backdrop { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); backdrop-filter: blur(2px); }
		.search-modal-container { position: relative; width: 90%; max-width: 600px; background: white; border-radius: 8px; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3); overflow: hidden; }
		.search-input-container { display: flex; align-items: center; padding: 16px 20px; border-bottom: 1px solid #e0e0e0; gap: 12px; }
		.search-modal-icon { color: #666; font-size: 18px; }
		.search-modal-input { flex: 1; border: none; outline: none; font-size: 16px; color: #333; background: transparent; }
		.search-modal-input::placeholder { color: #999; }
		.search-close-btn { background: transparent; border: none; color: #999; font-size: 18px; cursor: pointer; padding: 4px 8px; border-radius: 4px; transition: all 0.15s ease; }
		.search-close-btn:hover { background: #f0f0f0; color: #333; }
		.search-results { max-height: 60vh; overflow-y: auto; padding: 8px; }
		.search-hint { padding: 40px 20px; text-align: center; color: #999; font-size: 14px; }
		.search-result-item { padding: 12px 16px; border-radius: 6px; cursor: pointer; transition: background-color 0.15s ease; border: 2px solid transparent; margin-bottom: 4px; }
		.search-result-item:hover { background: #f5f5f5; }
		.search-result-item.selected { background: #e8f4f8; border-color: #4a90e2; }
		.search-footer { display: flex; justify-content: center; gap: 20px; padding: 12px 20px; border-top: 1px solid #e0e0e0; background: #fafafa; font-size: 12px; color: #666; }
		.search-footer kbd { font-family: 'Courier New', monospace; font-size: 11px; padding: 2px 5px; background: white; border: 1px solid #ddd; border-radius: 3px; color: #333; box-shadow: 0 1px 1px rgba(0,0,0,0.1); }
		@media (max-width: 768px) { .layout-page .search-trigger, .layout-post .search-trigger { display: none; } .search-modal { padding-top: 5vh; } .search-modal-container { width: 95%; max-width: none; margin: 0 10px; } .search-results { max-height: 50vh; } .search-footer { flex-wrap: wrap; gap: 10px; } }
	</style>

	<!-- Le fav and touch icons -->
	<!-- Update these with your own images
	<link rel="shortcut icon" href="images/favicon.ico">
	<link rel="apple-touch-icon" href="images/apple-touch-icon.png">
	<link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
	<link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
	-->
	<link rel="shortcut icon" href="/assets/media/favicon.ico">

	<link rel="alternate" type="application/rss+xml" title="" href="http://localhost:4000/feed.xml">

	
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "A Guide to OpenAPI Client Generation with Kiota. Deep dive (Part 2)",
  
  
  "description": "This post provides a deep dive into OpenAPI client generation with Kiota, covering topics such as SDK generation, dependency injection, typed HTTP clients, cross-cutting concerns, and testing.",
  
  "image": ["http://localhost:4000/assets/media/default-post-image.png"],
  "datePublished": "2024-03-24T00:00:00+02:00",
  "dateModified": "2024-03-24T00:00:00+02:00",
  "author": {
    "@type": "Person",
    "name": "Oleksii Nikiforov",
    "url": "http://localhost:4000/about.html",
    "sameAs": [
      "https://github.com/nikiforovAll",
      "https://twitter.com/nikiforovall",
      "https://www.linkedin.com/in/nikiforov-oleksii",
      "https://t.me/nikiforovallblog"
    ]
  },
  "publisher": {
    "@type": "Person",
    "name": "Oleksii Nikiforov",
    "logo": {
      "@type": "ImageObject",
      "url": "https://www.gravatar.com/avatar/e86fa0938976c38907a302ecb208f011?s=200"
    }
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "http://localhost:4000/dotnet/aspnetcore/2024/03/24/kiota-guide-deep-dive.html"
  },
  
  "articleSection": "dotnet",
  
  
  "keywords": "dotnet, aspnetcore, openapi, aspire, cli",
  
  "inLanguage": "en-US"
}
</script>


</head>

<body class="layout-post">
	<nav class="navbar navbar-default visible-xs" role="navigation">
		<!-- Brand and toggle get grouped for better mobile display -->
		<div class="navbar-header">
			<button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
				<span class="sr-only">Toggle navigation</span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</button>
			
			<a type="button" class="navbar-toggle nav-link" href="http://github.com/nikiforovAll" target="_blank" rel="noopener noreferrer noopener noreferrer">
				<i class="fa-brands fa-github"></i>
			</a>
			
			
			<a type="button" class="navbar-toggle nav-link" href="http://x.com/nikiforovall" target="_blank" rel="noopener noreferrer noopener noreferrer">
				<i class="fa-brands fa-x-twitter"></i>
			</a>
			
			
			<a type="button" class="navbar-toggle nav-link" href="mailto:alexey.nikiforovall@gmail.com">
				<i class="fa-solid fa-envelope"></i>
			</a>
			
			<a class="navbar-brand" href="/">
				<img src="//www.gravatar.com/avatar/e86fa0938976c38907a302ecb208f011?s=35" class="img-circle">
				N+1 Blog
			</a>
		</div>

		<!-- Collect the nav links, forms, and other content for toggling -->
		<div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
			<ul class="nav navbar-nav">
				<li class="active"><a href="/">Home</a></li>
				<li><a href="/topics.html">Topics</a></li>
				<li><a href="/about.html">About</a></li>
			</ul>
		</div>
<!-- /.navbar-collapse -->
	</nav>

	<!-- nav-menu-dropdown -->
	<div class="btn-group hidden-xs" id="nav-menu">
		<button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">
			<i class="fa-solid fa-bars"></i>
		</button>
		<ul class="dropdown-menu" role="menu">
			<li><a href="/"><i class="fa-solid fa-home"></i>Home</a></li>
			<li><a href="/topics.html"><i class="fa-solid fa-bookmark"></i>Topics</a></li>
			<li><a href="/about.html"><i class="fa-solid fa-pencil"></i>About</a></li>
			<li class="divider">
			<li><a href="#"><i class="fa-solid fa-arrow-up"></i>Top of Page</a></li>
		</ul>
	</div>

	<!-- Search Control -->
	<button id="search-trigger" class="search-trigger" type="button" aria-label="Open search">
		<span class="search-icon"><i class="fa-solid fa-search"></i></span>
		<span class="search-placeholder">Search</span>
		<div class="search-keybind">
			<kbd class="search-key" id="search-modifier">ctrl</kbd>
			<kbd class="search-key">K</kbd>
		</div>
	</button>

	<!-- Search Modal -->
	<div id="search-modal" class="search-modal">
		<div class="search-backdrop"></div>
		<div class="search-modal-container">
			<div class="search-input-container">
				<i class="fa-solid fa-search search-modal-icon"></i>
				<input type="text" id="search-input" class="search-modal-input" placeholder="Search blog posts..." autocomplete="off">
				<button id="search-close" class="search-close-btn" title="Close (ESC)">
					<i class="fa-solid fa-times"></i>
				</button>
			</div>
			<div id="search-results" class="search-results">
				<div class="search-hint">Type at least 2 characters to search...</div>
			</div>
			<div class="search-footer">
				<span><kbd>â†‘</kbd> <kbd>â†“</kbd> to navigate</span>
				<span><kbd>â†µ</kbd> to select</span>
				<span><kbd>ESC</kbd> to close</span>
			</div>
		</div>
	</div>

	<div class="col-sm-3 sidebar hidden-xs" style="">
		<!-- sidebar.html -->
<header class="sidebar-header" role="banner">
	<a href="/">
		<img src="//www.gravatar.com/avatar/e86fa0938976c38907a302ecb208f011?s=150" class="img-circle">
	</a>
	<h3 class="title">
        <a href="/">N+1 Blog</a>
    </h3>
</header>


<div id="bio" class="text-center">
	Jibber-jabbering about programming and IT.
</div>


<div id="contact-list" class="text-center">
	<ul class="list-unstyled list-inline">
		
		<li>
			<a class="btn btn-default btn-sm" href="https://github.com/nikiforovAll" target="_blank" rel="noopener noreferrer noopener noreferrer">
				<i class="fa-brands fa-github fa-lg"></i>
			</a>
		</li>
		
		
		<li>
			<a class="btn btn-default btn-sm" href="https://x.com/nikiforovall" target="_blank" rel="noopener noreferrer noopener noreferrer">
				<i class="fa-brands fa-x-twitter fa-lg"></i>
			</a>
		</li>
		
		
		<li>
			<a class="btn btn-default btn-sm" href="https://t.me/nikiforovallblog" target="_blank" rel="noopener noreferrer noopener noreferrer">
				<i class="fa-brands fa-telegram fa-lg"></i>
			</a>
		</li>
		
		
		<li>
			<a class="btn btn-default btn-sm" href="https://linkedin.com/in/nikiforov-oleksii" target="_blank" rel="noopener noreferrer noopener noreferrer">
				<i class="fa-brands fa-linkedin fa-lg"></i>
			</a>
		</li>
		
	</ul>
	<ul id="contact-list-secondary" class="list-unstyled list-inline">
		
		<li>
			<a class="btn btn-default btn-sm" href="mailto:alexey.nikiforovall@gmail.com">
				<i class="fa-solid fa-envelope fa-lg"></i>
			</a>
		</li>
		
		<li>
			<a class="btn btn-default btn-sm" href="/feed.xml" target="_blank" rel="noopener noreferrer">
				<i class="fa-solid fa-rss fa-lg"></i>
			</a>
		</li>
	</ul>
</div>
<!-- sidebar.html end -->

	</div>

	<div class="col-sm-9 col-sm-offset-3">
		<div class="page-header">
	<h1>A Guide to OpenAPI Client Generation with Kiota. Deep dive (Part 2) </h1>
</div>
<article>

	<div class="col-sm-10">

		<span class="post-date">
			
			March
			24th,
			
			2024
		</span>

	
	
	
	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	
	<div>
		<h5><a href="/dotnet/aspire/2024/06/28/startup-dependencies-aspire.html">Managing Startup Dependencies in .NET Aspire <span class="label label-default">dotnet</span>  <span class="label label-default">aspnetcore</span>  <span class="label label-default">aspire</span> </a></h5>
	</div>
	
	
	

	

	
	

	

	
	<div>
		<h5><a href="/dotnet/aspire/2024/06/18/polyglot-persistance-with-aspire.html">Learn .NET Aspire by example: Polyglot persistence featuring PostgreSQL, Redis, MongoDB, and Elasticsearch <span class="label label-default">dotnet</span>  <span class="label label-default">aspnetcore</span>  <span class="label label-default">aspire</span> </a></h5>
	</div>
	
	
	

	

	
	

	

	
	<div>
		<h5><a href="/dotnet/opentelemetry/2024/06/12/developer-guide-to-xunit-otel.html">A .NET Developer Guide to XUnit Test Instrumentation with OpenTelemetry and Aspire Dashboard <span class="label label-default">dotnet</span>  <span class="label label-default">aspnetcore</span>  <span class="label label-default">aspire</span> </a></h5>
	</div>
	
	
	

	

	
	

	

	
	<div>
		<h5><a href="/dotnet/opentelemetry/2024/06/07/test-instrumentation-with-otel-aspire.html">Automated Tests instrumentation via OpenTelemetry and Aspire Dashboard <span class="label label-default">dotnet</span>  <span class="label label-default">aspnetcore</span>  <span class="label label-default">aspire</span> </a></h5>
	</div>
	
	
	
	

	<div class="article_body" style="margin-top: 30px;">
		<blockquote>
  <p>Source code: <a href="https://github.com/NikiforovAll/kiota-getting-started" target="_blank" rel="noopener noreferrer">https://github.com/NikiforovAll/kiota-getting-started</a></p>
</blockquote>

<hr>
<p><em>Table of Contents</em>:</p>

<ul>
  <li><a href="#introduction">Introduction</a></li>
  <li><a href="#setup">Setup</a></li>
  <li>
<a href="#generate-http-client-for-aspnet-core-applications">Generate HTTP Client for ASP.NET Core applications</a>
    <ul>
      <li><a href="#generate-openapi-specification-automatically">Generate OpenAPI specification automatically</a></li>
      <li><a href="#use-openapi-specification">Use OpenAPI Specification</a></li>
      <li><a href="#demo">Demo</a></li>
    </ul>
  </li>
  <li><a href="#dependency-injection-typed-http-clients-and-ihttpclientfactory">Dependency Injection, Typed HTTP Clients, and <code class="language-plaintext highlighter-rouge">IHttpClientFactory</code></a></li>
  <li><a href="#cross-cutting-concerns-and-resilience">Cross-Cutting Concerns and Resilience</a></li>
  <li><a href="#testing">Testing</a></li>
  <li><a href="#conclusion">Conclusion</a></li>
  <li><a href="#references">References</a></li>
</ul>

<h2 id="introduction">Introduction</h2>

<p>In the <a href="https://nikiforovall.github.io/dotnet/aspnetcore/2024/03/22/kiota-guide-introduction.html" target="_blank" rel="noopener noreferrer">previous blog post</a>, we learned the basics of <strong>Kiota</strong>. In this post, I want to share more details on how to apply it in production scenarios in a more sophisticated manner.</p>

<p>I will show you the following aspects of successful SDK development:</p>

<ul>
  <li>Generation of SDKs for ASP.NET Core applications</li>
  <li>Dependency Injection, Typed HTTP Clients, and <code class="language-plaintext highlighter-rouge">IHttpClientFactory</code>
</li>
  <li>Cross-Cutting Concerns</li>
  <li>Testing</li>
</ul>

<h2 id="setup">Setup</h2>

<p>We want to create an <code class="language-plaintext highlighter-rouge">App.Client</code> API project that calls the <code class="language-plaintext highlighter-rouge">App</code> trending API, which weâ€™ve built in a previous post. We will use .NET Aspire to glue everything together.</p>

<p>Aspire is a powerful library for .NET applications that simplifies the process of service discovery, configuration, and registration. It provides a set of tools and abstractions that allow developers to easily connect their services and clients in a decoupled manner.</p>

<p>In the context of our <code class="language-plaintext highlighter-rouge">App.Client</code> API project, we can use Aspire to automatically discover and register the <code class="language-plaintext highlighter-rouge">App</code> trending API. This means that our client application doesnâ€™t need to know the exact location or configuration of the <code class="language-plaintext highlighter-rouge">App</code> API - Aspire will handle this for us.</p>

<div class="mermaid">
graph LR
    App --&gt; NewsSearchSdk["NewsSearch.Sdk"]
    App --&gt; AppServiceDefaults["App.ServiceDefaults"]
    AppClient --&gt; AppSdk["App.Sdk"]
    AppClient["App.Client"] --&gt; AppServiceDefaults
    AppAppHost["App.AppHost"] --&gt; App
    AppAppHost --&gt; AppClient
</div>

<p>Here is <code class="language-plaintext highlighter-rouge">App/Program.cs</code></p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">var</span> <span class="n">builder</span> <span class="p">=</span> <span class="n">WebApplication</span><span class="p">.</span><span class="nf">CreateBuilder</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>
<span class="n">builder</span><span class="p">.</span><span class="nf">AddServiceDefaults</span><span class="p">();</span>

<span class="kt">var</span> <span class="n">services</span> <span class="p">=</span> <span class="n">builder</span><span class="p">.</span><span class="n">Services</span><span class="p">;</span>
<span class="n">services</span><span class="p">.</span><span class="nf">AddEndpointsApiExplorer</span><span class="p">();</span>
<span class="n">services</span><span class="p">.</span><span class="nf">AddSwaggerGen</span><span class="p">();</span>

<span class="kt">var</span> <span class="n">app</span> <span class="p">=</span> <span class="n">builder</span><span class="p">.</span><span class="nf">Build</span><span class="p">();</span>
<span class="n">app</span><span class="p">.</span><span class="nf">MapDefaultEndpoints</span><span class="p">();</span>
<span class="n">app</span><span class="p">.</span><span class="nf">MapTrendingEndpoints</span><span class="p">();</span>

<span class="n">app</span><span class="p">.</span><span class="nf">Run</span><span class="p">();</span>
</code></pre></div></div>

<p>And here is <code class="language-plaintext highlighter-rouge">App.Client/Program.cs</code></p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">var</span> <span class="n">builder</span> <span class="p">=</span> <span class="n">WebApplication</span><span class="p">.</span><span class="nf">CreateBuilder</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>
<span class="n">builder</span><span class="p">.</span><span class="nf">AddServiceDefaults</span><span class="p">();</span>

<span class="kt">var</span> <span class="n">services</span> <span class="p">=</span> <span class="n">builder</span><span class="p">.</span><span class="n">Services</span><span class="p">;</span>
<span class="n">services</span><span class="p">.</span><span class="nf">AddEndpointsApiExplorer</span><span class="p">();</span>
<span class="n">services</span><span class="p">.</span><span class="nf">AddSwaggerGen</span><span class="p">();</span>

<span class="kt">var</span> <span class="n">app</span> <span class="p">=</span> <span class="n">builder</span><span class="p">.</span><span class="nf">Build</span><span class="p">();</span>
<span class="n">app</span><span class="p">.</span><span class="nf">MapDefaultEndpoints</span><span class="p">();</span>
<span class="n">app</span><span class="p">.</span><span class="nf">MapGet</span><span class="p">(</span><span class="s">"/my/trending"</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span>
<span class="p">{</span>
  <span class="c1">// TODO:</span>
<span class="p">});</span>

<span class="n">app</span><span class="p">.</span><span class="nf">Run</span><span class="p">();</span>
</code></pre></div></div>

<h2 id="generate-http-client-for-aspnet-core-applications">Generate HTTP Client for ASP.NET Core applications</h2>

<p>ASP.NET Core has built-in support for OpenAPI, also known as Swagger. This support allows developers to generate API documentation directly from their code. The quality of the generated OpenAPI specification largely depends on the amount of metadata provided by the developer in the form of attributes and comments. The more detailed and accurate this metadata is, the more precise and useful the generated OpenAPI specification will be. This, in turn, improves the quality of the client SDKs generated from the OpenAPI specification.</p>

<h3 id="generate-openapi-specification-automatically">Generate OpenAPI specification automatically</h3>

<p>We can generate OpenAPI specification at build time from the code in ASP.NET Core by using <code class="language-plaintext highlighter-rouge">Microsoft.Extensions.ApiDescription.Server</code></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dotnet add ./src/App package Microsoft.Extensions.ApiDescription.Server
</code></pre></div></div>

<p>And add configuration to <code class="language-plaintext highlighter-rouge">App.csproj</code>:</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;PropertyGroup&gt;</span>
  <span class="nt">&lt;OpenApiDocumentsDirectory&gt;</span>$(MSBuildProjectDirectory)/../App.Sdk/OpenApi<span class="nt">&lt;/OpenApiDocumentsDirectory&gt;</span>
  <span class="nt">&lt;OpenApiGenerateDocuments&gt;</span>true<span class="nt">&lt;/OpenApiGenerateDocuments&gt;</span>
  <span class="nt">&lt;OpenApiGenerateDocumentsOnBuild&gt;</span>true<span class="nt">&lt;/OpenApiGenerateDocumentsOnBuild&gt;</span>
<span class="nt">&lt;/PropertyGroup&gt;</span>
</code></pre></div></div>

<p>Note, I decided to set up the output location outside of the project - <code class="language-plaintext highlighter-rouge">src/App.Sdk/OpenApi</code>. We can combine the OpenAPI generation with <strong>Kiota</strong> <code class="language-plaintext highlighter-rouge">App.Sdk</code> client generation:</p>

<p>Add the next Target to <code class="language-plaintext highlighter-rouge">App.csproj</code>. Every time we change <code class="language-plaintext highlighter-rouge">App</code>, the <code class="language-plaintext highlighter-rouge">App.Sdk</code> is regenerated. This makes the process fully automatic. Personally, I like this developer experience because I can always see the changed files in the source code.</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;Target</span> <span class="na">Name=</span><span class="s">"OpenAPI"</span> <span class="na">AfterTargets=</span><span class="s">"Build"</span> <span class="na">Condition=</span><span class="s">"$(Configuration)=='Debug'"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;Exec</span> <span class="na">Command=</span><span class="s">"dotnet kiota generate -l CSharp --output ../App.Sdk --namespace-name App.Sdk --class-name AppApiClient --exclude-backward-compatible --openapi ../App.Sdk/OpenApi/App.json"</span> <span class="na">WorkingDirectory=</span><span class="s">"$(ProjectDir)"</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/Target&gt;</span>
</code></pre></div></div>

<h3 id="use-openapi-specification">Use OpenAPI Specification</h3>

<p>The <code class="language-plaintext highlighter-rouge">AppApiClient</code> class is a central part of the generated SDK. It provides methods for making HTTP requests to the API endpoints defined in our application. In the example below, we are using the <code class="language-plaintext highlighter-rouge">AppApiClient</code> to make a GET request to the <code class="language-plaintext highlighter-rouge">/trending/{country}</code> endpoint.</p>

<p>The <code class="language-plaintext highlighter-rouge">AppApiClient</code> takes an <code class="language-plaintext highlighter-rouge">IRequestAdapter</code> as a parameter in its constructor. This adapter is responsible for sending HTTP requests and receiving HTTP responses. In this example, we are using the <code class="language-plaintext highlighter-rouge">HttpClientRequestAdapter</code>.</p>

<p>We also provide an <code class="language-plaintext highlighter-rouge">IAuthenticationProvider</code> to the <code class="language-plaintext highlighter-rouge">HttpClientRequestAdapter</code>. This provider is responsible for providing the necessary authentication credentials for the API requests. In this example, we are using the <code class="language-plaintext highlighter-rouge">AnonymousAuthenticationProvider</code>, which does not provide any authentication credentials.</p>

<p>Finally, we set the <code class="language-plaintext highlighter-rouge">BaseUrl</code> of the <code class="language-plaintext highlighter-rouge">HttpClientRequestAdapter</code>. This URL is used as the base for all API requests made by the <code class="language-plaintext highlighter-rouge">AppApiClient</code>.</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// App.Client/Program.cs</span>
<span class="n">app</span><span class="p">.</span><span class="nf">MapGet</span><span class="p">(</span><span class="s">"/my/trending"</span><span class="p">,</span> <span class="k">async</span> <span class="p">()</span> <span class="p">=&gt;</span>
<span class="p">{</span>
    <span class="kt">var</span> <span class="n">authProvider</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">AnonymousAuthenticationProvider</span><span class="p">();</span>
    <span class="kt">var</span> <span class="n">requestAdapter</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">HttpClientRequestAdapter</span><span class="p">(</span><span class="n">authProvider</span><span class="p">,</span> <span class="n">httpClient</span><span class="p">:</span> <span class="n">httpClient</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">BaseUrl</span> <span class="p">=</span> <span class="s">"http://app"</span>
    <span class="p">};</span>
    <span class="kt">var</span> <span class="n">client</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">AppApiClient</span><span class="p">(</span><span class="n">requestAdapter</span><span class="p">);</span>

    <span class="kt">var</span> <span class="n">response</span> <span class="p">=</span> <span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="n">Trending</span><span class="p">[</span><span class="s">"US"</span><span class="p">].</span><span class="nf">GetAsync</span><span class="p">();</span>

    <span class="k">return</span> <span class="n">response</span><span class="p">.</span><span class="n">Value</span><span class="p">.</span><span class="nf">Select</span><span class="p">(</span><span class="n">topic</span> <span class="p">=&gt;</span> <span class="n">topic</span><span class="p">.</span><span class="n">Query</span><span class="p">.</span><span class="n">Text</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></div></div>

<p>ðŸ’¡Note, the <code class="language-plaintext highlighter-rouge">BaseUrl</code> is based on Aspire convention. Here is <code class="language-plaintext highlighter-rouge">App.AppHost</code>:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// App.AppHost/Program.cs</span>
<span class="kt">var</span> <span class="n">builder</span> <span class="p">=</span> <span class="n">DistributedApplication</span><span class="p">.</span><span class="nf">CreateBuilder</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>

<span class="kt">var</span> <span class="n">appProject</span> <span class="p">=</span> <span class="n">builder</span><span class="p">.</span><span class="n">AddProject</span><span class="p">&lt;</span><span class="n">Projects</span><span class="p">.</span><span class="n">App</span><span class="p">&gt;(</span><span class="s">"app"</span><span class="p">);</span>

<span class="n">builder</span><span class="p">.</span><span class="n">AddProject</span><span class="p">&lt;</span><span class="n">Projects</span><span class="p">.</span><span class="n">App_Client</span><span class="p">&gt;(</span><span class="s">"app-client"</span><span class="p">)</span>
    <span class="p">.</span><span class="nf">WithReference</span><span class="p">(</span><span class="n">appProject</span><span class="p">);</span>

<span class="n">builder</span><span class="p">.</span><span class="nf">Build</span><span class="p">().</span><span class="nf">Run</span><span class="p">();</span>
</code></pre></div></div>

<h3 id="demo">Demo</h3>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dotnet run <span class="nt">--project</span> ./src/App.AppHost
curl <span class="nt">-s</span> http://localhost:5102/my/trending | jq
</code></pre></div></div>

<div class="mermaid">
graph LR
    User(fa:fa-user) --&gt; AppClient["App.Client"]
    AppClient --&gt; AppSdk["App.Sdk"]
    AppSdk --&gt; App
    App --&gt; NewsSearchSdk["NewsSearch.Sdk"]
    NewsSearchSdk --&gt; BingApi["Bing Search API"]

    style AppSdk fill:#add8e6
    style NewsSearchSdk fill:#add8e6
    style BingApi fill:#ffff99
</div>

<p><img src="/assets/kiota/demo2.png" alt="demo2"></p>

<p>And here is trace example from <strong>Aspire.Dashboard</strong>:</p>

<p><img src="/assets/kiota/trace-example.png" alt="trace-example"></p>

<p>ðŸ’¡Note, Http instrumentation/tracing works only for clients resolved through DI container. Later, I will show you how to properly add <code class="language-plaintext highlighter-rouge">AppApiClient</code> so it uses <code class="language-plaintext highlighter-rouge">HttpClient</code> from <code class="language-plaintext highlighter-rouge">IHttpClientFactory</code>.</p>

<h2 id="dependency-injection-typed-http-clients-and-ihttpclientfactory">Dependency Injection, Typed HTTP Clients, and <code class="language-plaintext highlighter-rouge">IHttpClientFactory</code>
</h2>

<p>As you may already know, <code class="language-plaintext highlighter-rouge">IHttpClientFactory</code> in .NET provides a better way to work with <code class="language-plaintext highlighter-rouge">HttpClient</code>, as it addresses well-known client lifetime issues. In this guide, I will demonstrate how to use a client generated by <strong>Kiota</strong> as a typed client. For more information, refer to the <a href="https://learn.microsoft.com/en-us/dotnet/core/extensions/httpclient-factory#typed-clients" target="_blank" rel="noopener noreferrer">Typed-client approach</a>.</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// App.Client/Program.cs</span>
<span class="n">services</span><span class="p">.</span><span class="n">AddSingleton</span><span class="p">&lt;</span><span class="n">IAuthenticationProvider</span><span class="p">,</span> <span class="n">AnonymousAuthenticationProvider</span><span class="p">&gt;(</span>
    <span class="n">_</span> <span class="p">=&gt;</span> <span class="k">new</span> <span class="nf">AnonymousAuthenticationProvider</span><span class="p">());</span>

<span class="n">services</span><span class="p">.</span><span class="n">AddHttpClient</span><span class="p">&lt;</span><span class="n">AppApiClient</span><span class="p">&gt;()</span>
    <span class="p">.</span><span class="nf">AddTypedClient</span><span class="p">((</span><span class="n">httpClient</span><span class="p">,</span> <span class="n">sp</span><span class="p">)</span> <span class="p">=&gt;</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">authenticationProvider</span> <span class="p">=</span> <span class="n">sp</span><span class="p">.</span><span class="n">GetRequiredService</span><span class="p">&lt;</span><span class="n">IAuthenticationProvider</span><span class="p">&gt;();</span>
        <span class="kt">var</span> <span class="n">requestAdapter</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">HttpClientRequestAdapter</span><span class="p">(</span><span class="n">authProvider</span> <span class="p">,</span> <span class="n">httpClient</span><span class="p">:</span> <span class="n">httpClient</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">BaseUrl</span> <span class="p">=</span> <span class="s">"http://app"</span>
        <span class="p">};</span>

        <span class="k">return</span> <span class="k">new</span> <span class="nf">AppApiClient</span><span class="p">(</span><span class="n">requestAdapter</span><span class="p">);</span>
    <span class="p">})</span>
    <span class="p">.</span><span class="nf">ConfigurePrimaryHttpMessageHandler</span><span class="p">(</span><span class="n">_</span> <span class="p">=&gt;</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">defaultHandlers</span> <span class="p">=</span> <span class="n">KiotaClientFactory</span><span class="p">.</span><span class="nf">CreateDefaultHandlers</span><span class="p">();</span>
        <span class="kt">var</span> <span class="n">defaultHttpMessageHandler</span> <span class="p">=</span> <span class="n">KiotaClientFactory</span><span class="p">.</span><span class="nf">GetDefaultHttpMessageHandler</span><span class="p">();</span>

        <span class="k">return</span> <span class="n">KiotaClientFactory</span><span class="p">.</span><span class="nf">ChainHandlersCollectionAndGetFirstLink</span><span class="p">(</span>
            <span class="n">defaultHttpMessageHandler</span><span class="p">,</span> <span class="p">[..</span> <span class="n">defaultHandlers</span><span class="p">])!;</span>
    <span class="p">});</span>
</code></pre></div></div>

<p>The code above is configuring an <code class="language-plaintext highlighter-rouge">HttpClient</code> for the <code class="language-plaintext highlighter-rouge">AppApiClient</code> in a .NET application. The <code class="language-plaintext highlighter-rouge">AddTypedClient</code> method is used to further configure the <code class="language-plaintext highlighter-rouge">HttpClient</code> instance. The advantage of using typed clients is that they provide a clear contract for HTTP interactions and can be easily mocked for testing.</p>

<p>By default, <strong>Kiota</strong> provides the default list of <code class="language-plaintext highlighter-rouge">DelegatingHandler</code>s and <code class="language-plaintext highlighter-rouge">HttpMessageHandler</code>. It is good idea to include them, but you can definitely opt-out if it interferes with your code.</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">static</span> <span class="n">IList</span><span class="p">&lt;</span><span class="n">DelegatingHandler</span><span class="p">&gt;</span> <span class="nf">CreateDefaultHandlers</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">DelegatingHandler</span><span class="p">&gt;</span>
    <span class="p">{</span>
        <span class="k">new</span> <span class="nf">RetryHandler</span><span class="p">(),</span>
        <span class="k">new</span> <span class="nf">RedirectHandler</span><span class="p">(),</span>
        <span class="k">new</span> <span class="nf">ParametersNameDecodingHandler</span><span class="p">(),</span>
        <span class="k">new</span> <span class="nf">UserAgentHandler</span><span class="p">(),</span>
        <span class="k">new</span> <span class="nf">HeadersInspectionHandler</span><span class="p">()</span>
    <span class="p">};</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">ConfigurePrimaryHttpMessageHandler</code> method is used to set up the primary <code class="language-plaintext highlighter-rouge">HttpMessageHandler</code> for the HTTP client. This handler is responsible for sending HTTP requests and receiving HTTP responses.</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">static</span> <span class="n">IHttpClientBuilder</span> <span class="nf">ConfigurePrimaryHttpMessageHandler</span><span class="p">(</span>
    <span class="k">this</span> <span class="n">IHttpClientBuilder</span> <span class="n">builder</span><span class="p">,</span>
    <span class="n">Func</span><span class="p">&lt;</span><span class="n">IServiceProvider</span><span class="p">,</span> <span class="n">HttpMessageHandler</span><span class="p">&gt;</span> <span class="n">configureHandler</span><span class="p">);</span>
</code></pre></div></div>

<p>Hereâ€™s how it works:</p>

<ol>
  <li>
    <p>Create a list of default <code class="language-plaintext highlighter-rouge">DelegatingHandler</code> instances using <code class="language-plaintext highlighter-rouge">KiotaClientFactory.CreateDefaultHandlers()</code>. A <code class="language-plaintext highlighter-rouge">DelegatingHandler</code> is a special type of <code class="language-plaintext highlighter-rouge">HttpMessageHandler</code> that can be used to process or manipulate HTTP requests and responses in some way before they are sent or after they are received.</p>
  </li>
  <li>
    <p>Get the default <code class="language-plaintext highlighter-rouge">HttpMessageHandler</code> using <code class="language-plaintext highlighter-rouge">KiotaClientFactory.GetDefaultHttpMessageHandler()</code>. This handler is the one that will actually send the HTTP request and receive the response.</p>
  </li>
  <li>
    <p>Chain these handlers together using <code class="language-plaintext highlighter-rouge">KiotaClientFactory.ChainHandlersCollectionAndGetFirstLink()</code>. This method takes the default <code class="language-plaintext highlighter-rouge">HttpMessageHandler</code> and the list of <code class="language-plaintext highlighter-rouge">DelegatingHandler</code> instances, and chains them together so that each request or response will pass through each handler in turn. The method returns the first link in this chain, which is then used as the primary <code class="language-plaintext highlighter-rouge">HttpMessageHandler</code> for the HTTP client.</p>
  </li>
</ol>

<p>Finally, here is how to use <code class="language-plaintext highlighter-rouge">AppApiClient</code> from DI:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// App.Client/Program.cs</span>
<span class="n">app</span><span class="p">.</span><span class="nf">MapGet</span><span class="p">(</span><span class="s">"/my/trending"</span><span class="p">,</span> <span class="k">async</span> <span class="p">(</span><span class="n">AppApiClient</span> <span class="n">client</span><span class="p">)</span> <span class="p">=&gt;</span>
<span class="p">{</span>
    <span class="kt">var</span> <span class="n">response</span> <span class="p">=</span> <span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="n">Trending</span><span class="p">[</span><span class="s">"US"</span><span class="p">].</span><span class="nf">GetAsync</span><span class="p">();</span>

    <span class="k">return</span> <span class="n">response</span><span class="p">.</span><span class="n">Value</span><span class="p">.</span><span class="nf">Select</span><span class="p">(</span><span class="n">topic</span> <span class="p">=&gt;</span> <span class="n">topic</span><span class="p">.</span><span class="n">Query</span><span class="p">.</span><span class="n">Text</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></div></div>

<h2 id="cross-cutting-concerns-and-resilience">Cross-Cutting Concerns and Resilience</h2>

<p>In distributed applications, communication between services is a critical aspect. However, this communication is not always reliable. Network issues, high latency, or the unavailability of a service can lead to failures. This is where resilience comes into play.</p>

<p>Polly is a .NET resilience and transient-fault-handling library that allows developers to express policies such as Retry, Circuit Breaker, Timeout, Bulkhead Isolation, and Fallback in a fluent and thread-safe manner. It is a crucial tool for building reliable applications that can withstand the unpredictable nature of the network.</p>

<p>.NET 8, .NET team has made substantial advancements to simplify the integration of resilience into your applications - meet new resilience packages:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Extensions to the Polly libraries to enrich telemetry with metadata and exception summaries</span>
dotnet add package Microsoft.Extensions.Resilience
<span class="c"># Resilience mechanisms for HttpClient built on the Polly framework</span>
dotnet add package Microsoft.Extensions.Http.Resilience
</code></pre></div></div>

<p>For an out-of-the-box experience, use the <code class="language-plaintext highlighter-rouge">AddStandardResilienceHandler</code> extension on the <code class="language-plaintext highlighter-rouge">IHttpClientBuilder</code> like this:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">IHttpStandardResiliencePipelineBuilder</span> <span class="n">resilienceBuilder</span> <span class="p">=</span> <span class="n">services</span>
    <span class="p">.</span><span class="nf">AddHttpClient</span><span class="p">(</span><span class="s">"my-client"</span><span class="p">)</span>
    <span class="p">.</span><span class="nf">AddStandardResilienceHandler</span><span class="p">(</span><span class="n">options</span> <span class="p">=&gt;</span>
    <span class="p">{</span>
        <span class="c1">// Configure standard resilience options here</span>
    <span class="p">});</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">IHttpStandardResiliencePipelineBuilder</code> allows to configure underlying multiple resilience strategies with options to send the requests and handle any transient errors.</p>

<p>In the context of our example, itâ€™s worth noting that it already has the <code class="language-plaintext highlighter-rouge">StandardResilienceHandler</code> built-in. This is due to the fact that <strong>Aspire</strong> has opinionated defaults on how to build distributed applications. This means that it comes with a set of pre-configured settings that are designed to handle common scenarios in a distributed environment.</p>

<p>The <code class="language-plaintext highlighter-rouge">StandardResilienceHandler</code> is a part of these defaults. It is a resilience strategy that includes a combination of retry, circuit breaker, and timeout policies. These policies are designed to handle transient faults in a graceful manner, ensuring that your application remains responsive and reliable in the face of network issues, high latency, or service unavailability.</p>

<p>The <code class="language-plaintext highlighter-rouge">StandardResilienceHandler</code> is automatically applied to all HTTP clients that are created through the <code class="language-plaintext highlighter-rouge">IHttpClientFactory</code>. This means that you donâ€™t have to manually configure these resilience policies for each client. Instead, they are applied consistently across your application, ensuring that all HTTP communication is resilient.</p>

<p>Here is partial content from <code class="language-plaintext highlighter-rouge">App.ServiceDefaults/Extensions.cs</code>:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">static</span> <span class="n">IHostApplicationBuilder</span> <span class="nf">AddServiceDefaults</span><span class="p">(</span><span class="k">this</span> <span class="n">IHostApplicationBuilder</span> <span class="n">builder</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">builder</span><span class="p">.</span><span class="nf">ConfigureOpenTelemetry</span><span class="p">();</span>

    <span class="n">builder</span><span class="p">.</span><span class="nf">AddDefaultHealthChecks</span><span class="p">();</span>

    <span class="n">builder</span><span class="p">.</span><span class="n">Services</span><span class="p">.</span><span class="nf">AddServiceDiscovery</span><span class="p">();</span>

    <span class="n">builder</span><span class="p">.</span><span class="n">Services</span><span class="p">.</span><span class="nf">ConfigureHttpClientDefaults</span><span class="p">(</span><span class="n">http</span> <span class="p">=&gt;</span>
    <span class="p">{</span>
        <span class="c1">// Turn on resilience by default</span>
        <span class="n">http</span><span class="p">.</span><span class="nf">AddStandardResilienceHandler</span><span class="p">();</span>

        <span class="n">http</span><span class="p">.</span><span class="nf">UseServiceDiscovery</span><span class="p">();</span>
    <span class="p">});</span>

    <span class="k">return</span> <span class="n">builder</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Here is an example of how to use the <code class="language-plaintext highlighter-rouge">AddStandardResilienceHandler</code> method on top of <code class="language-plaintext highlighter-rouge">IHttpClientBuilder</code> returned by <code class="language-plaintext highlighter-rouge">AddTypedClient</code> method for fine-grained control and customization of resiliency per-client:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">services</span><span class="p">.</span><span class="n">AddHttpClient</span><span class="p">&lt;</span><span class="n">AppApiClient</span><span class="p">&gt;().</span><span class="nf">AddTypedClient</span><span class="p">()</span>
    <span class="p">.</span><span class="nf">AddStandardResilienceHandler</span><span class="p">().</span><span class="nf">Configure</span><span class="p">(</span><span class="n">cfg</span> <span class="p">=&gt;</span>
    <span class="p">{</span>
        <span class="n">cfg</span><span class="p">.</span><span class="n">Retry</span><span class="p">.</span><span class="n">MaxRetryAttempts</span> <span class="p">=</span> <span class="m">3</span><span class="p">;</span>
        <span class="n">cfg</span><span class="p">.</span><span class="n">Retry</span><span class="p">.</span><span class="n">UseJitter</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>
        <span class="n">cfg</span><span class="p">.</span><span class="n">Retry</span><span class="p">.</span><span class="n">BackoffType</span> <span class="p">=</span> <span class="n">Polly</span><span class="p">.</span><span class="n">DelayBackoffType</span><span class="p">.</span><span class="n">Exponential</span><span class="p">;</span>
    <span class="p">});</span>
</code></pre></div></div>

<p>ðŸ’¡Note, <code class="language-plaintext highlighter-rouge">Microsoft.Extensions.Http.Resilience</code> allows to build custom pipelines and gives you full control over how to manage resiliency in your applications.</p>

<h2 id="testing">Testing</h2>

<p>For unit testing, itâ€™s suggested to use mock versions of the HTTP transport layer to manage API responses. In <strong>Kiota</strong> API clients, this layer is in a request adapter. By mocking the request adapter, you can control the API responses.</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">class</span> <span class="nc">TrendingTopicTests</span>
<span class="p">{</span>
    <span class="p">[</span><span class="n">Fact</span><span class="p">]</span>
    <span class="k">public</span> <span class="k">async</span> <span class="n">Task</span> <span class="nf">TrendingTopic_GetUS_SuccessAsync</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">// Arrange</span>
        <span class="kt">var</span> <span class="n">adapter</span> <span class="p">=</span> <span class="n">Substitute</span><span class="p">.</span><span class="n">For</span><span class="p">&lt;</span><span class="n">IRequestAdapter</span><span class="p">&gt;();</span>
        <span class="n">adapter</span><span class="p">.</span><span class="nf">SetupSendAsyncWithResponse</span><span class="p">(</span><span class="k">new</span> <span class="nf">TrendingTopics</span><span class="p">()</span> <span class="p">{</span> <span class="n">Value</span> <span class="p">=</span> <span class="p">[]</span> <span class="p">});</span>

        <span class="kt">var</span> <span class="n">newsSearchApiClient</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">NewsSearchApiClient</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

        <span class="c1">// Act</span>
        <span class="kt">var</span> <span class="n">response</span> <span class="p">=</span> <span class="k">await</span> <span class="n">newsSearchApiClient</span>
            <span class="p">.</span><span class="n">News</span>
            <span class="p">.</span><span class="n">Trendingtopics</span>
            <span class="p">.</span><span class="nf">GetAsync</span><span class="p">(</span><span class="n">r</span> <span class="p">=&gt;</span> <span class="n">r</span><span class="p">.</span><span class="n">QueryParameters</span><span class="p">.</span><span class="n">Cc</span> <span class="p">=</span> <span class="s">"US"</span><span class="p">);</span>

        <span class="c1">// Assert</span>
        <span class="n">Assert</span><span class="p">.</span><span class="nf">NotNull</span><span class="p">(</span><span class="n">response</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">public</span> <span class="k">static</span> <span class="k">class</span> <span class="nc">Utils</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">static</span> <span class="k">void</span> <span class="n">SetupSendAsyncWithResponse</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span>
        <span class="k">this</span> <span class="n">IRequestAdapter</span> <span class="n">adapter</span><span class="p">,</span> <span class="n">T</span> <span class="n">response</span><span class="p">)</span> <span class="k">where</span> <span class="n">T</span> <span class="p">:</span> <span class="n">IParsable</span>
    <span class="p">{</span>
        <span class="n">adapter</span><span class="p">.</span><span class="n">SendAsync</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span>
            <span class="n">Arg</span><span class="p">.</span><span class="n">Any</span><span class="p">&lt;</span><span class="n">RequestInformation</span><span class="p">&gt;(),</span>
            <span class="n">Arg</span><span class="p">.</span><span class="n">Any</span><span class="p">&lt;</span><span class="n">ParsableFactory</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;&gt;(),</span>
            <span class="n">Arg</span><span class="p">.</span><span class="n">Any</span><span class="p">&lt;</span><span class="n">Dictionary</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="n">ParsableFactory</span><span class="p">&lt;</span><span class="n">IParsable</span><span class="p">&gt;&gt;&gt;(),</span>
            <span class="n">Arg</span><span class="p">.</span><span class="n">Any</span><span class="p">&lt;</span><span class="n">CancellationToken</span><span class="p">&gt;())</span>
            <span class="p">.</span><span class="nf">ReturnsForAnyArgs</span><span class="p">(</span><span class="n">response</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>ðŸ’¡The process of mocking <code class="language-plaintext highlighter-rouge">IRequestAdapter</code> can be somewhat complex, particularly as it requires reliance on models generated by <strong>Kiota</strong>. To streamline testing, I recommend encapsulating the use of generated clients within a simple interface and then mocking this interface. This approach not only simplifies testing but also aligns well with the principles of Clean Architecture. By doing so, we avoid the need to mock the Kiota code directly, enhancing the maintainability and readability of our tests.</p>

<h2 id="conclusion">Conclusion</h2>

<p>In conclusion, <strong>Kiota</strong> is not just a powerful tool, but a practical solution for modern development challenges. Itâ€™s ready to be integrated into your production code. Itâ€™s time to embrace <strong>Kiota</strong> and let it transform your development workflow.</p>

<h2 id="references">References</h2>

<ul>
  <li><a href="https://nikiforovall.github.io/dotnet/aspnetcore/2024/03/22/kiota-guide-introduction.html" target="_blank" rel="noopener noreferrer">https://nikiforovall.github.io/dotnet/aspnetcore/2024/03/22/kiota-guide-introduction.html</a></li>
  <li><a href="https://www.meziantou.net/generate-openapi-specification-at-build-time-from-the-code-in-asp-net-core.htm" target="_blank" rel="noopener noreferrer">https://www.meziantou.net/generate-openapi-specification-at-build-time-from-the-code-in-asp-net-core.htm</a></li>
  <li><a href="https://devblogs.microsoft.com/dotnet/introducing-dotnet-aspire-simplifying-cloud-native-development-with-dotnet-8/" target="_blank" rel="noopener noreferrer">https://devblogs.microsoft.com/dotnet/introducing-dotnet-aspire-simplifying-cloud-native-development-with-dotnet-8/</a></li>
  <li><a href="https://github.com/microsoft/kiota-http-dotnet/blob/main/src/KiotaClientFactory.cs" target="_blank" rel="noopener noreferrer">https://github.com/microsoft/kiota-http-dotnet/blob/main/src/KiotaClientFactory.cs</a></li>
  <li><a href="https://devblogs.microsoft.com/dotnet/building-resilient-cloud-services-with-dotnet-8/" target="_blank" rel="noopener noreferrer">https://devblogs.microsoft.com/dotnet/building-resilient-cloud-services-with-dotnet-8/</a></li>
  <li><a href="https://learn.microsoft.com/en-us/openapi/kiota/testing" target="_blank" rel="noopener noreferrer">https://learn.microsoft.com/en-us/openapi/kiota/testing</a></li>
</ul>

	</div>

	

	
	<ul class="list-inline">
		<li>
<i class="fa-solid fa-bookmark"></i> Topics:</li>
		
		
		
		<li>
			<a href="/topics.html#dotnet-cat-ref">
				dotnet <span>(58)</span>
			</a>
			 Â·
		</li>
		
		<li>
			<a href="/topics.html#aspnetcore-cat-ref">
				aspnetcore <span>(11)</span>
			</a>
			 Â·
		</li>
		
		
		
		
		
		<li>
			<a href="/topics.html#dotnet-tag-ref">
				dotnet <span>(63)</span>
			</a>
			 Â·
		</li>
		
		<li>
			<a href="/topics.html#aspnetcore-tag-ref">
				aspnetcore <span>(24)</span>
			</a>
			 Â·
		</li>
		
		<li>
			<a href="/topics.html#openapi-tag-ref">
				openapi <span>(4)</span>
			</a>
			 Â·
		</li>
		
		<li>
			<a href="/topics.html#aspire-tag-ref">
				aspire <span>(20)</span>
			</a>
			 Â·
		</li>
		
		<li>
			<a href="/topics.html#cli-tag-ref">
				cli <span>(9)</span>
			</a>
			
		</li>
		
		
		
	</ul>
	

	<hr>

	<div>
		<section class="share col-sm-6">
			<h4 class="section-title">Share Post</h4>
			<a class="btn btn-default btn-sm twitter" href="http://x.com/share?&amp;via=nikiforovall" onclick="window.open(this.href, 'x-share', 'width=550,height=235');return false;" target="_blank" rel="noopener noreferrer">
				<i class="fa-brands fa-x-twitter fa-lg"></i>
				X
			</a>
		</section>

		<section class="col-sm-6 author">
			<img src="//www.gravatar.com/avatar/e86fa0938976c38907a302ecb208f011" class="img-rounded author-image">
			<h4 class="section-title author-name">Oleksii Nikiforov</h4>
			<p class="author-bio">Jibber-jabbering about programming and IT.</p>
		</section>
	</div>

	<div class="clearfix"></div>

	<ul class="pager">
		
		<li class="previous"><a href="/dotnet/aspnetcore/2024/03/22/kiota-guide-introduction.html" title="A Guide to OpenAPI Client Generation with Kiota. Introduction (Part 1)">â†
				Previous</a></li>
		
		
		<li class="next">
<a href="/dotnet/aspnetcore/aspire/2024/03/30/aspire-cap.html" title="Transactional Outbox in .NET Cloud Native Development via Aspire">Next â†’</a>
		</li>
		
	</ul>

	<hr>
	</div>

	<div class="col-sm-2 sidebar-2">

	</div>

</article>
<div class="clearfix"></div>



    
    <script src="https://utteranc.es/client.js" repo="NikiforovAll/nikiforovall.github.io" issue-term="pathname" label="Blog" theme="preferred-color-scheme" crossorigin="anonymous" async>
    </script>





		<footer>
			<hr>
			<p>
				Â© 2025 Oleksii Nikiforov with <a href="http://jekyllrb.com/" target="_blank" rel="noopener noreferrer">Jekyll</a>. Theme: <a href="https://github.com/dbtek/dbyll" target="_blank" rel="noopener noreferrer">dbyll</a> by dbtek.
			</p>
		</footer>
	</div>

	<script type="text/javascript" src="/assets/resources/jquery/jquery.min.js"></script>
	<script type="text/javascript" src="/assets/resources/bootstrap/js/bootstrap.min.js"></script>
	<script type="text/javascript" src="/assets/js/app.js"></script>
	<script src="https://unpkg.com/lunr/lunr.js"></script>
	<script type="text/javascript" src="/assets/js/search.js"></script>
	
		<script type="text/javascript" src="https://unpkg.com/mermaid@10.9.0/dist/mermaid.min.js">
</script>
<script>
$(document).ready(function() {
    mermaid.initialize({
        theme: 'forest'
    });
});
</script>

	
</body>
</html>



<!-- Asynchronous Google Analytics snippet -->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-164555539-1', 'auto');
  ga('send', 'pageview');
</script>

