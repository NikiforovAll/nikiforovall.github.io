<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<!-- <meta http-equiv="Content-Security-Policy" content="frame-src https://try.dot.net;"> -->
	<title>Polymorphic serialization via System.Text.Json in ASP.NET Core Minimal API</title>
	
	<meta name="author" content="Oleksii Nikiforov">

	<!-- Enable responsive viewport -->
	<meta name="viewport" content="width=device-width, initial-scale=1.0">

	<!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
	<!--[if lt IE 9]>
	<script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
	<![endif]-->

	<!-- Le styles -->
	<link href="https://nikiforovall.github.io/assets/resources/bootstrap/css/bootstrap.min.css" rel="stylesheet">
	<link href="https://nikiforovall.github.io/assets/resources/font-awesome/css/font-awesome.min.css" rel="stylesheet">
	<link href="https://nikiforovall.github.io/assets/resources/syntax/syntax.css" rel="stylesheet">
	<link href="https://nikiforovall.github.io/assets/css/style.css" rel="stylesheet">

	<!-- Le fav and touch icons -->
	<!-- Update these with your own images
	<link rel="shortcut icon" href="images/favicon.ico">
	<link rel="apple-touch-icon" href="images/apple-touch-icon.png">
	<link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
	<link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
	-->
	<link rel="shortcut icon" href="/assets/media/favicon.ico">

	<link rel="alternate" type="application/rss+xml" title="" href="https://nikiforovall.github.io/feed.xml">
</head>

<body>
	<nav class="navbar navbar-default visible-xs" role="navigation">
		<!-- Brand and toggle get grouped for better mobile display -->
		<div class="navbar-header">
			<button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
				<span class="sr-only">Toggle navigation</span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</button>
			
			<a type="button" class="navbar-toggle nav-link" href="http://github.com/nikiforovAll" target="_blank" rel="noopener noreferrer">
				<i class="fa fa-github"></i>
			</a>
			
			
			<a type="button" class="navbar-toggle nav-link" href="http://twitter.com/nikiforovall" target="_blank" rel="noopener noreferrer">
				<i class="fa fa-twitter"></i>
			</a>
			
			
			<a type="button" class="navbar-toggle nav-link" href="mailto:alexey.nikiforovall@gmail.com">
				<i class="fa fa-envelope"></i>
			</a>
			
			<a class="navbar-brand" href="https://nikiforovall.github.io/" target="_blank" rel="noopener noreferrer">
				<img src="//www.gravatar.com/avatar/e86fa0938976c38907a302ecb208f011?s=35" class="img-circle">
				N+1 Blog
			</a>
		</div>

		<!-- Collect the nav links, forms, and other content for toggling -->
		<div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
			<ul class="nav navbar-nav">
				<li class="active"><a href="https://nikiforovall.github.io/" target="_blank" rel="noopener noreferrer">Home</a></li>
				<li><a href="https://nikiforovall.github.io/categories.html" target="_blank" rel="noopener noreferrer">Categories</a></li>
				<li><a href="https://nikiforovall.github.io/tags.html" target="_blank" rel="noopener noreferrer">Tags</a></li>
				<li><a href="https://nikiforovall.github.io/about.html" target="_blank" rel="noopener noreferrer">About</a></li>
			</ul>
		</div>
<!-- /.navbar-collapse -->
	</nav>

	<!-- nav-menu-dropdown -->
	<div class="btn-group hidden-xs" id="nav-menu">
		<button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">
			<i class="fa fa-bars"></i>
		</button>
		<ul class="dropdown-menu" role="menu">
			<li><a href="https://nikiforovall.github.io/" target="_blank" rel="noopener noreferrer"><i class="fa fa-home"></i>Home</a></li>
			<li><a href="https://nikiforovall.github.io/categories.html" target="_blank" rel="noopener noreferrer"><i class="fa fa-folder"></i>Categories</a></li>
			<li><a href="https://nikiforovall.github.io/tags.html" target="_blank" rel="noopener noreferrer"><i class="fa fa-tags"></i>Tags</a></li>
			<li><a href="https://nikiforovall.github.io/about.html" target="_blank" rel="noopener noreferrer"><i class="fa fa-pencil"></i>About</a></li>
			<li class="divider">
			<li><a href="#"><i class="fa fa-arrow-up"></i>Top of Page</a></li>
		</ul>
	</div>

	<div class="col-sm-3 sidebar hidden-xs" style="">
		<!-- sidebar.html -->
<header class="sidebar-header" role="banner">
	<a href="https://nikiforovall.github.io/" target="_blank" rel="noopener noreferrer">
		<img src="//www.gravatar.com/avatar/e86fa0938976c38907a302ecb208f011?s=150" class="img-circle">
	</a>
	<h3 class="title">
        <a href="https://nikiforovall.github.io/" target="_blank" rel="noopener noreferrer">N+1 Blog</a>
    </h3>
</header>


<div id="bio" class="text-center">
	Jibber-jabbering about programming and IT.
</div>


<div id="contact-list" class="text-center">
	<ul class="list-unstyled list-inline">
		
		<li>
			<a class="btn btn-default btn-sm" href="https://github.com/nikiforovAll" target="_blank" rel="noopener noreferrer">
				<i class="fa fa-github-alt fa-lg"></i>
			</a>
		</li>
		
		
		<li>
			<a class="btn btn-default btn-sm" href="https://twitter.com/nikiforovall" target="_blank" rel="noopener noreferrer">
				<i class="fa fa-twitter fa-lg"></i>
			</a>
		</li>
		
		
		<li>
			<a class="btn btn-default btn-sm" href="https://t.me/nikiforovallblog" target="_blank" rel="noopener noreferrer">
				<i class="fa fa-pencil-square fa-lg"></i>
			</a>
		</li>
		
		
		<li>
			<a class="btn btn-default btn-sm" href="mailto:alexey.nikiforovall@gmail.com">
				<i class="fa fa-envelope fa-lg"></i>
			</a>
		</li>
		
	</ul>
	<ul id="contact-list-secondary" class="list-unstyled list-inline">
		
		
		<li>
			<a class="btn btn-default btn-sm" href="https://linkedin.com/in/nikiforov-oleksii" target="_blank" rel="noopener noreferrer">
				<i class="fa fa-linkedin fa-lg"></i>
			</a>
		</li>
		
		<li>
			<a class="btn btn-default btn-sm" href="https://nikiforovall.github.io/feed.xml" target="_blank" rel="noopener noreferrer">
				<i class="fa fa-rss fa-lg"></i>
			</a>
		</li>
	</ul>
</div>
<!-- sidebar.html end -->

	</div>

	<div class="col-sm-9 col-sm-offset-3">
		<div class="page-header">
	<h1>Polymorphic serialization via System.Text.Json in ASP.NET Core Minimal API </h1>
</div>
<article>

	<div class="col-sm-10">

		<span class="post-date">
			
			April
			6th,
			
			2024
		</span>

	
	
	
	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	
	<div>
		<h5><a href="/dotnet/aspnetcore/2024/03/24/kiota-guide-deep-dive.html">A Guide to OpenAPI Client Generation with Kiota. Deep dive (Part 2) <span class="label label-default">dotnet</span>  <span class="label label-default">aspnetcore</span>  <span class="label label-default">openapi</span> </a></h5>
	</div>
	
	
	

	

	
	

	

	
	<div>
		<h5><a href="/dotnet/aspnetcore/2024/03/22/kiota-guide-introduction.html">A Guide to OpenAPI Client Generation with Kiota. Introduction (Part 1) <span class="label label-default">dotnet</span>  <span class="label label-default">aspnetcore</span>  <span class="label label-default">openapi</span> </a></h5>
	</div>
	
	
	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	

	

	
	

	

	
	<div>
		<h5><a href="/dotnet/aspnetcore/2021/09/10/opinionated-minimal-api.html">An opinionated look at Minimal API in .NET 6 <span class="label label-default">dotnet</span>  <span class="label label-default">aspnetcore</span>  <span class="label label-default">minimal-api</span> </a></h5>
	</div>
	
	
	

	

	
	

	

	

	

	
	

	

	
	<div>
		<h5><a href="/dotnet/aspnetcore/coding-stories/2021/06/13/add-openapi-to-aspnetcore.html">How to add OpenAPI to ASP.NET Core project. A coding story. <span class="label label-default">dotnet</span>  <span class="label label-default">aspnetcore</span>  <span class="label label-default">openapi</span> </a></h5>
	</div>
	
	
	
	

	<div class="article_body" style="margin-top: 30px;">
		<p><em>Table of Contents</em>:</p>

<ul>
  <li><a href="#tldr">TL;DR</a></li>
  <li><a href="#introduction">Introduction</a></li>
  <li>
<a href="#serialization-via-systemtextjson">Serialization via <code class="language-plaintext highlighter-rouge">System.Text.Json</code></a>
    <ul>
      <li><a href="#use-jsonderivedtypeattribute">Use <code class="language-plaintext highlighter-rouge">JsonDerivedTypeAttribute</code></a></li>
      <li><a href="#use-defaultjsontypeinforesolver-in-situations-when-you-cant-apply-attributes">Use <code class="language-plaintext highlighter-rouge">DefaultJsonTypeInfoResolver</code> in situations when you can’t apply attributes</a></li>
    </ul>
  </li>
  <li><a href="#configure-openapi">Configure OpenAPI</a></li>
  <li><a href="#conclusion">Conclusion</a></li>
  <li><a href="#references">References</a></li>
</ul>

<h2 id="tldr">TL;DR</h2>

<p>In this article, we will explore the process of serializing a model hierarchy using <code class="language-plaintext highlighter-rouge">System.Text.Json</code> and how to accurately represent this serialized data in OpenAPI 3.0.</p>

<blockquote>
  <p>Source code: <a href="https://github.com/NikiforovAll/openapi-polymorphism" target="_blank" rel="noopener noreferrer">https://github.com/NikiforovAll/openapi-polymorphism</a></p>
</blockquote>

<h2 id="introduction">Introduction</h2>

<p>In the context of our demonstration, we are dealing with a composite object. The <a href="https://refactoring.guru/design-patterns/composite" target="_blank" rel="noopener noreferrer">composite pattern</a> allows us to treat individual objects and compositions of objects uniformly.</p>

<p>This pattern is particularly useful when dealing with a <em>hierarchy of objects</em> where you might need to work with a single instance of an object, or a whole group of them in a similar manner.</p>

<p>In our case, we want to serialize a composite object using <code class="language-plaintext highlighter-rouge">System.Text.Json</code> and represent this serialized data accurately in OpenAPI 3.0.</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">abstract</span> <span class="k">record</span> <span class="nc">Component</span><span class="p">(</span><span class="kt">string</span> <span class="n">Name</span><span class="p">);</span>

<span class="k">public</span> <span class="k">record</span> <span class="nc">Leaf</span><span class="p">(</span><span class="kt">string</span> <span class="n">Name</span><span class="p">)</span> <span class="p">:</span> <span class="nf">Component</span><span class="p">(</span><span class="n">Name</span><span class="p">);</span>

<span class="k">public</span> <span class="k">record</span> <span class="nc">Node</span><span class="p">(</span><span class="kt">string</span> <span class="n">Name</span><span class="p">,</span> <span class="n">IList</span><span class="p">&lt;</span><span class="n">Component</span><span class="p">&gt;?</span> <span class="n">Children</span> <span class="p">=</span> <span class="k">default</span><span class="p">)</span> <span class="p">:</span> <span class="nf">Component</span><span class="p">(</span><span class="n">Name</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="n">IList</span><span class="p">&lt;</span><span class="n">Component</span><span class="p">&gt;</span> <span class="n">Children</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">init</span><span class="p">;</span> <span class="p">}</span> <span class="p">=</span> <span class="n">Children</span> <span class="p">??</span> <span class="p">[];</span>

    <span class="k">public</span> <span class="k">void</span> <span class="nf">Add</span><span class="p">(</span><span class="n">Component</span> <span class="n">component</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="n">Children</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="n">component</span><span class="p">);</span>
<span class="p">};</span>
</code></pre></div></div>

<p>For example, we would like to serialize something like following:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">private</span> <span class="k">static</span> <span class="n">Component</span> <span class="nf">GetNode</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">Node</span> <span class="n">node</span> <span class="p">=</span> <span class="k">new</span><span class="p">(</span><span class="s">"Root1"</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">Children</span> <span class="p">=</span>
        <span class="p">[</span>
            <span class="k">new</span> <span class="nf">Node</span><span class="p">(</span><span class="s">"N1"</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">Children</span> <span class="p">=</span>
                <span class="p">[</span>
                    <span class="k">new</span> <span class="nf">Leaf</span><span class="p">(</span><span class="s">"L1"</span><span class="p">),</span>
                    <span class="k">new</span> <span class="nf">Leaf</span><span class="p">(</span><span class="s">"L2"</span><span class="p">)</span>
                <span class="p">]</span>
            <span class="p">},</span>
            <span class="k">new</span> <span class="nf">Node</span><span class="p">(</span><span class="s">"N2"</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">Children</span> <span class="p">=</span>
                <span class="p">[</span>
                    <span class="k">new</span> <span class="nf">Node</span><span class="p">(</span><span class="s">"N3"</span><span class="p">)</span>
                    <span class="p">{</span>
                        <span class="n">Children</span> <span class="p">=</span>
                        <span class="p">[</span>
                            <span class="k">new</span> <span class="nf">Leaf</span><span class="p">(</span><span class="s">"L3"</span><span class="p">),</span>
                            <span class="k">new</span> <span class="nf">Leaf</span><span class="p">(</span><span class="s">"L4"</span><span class="p">)</span>
                        <span class="p">]</span>
                    <span class="p">}</span>
                <span class="p">]</span>
            <span class="p">}</span>
        <span class="p">]</span>
    <span class="p">};</span>

    <span class="k">return</span> <span class="n">node</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="serialization-via-systemtextjson">Serialization via <code class="language-plaintext highlighter-rouge">System.Text.Json</code>
</h2>

<p>Let’s start the naive way - just use the model as it is:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">static</span> <span class="n">IEndpointRouteBuilder</span> <span class="nf">MapBasedOnAttribute</span><span class="p">(</span><span class="k">this</span> <span class="n">IEndpointRouteBuilder</span> <span class="n">app</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">app</span><span class="p">.</span><span class="nf">MapGet</span><span class="p">(</span><span class="s">"/v{version:apiVersion}/composite"</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="nf">GetNode</span><span class="p">()</span> <span class="p">)</span>
    <span class="p">.</span><span class="nf">WithTags</span><span class="p">(</span><span class="s">"Composite"</span><span class="p">)</span>
    <span class="p">.</span><span class="nf">HasApiVersion</span><span class="p">(</span><span class="m">1</span><span class="p">)</span>
    <span class="p">.</span><span class="nf">WithOpenApi</span><span class="p">();</span>

    <span class="k">return</span> <span class="n">app</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The results are disappointing 🥲:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"children"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"N1"</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"N2"</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">],</span><span class="w">
  </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Root1"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>Fortunately, we can serialize hierarchies properly starting from .NET 7. See <a href="https://learn.microsoft.com/en-us/dotnet/standard/serialization/system-text-json/polymorphism" target="_blank" rel="noopener noreferrer">https://learn.microsoft.com/en-us/dotnet/standard/serialization/system-text-json/polymorphism</a> for more details.</p>

<h3 id="use-jsonderivedtypeattribute">Use <code class="language-plaintext highlighter-rouge">JsonDerivedTypeAttribute</code>
</h3>

<p>All you need to do is to apply <code class="language-plaintext highlighter-rouge">JsonDerivedTypeAttribute</code> to the base class of the hierarchy you want to handle.</p>

<p>Let’s try to do exactly that:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[</span><span class="nf">JsonDerivedType</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="n">Node</span><span class="p">))]</span>
<span class="p">[</span><span class="nf">JsonDerivedType</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="n">Leaf</span><span class="p">))]</span>
<span class="k">public</span> <span class="k">abstract</span> <span class="k">record</span> <span class="nc">Component</span><span class="p">(</span><span class="kt">string</span> <span class="n">Name</span><span class="p">);</span>

<span class="k">public</span> <span class="k">record</span> <span class="nc">Leaf</span><span class="p">(</span><span class="kt">string</span> <span class="n">Name</span><span class="p">)</span> <span class="p">:</span> <span class="nf">Component</span><span class="p">(</span><span class="n">Name</span><span class="p">);</span>

<span class="k">public</span> <span class="k">record</span> <span class="nc">Node</span><span class="p">(</span><span class="kt">string</span> <span class="n">Name</span><span class="p">,</span> <span class="n">IList</span><span class="p">&lt;</span><span class="n">Component</span><span class="p">&gt;?</span> <span class="n">Children</span> <span class="p">=</span> <span class="k">default</span><span class="p">)</span> <span class="p">:</span> <span class="nf">Component</span><span class="p">(</span><span class="n">Name</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="n">IList</span><span class="p">&lt;</span><span class="n">Component</span><span class="p">&gt;</span> <span class="n">Children</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">init</span><span class="p">;</span> <span class="p">}</span> <span class="p">=</span> <span class="n">Children</span> <span class="p">??</span> <span class="p">[];</span>

    <span class="k">public</span> <span class="k">void</span> <span class="nf">Add</span><span class="p">(</span><span class="n">Component</span> <span class="n">component</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="n">Children</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="n">component</span><span class="p">);</span>
<span class="p">};</span>
</code></pre></div></div>

<p>Let’s see the results:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"children"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"children"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="p">{</span><span class="w">
          </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"L1"</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="p">{</span><span class="w">
          </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"L2"</span><span class="w">
        </span><span class="p">}</span><span class="w">
      </span><span class="p">],</span><span class="w">
      </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"N1"</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"children"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="p">{</span><span class="w">
          </span><span class="nl">"children"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
            </span><span class="p">{</span><span class="w">
              </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"L3"</span><span class="w">
            </span><span class="p">},</span><span class="w">
            </span><span class="p">{</span><span class="w">
              </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"L4"</span><span class="w">
            </span><span class="p">}</span><span class="w">
          </span><span class="p">],</span><span class="w">
          </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"N3"</span><span class="w">
        </span><span class="p">}</span><span class="w">
      </span><span class="p">],</span><span class="w">
      </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"N2"</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">],</span><span class="w">
  </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Root1"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>This is better, but there is still room for improvement. We want our clients to be able properly deserialize the hierarchy. To achieve that, we need to add a <strong>type discriminator</strong> - a special JSON property containing the exact type.</p>

<p>Simply add <code class="language-plaintext highlighter-rouge">typeDiscriminator</code>:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// public JsonDerivedTypeAttribute(Type derivedType, string typeDiscriminator);</span>

<span class="p">[</span><span class="nf">JsonDerivedType</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="n">Node</span><span class="p">),</span> <span class="n">typeDiscriminator</span><span class="p">:</span> <span class="k">nameof</span><span class="p">(</span><span class="n">Node</span><span class="p">))]</span>
<span class="p">[</span><span class="nf">JsonDerivedType</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="n">Leaf</span><span class="p">),</span> <span class="n">typeDiscriminator</span><span class="p">:</span> <span class="k">nameof</span><span class="p">(</span><span class="n">Leaf</span><span class="p">))]</span>
<span class="k">public</span> <span class="k">abstract</span> <span class="k">record</span> <span class="nc">Component</span><span class="p">(</span><span class="kt">string</span> <span class="n">Name</span><span class="p">);</span>

<span class="k">public</span> <span class="k">record</span> <span class="nc">Leaf</span><span class="p">(</span><span class="kt">string</span> <span class="n">Name</span><span class="p">)</span> <span class="p">:</span> <span class="nf">Component</span><span class="p">(</span><span class="n">Name</span><span class="p">);</span>

<span class="k">public</span> <span class="k">record</span> <span class="nc">Node</span><span class="p">(</span><span class="kt">string</span> <span class="n">Name</span><span class="p">,</span> <span class="n">IList</span><span class="p">&lt;</span><span class="n">Component</span><span class="p">&gt;?</span> <span class="n">Children</span> <span class="p">=</span> <span class="k">default</span><span class="p">)</span> <span class="p">:</span> <span class="nf">Component</span><span class="p">(</span><span class="n">Name</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="n">IList</span><span class="p">&lt;</span><span class="n">Component</span><span class="p">&gt;</span> <span class="n">Children</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">init</span><span class="p">;</span> <span class="p">}</span> <span class="p">=</span> <span class="n">Children</span> <span class="p">??</span> <span class="p">[];</span>

    <span class="k">public</span> <span class="k">void</span> <span class="nf">Add</span><span class="p">(</span><span class="n">Component</span> <span class="n">component</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="n">Children</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="n">component</span><span class="p">);</span>
<span class="p">};</span>
</code></pre></div></div>

<p>Let’s see the results:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"$type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Node"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"children"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"$type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Node"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"children"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="p">{</span><span class="w">
          </span><span class="nl">"$type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Leaf"</span><span class="p">,</span><span class="w">
          </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"L1"</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="p">{</span><span class="w">
          </span><span class="nl">"$type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Leaf"</span><span class="p">,</span><span class="w">
          </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"L2"</span><span class="w">
        </span><span class="p">}</span><span class="w">
      </span><span class="p">],</span><span class="w">
      </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"N1"</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"$type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Node"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"children"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="p">{</span><span class="w">
          </span><span class="nl">"$type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Node"</span><span class="p">,</span><span class="w">
          </span><span class="nl">"children"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
            </span><span class="p">{</span><span class="w">
              </span><span class="nl">"$type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Leaf"</span><span class="p">,</span><span class="w">
              </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"L3"</span><span class="w">
            </span><span class="p">},</span><span class="w">
            </span><span class="p">{</span><span class="w">
              </span><span class="nl">"$type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Leaf"</span><span class="p">,</span><span class="w">
              </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"L4"</span><span class="w">
            </span><span class="p">}</span><span class="w">
          </span><span class="p">],</span><span class="w">
          </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"N3"</span><span class="w">
        </span><span class="p">}</span><span class="w">
      </span><span class="p">],</span><span class="w">
      </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"N2"</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">],</span><span class="w">
  </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Root1"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>Awesome, now our model serialized the way I wanted. 🙌</p>

<h3 id="use-defaultjsontypeinforesolver-in-situations-when-you-cant-apply-attributes">Use <code class="language-plaintext highlighter-rouge">DefaultJsonTypeInfoResolver</code> in situations when you can’t apply attributes</h3>

<p>The application of attributes is done during design time, which means that you specify the attributes in your code before compiling and running it. Once the attributes are applied, they become a permanent part of the program element’s definition. There are many situations when you can’t apply attributes to a model.</p>

<p>For example, cross-assembly hierarchies, third-party dependencies, etc.</p>

<p>From official docs:</p>

<blockquote>
  <p>For use cases where attribute annotations are impractical or impossible, to configure polymorphism use the contract model. The contract model is a set of APIs that can be used to configure polymorphism in a type hierarchy by creating a custom <code class="language-plaintext highlighter-rouge">DefaultJsonTypeInfoResolver</code> subclass that dynamically provides polymorphic configuration per type.</p>
</blockquote>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">class</span> <span class="nc">PolymorphicTypeResolver</span> <span class="p">:</span> <span class="n">DefaultJsonTypeInfoResolver</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">override</span> <span class="n">JsonTypeInfo</span> <span class="nf">GetTypeInfo</span><span class="p">(</span><span class="n">Type</span> <span class="n">type</span><span class="p">,</span> <span class="n">JsonSerializerOptions</span> <span class="n">options</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">JsonTypeInfo</span> <span class="n">jsonTypeInfo</span> <span class="p">=</span> <span class="k">base</span><span class="p">.</span><span class="nf">GetTypeInfo</span><span class="p">(</span><span class="n">type</span><span class="p">,</span> <span class="n">options</span><span class="p">);</span>

        <span class="n">Type</span> <span class="n">baseType</span> <span class="p">=</span> <span class="k">typeof</span><span class="p">(</span><span class="n">Component</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">jsonTypeInfo</span><span class="p">.</span><span class="n">Type</span> <span class="p">==</span> <span class="n">baseType</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">jsonTypeInfo</span><span class="p">.</span><span class="n">PolymorphismOptions</span> <span class="p">=</span> <span class="k">new</span> <span class="n">JsonPolymorphismOptions</span>
            <span class="p">{</span>
                <span class="n">TypeDiscriminatorPropertyName</span> <span class="p">=</span> <span class="s">"$type"</span><span class="p">,</span>
                <span class="n">IgnoreUnrecognizedTypeDiscriminators</span> <span class="p">=</span> <span class="k">true</span><span class="p">,</span>
                <span class="n">UnknownDerivedTypeHandling</span> <span class="p">=</span> <span class="n">JsonUnknownDerivedTypeHandling</span><span class="p">.</span><span class="n">FailSerialization</span><span class="p">,</span>
                <span class="n">DerivedTypes</span> <span class="p">=</span>
                <span class="p">{</span>
                    <span class="k">new</span> <span class="nf">JsonDerivedType</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="n">Node</span><span class="p">),</span> <span class="k">nameof</span><span class="p">(</span><span class="n">Node</span><span class="p">)),</span>
                    <span class="k">new</span> <span class="nf">JsonDerivedType</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="n">Leaf</span><span class="p">),</span> <span class="k">nameof</span><span class="p">(</span><span class="n">Leaf</span><span class="p">)),</span>
                <span class="p">}</span>
            <span class="p">};</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">jsonTypeInfo</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Here is how to add it to Minimal API:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Program.cs</span>
<span class="n">builder</span><span class="p">.</span><span class="n">Services</span><span class="p">.</span><span class="n">Configure</span><span class="p">&lt;</span><span class="n">JsonOptions</span><span class="p">&gt;(</span><span class="n">options</span> <span class="p">=&gt;</span>
<span class="p">{</span>
    <span class="n">options</span><span class="p">.</span><span class="n">SerializerOptions</span><span class="p">.</span><span class="n">TypeInfoResolver</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">PolymorphicTypeResolver</span><span class="p">();</span>
<span class="p">});</span>
</code></pre></div></div>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">namespace</span> <span class="nn">Microsoft.AspNetCore.Http.Json</span>
<span class="p">{</span>
    <span class="c1">/// &lt;summary&gt;</span>
    <span class="c1">/// Options to configure JSON serialization settings for Microsoft.AspNetCore.Http.HttpRequestJsonExtensions</span>
    <span class="c1">/// and Microsoft.AspNetCore.Http.HttpResponseJsonExtensions.</span>
    <span class="c1">/// &lt;/summary&gt;</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">JsonOptions</span>
    <span class="p">{</span>
        <span class="k">public</span> <span class="nf">JsonOptions</span><span class="p">();</span>

        <span class="c1">/// &lt;summary&gt;</span>
        <span class="c1">/// Gets the System.Text.Json.JsonSerializerOptions.</span>
        <span class="c1">/// &lt;/summary&gt;</span>
        <span class="k">public</span> <span class="n">JsonSerializerOptions</span> <span class="n">SerializerOptions</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The output is the same:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"$type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Node"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"children"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"$type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Node"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"children"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="p">{</span><span class="w">
          </span><span class="nl">"$type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Leaf"</span><span class="p">,</span><span class="w">
          </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"L1"</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="p">{</span><span class="w">
          </span><span class="nl">"$type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Leaf"</span><span class="p">,</span><span class="w">
          </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"L2"</span><span class="w">
        </span><span class="p">}</span><span class="w">
      </span><span class="p">],</span><span class="w">
      </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"N1"</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"$type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Node"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"children"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="p">{</span><span class="w">
          </span><span class="nl">"$type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Node"</span><span class="p">,</span><span class="w">
          </span><span class="nl">"children"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
            </span><span class="p">{</span><span class="w">
              </span><span class="nl">"$type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Leaf"</span><span class="p">,</span><span class="w">
              </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"L3"</span><span class="w">
            </span><span class="p">},</span><span class="w">
            </span><span class="p">{</span><span class="w">
              </span><span class="nl">"$type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Leaf"</span><span class="p">,</span><span class="w">
              </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"L4"</span><span class="w">
            </span><span class="p">}</span><span class="w">
          </span><span class="p">],</span><span class="w">
          </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"N3"</span><span class="w">
        </span><span class="p">}</span><span class="w">
      </span><span class="p">],</span><span class="w">
      </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"N2"</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">],</span><span class="w">
  </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Root1"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<h2 id="configure-openapi">Configure OpenAPI</h2>

<p>In the modern world OpenAPI documents has become a necessity. These documents serve as a contract, allowing other systems to integrate with yours seamlessly.</p>

<p>Let’s add additional OpenAPI metadata to the endpoint for demonstration purposes and see how the Swagger looks like:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">static</span> <span class="n">IEndpointRouteBuilder</span> <span class="nf">MapBasedOnAttribute</span><span class="p">(</span><span class="k">this</span> <span class="n">IEndpointRouteBuilder</span> <span class="n">app</span><span class="p">,</span> <span class="n">ApiVersionSet</span> <span class="n">versionSet</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">app</span><span class="p">.</span><span class="nf">MapGet</span><span class="p">(</span><span class="s">"/v{version:apiVersion}/composite"</span><span class="p">,</span> <span class="n">ExecuteAsync</span><span class="p">)</span>
    <span class="p">.</span><span class="nf">WithName</span><span class="p">(</span><span class="s">"GetCompositeForAttributeAnnotatedModels"</span><span class="p">)</span>
    <span class="p">.</span><span class="nf">WithTags</span><span class="p">(</span><span class="s">"Composite"</span><span class="p">)</span>
    <span class="p">.</span><span class="nf">WithApiVersionSet</span><span class="p">(</span><span class="n">versionSet</span><span class="p">)</span>
    <span class="p">.</span><span class="nf">HasApiVersion</span><span class="p">(</span><span class="m">1</span><span class="p">)</span>
    <span class="p">.</span><span class="nf">WithOpenApi</span><span class="p">(</span><span class="n">operation</span> <span class="p">=&gt;</span> <span class="k">new</span><span class="p">(</span><span class="n">operation</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">Summary</span> <span class="p">=</span> <span class="s">"Polymorphism via JsonDerivedTypeAttribute"</span><span class="p">,</span>
        <span class="n">Description</span> <span class="p">=</span> <span class="s">"Composite based on polymorphic serialization with attributes"</span><span class="p">,</span>
    <span class="p">})</span>
    <span class="p">.</span><span class="nf">ProducesProblem</span><span class="p">(</span><span class="n">StatusCodes</span><span class="p">.</span><span class="n">Status401Unauthorized</span><span class="p">);</span>

    <span class="k">return</span> <span class="n">app</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>If we open a Swagger endpoint, we can see that the schema doesn’t contain complete information about the model. That’s a pity 🙂</p>

<p><img src="/assets/openapi-polymorphism/without-openapi.png" alt="without-openapi"></p>

<div class="language-jsonc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// http://localhost:5077/swagger/v1/swagger.json</span><span class="w">

</span><span class="p">{</span><span class="w">
  </span><span class="nl">"openapi"</span><span class="p">:</span><span class="w"> </span><span class="s2">"3.0.1"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"info"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"title"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Composite V1"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"version"</span><span class="p">:</span><span class="w"> </span><span class="s2">"v1"</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"paths"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"/v1/composite"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"get"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"tags"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
          </span><span class="s2">"Composite"</span><span class="w">
        </span><span class="p">],</span><span class="w">
        </span><span class="nl">"summary"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Polymorphism via JsonDerivedTypeAttribute"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Composite based on polymorphic serialization with attributes"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"operationId"</span><span class="p">:</span><span class="w"> </span><span class="s2">"GetCompositeForAttributeAnnotatedModels"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"requestBody"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"content"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            
          </span><span class="p">}</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="nl">"responses"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"200"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"OK"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"content"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
              </span><span class="nl">"application/json"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                </span><span class="nl">"schema"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                  </span><span class="nl">"$ref"</span><span class="p">:</span><span class="w"> </span><span class="s2">"#/components/schemas/Component"</span><span class="w">
                </span><span class="p">}</span><span class="w">
              </span><span class="p">}</span><span class="w">
            </span><span class="p">}</span><span class="w">
          </span><span class="p">}</span><span class="w">
        </span><span class="p">}</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"components"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"schemas"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"Component"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"object"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"properties"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"nullable"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
          </span><span class="p">}</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="nl">"additionalProperties"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>Luckily, we can fix it by configuring OpenAPI document generation as part of <code class="language-plaintext highlighter-rouge">Swashbuckle.AspNetCore</code> NuGet package:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">services</span><span class="p">.</span><span class="nf">AddSwaggerGen</span><span class="p">(</span><span class="n">options</span> <span class="p">=&gt;</span>
<span class="p">{</span>
    <span class="n">options</span><span class="p">.</span><span class="nf">UseOneOfForPolymorphism</span><span class="p">();</span> <span class="c1">// &lt;-- add this</span>
    <span class="n">options</span><span class="p">.</span><span class="nf">UseAllOfForInheritance</span><span class="p">();</span> <span class="c1">// &lt;-- add this</span>

    <span class="n">options</span><span class="p">.</span><span class="nf">SwaggerDoc</span><span class="p">(</span><span class="s">"v1"</span><span class="p">,</span> <span class="k">new</span><span class="p">()</span> <span class="p">{</span> <span class="n">Title</span> <span class="p">=</span> <span class="s">"Composite V1"</span><span class="p">,</span> <span class="n">Version</span> <span class="p">=</span> <span class="s">"v1"</span> <span class="p">});</span>
    <span class="n">options</span><span class="p">.</span><span class="nf">SwaggerDoc</span><span class="p">(</span><span class="s">"v2"</span><span class="p">,</span> <span class="k">new</span><span class="p">()</span> <span class="p">{</span> <span class="n">Title</span> <span class="p">=</span> <span class="s">"Composite V2"</span><span class="p">,</span> <span class="n">Version</span> <span class="p">=</span> <span class="s">"v2"</span> <span class="p">});</span>

    <span class="n">options</span><span class="p">.</span><span class="n">OperationFilter</span><span class="p">&lt;</span><span class="n">SwaggerDefaultValues</span><span class="p">&gt;();</span>
<span class="p">});</span>
</code></pre></div></div>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// SwaggerGenOptionsExtensions.cs</span>

<span class="c1">/// &lt;summary&gt;</span>
<span class="c1">/// Enables polymorphic schema generation. If enabled, request and response schemas</span>
<span class="c1">/// will contain the oneOf construct to describe sub types as a set of alternative</span>
<span class="c1">/// schemas.</span>
<span class="c1">/// &lt;/summary&gt;</span>

<span class="k">public</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">UseOneOfForPolymorphism</span><span class="p">(</span><span class="k">this</span> <span class="n">SwaggerGenOptions</span> <span class="n">swaggerGenOptions</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">swaggerGenOptions</span><span class="p">.</span><span class="n">SchemaGeneratorOptions</span><span class="p">.</span><span class="n">UseOneOfForPolymorphism</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">/// &lt;summary&gt;</span>
<span class="c1">/// Enables composite schema generation. If enabled, subtype schemas will contain</span>
<span class="c1">/// the allOf construct to incorporate properties from the base class instead of</span>
<span class="c1">/// defining those properties inline.</span>
<span class="c1">/// &lt;/summary&gt;</span>
<span class="k">public</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">UseAllOfForInheritance</span><span class="p">(</span><span class="k">this</span> <span class="n">SwaggerGenOptions</span> <span class="n">swaggerGenOptions</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">swaggerGenOptions</span><span class="p">.</span><span class="n">SchemaGeneratorOptions</span><span class="p">.</span><span class="n">UseAllOfForInheritance</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p><img src="/assets/openapi-polymorphism/with-openapi.png" alt="with-openapi"></p>

<div class="language-jsonc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// http://localhost:5077/swagger/v1/swagger.json</span><span class="w">

</span><span class="p">{</span><span class="w">
  </span><span class="nl">"openapi"</span><span class="p">:</span><span class="w"> </span><span class="s2">"3.0.1"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"info"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"title"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Composite V1"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"version"</span><span class="p">:</span><span class="w"> </span><span class="s2">"v1"</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"paths"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"/v1/composite"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"get"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"tags"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
          </span><span class="s2">"Composite"</span><span class="w">
        </span><span class="p">],</span><span class="w">
        </span><span class="nl">"summary"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Polymorphism via JsonDerivedTypeAttribute"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Composite based on polymorphic serialization with attributes"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"operationId"</span><span class="p">:</span><span class="w"> </span><span class="s2">"GetCompositeForAttributeAnnotatedModels"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"requestBody"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"content"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            
          </span><span class="p">}</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="nl">"responses"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"200"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"OK"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"content"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
              </span><span class="nl">"application/json"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                </span><span class="nl">"schema"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                  </span><span class="nl">"oneOf"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
                    </span><span class="p">{</span><span class="w">
                      </span><span class="nl">"$ref"</span><span class="p">:</span><span class="w"> </span><span class="s2">"#/components/schemas/Leaf"</span><span class="w">
                    </span><span class="p">},</span><span class="w">
                    </span><span class="p">{</span><span class="w">
                      </span><span class="nl">"$ref"</span><span class="p">:</span><span class="w"> </span><span class="s2">"#/components/schemas/Node"</span><span class="w">
                    </span><span class="p">}</span><span class="w">
                  </span><span class="p">]</span><span class="w">
                </span><span class="p">}</span><span class="w">
              </span><span class="p">}</span><span class="w">
            </span><span class="p">}</span><span class="w">
          </span><span class="p">}</span><span class="w">
        </span><span class="p">}</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"components"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"schemas"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"Component"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"object"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"properties"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"nullable"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
          </span><span class="p">}</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="nl">"additionalProperties"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="nl">"Leaf"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"object"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"allOf"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
          </span><span class="p">{</span><span class="w">
            </span><span class="nl">"$ref"</span><span class="p">:</span><span class="w"> </span><span class="s2">"#/components/schemas/Component"</span><span class="w">
          </span><span class="p">}</span><span class="w">
        </span><span class="p">],</span><span class="w">
        </span><span class="nl">"additionalProperties"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="nl">"Node"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"object"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"allOf"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
          </span><span class="p">{</span><span class="w">
            </span><span class="nl">"$ref"</span><span class="p">:</span><span class="w"> </span><span class="s2">"#/components/schemas/Component"</span><span class="w">
          </span><span class="p">}</span><span class="w">
        </span><span class="p">],</span><span class="w">
        </span><span class="nl">"properties"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"children"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"array"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"items"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
              </span><span class="nl">"oneOf"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
                </span><span class="p">{</span><span class="w">
                  </span><span class="nl">"$ref"</span><span class="p">:</span><span class="w"> </span><span class="s2">"#/components/schemas/Leaf"</span><span class="w">
                </span><span class="p">},</span><span class="w">
                </span><span class="p">{</span><span class="w">
                  </span><span class="nl">"$ref"</span><span class="p">:</span><span class="w"> </span><span class="s2">"#/components/schemas/Node"</span><span class="w">
                </span><span class="p">}</span><span class="w">
              </span><span class="p">]</span><span class="w">
            </span><span class="p">},</span><span class="w">
            </span><span class="nl">"nullable"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
          </span><span class="p">}</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="nl">"additionalProperties"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<h2 id="conclusion">Conclusion</h2>

<p>In this article, we’ve explored how to serialize a model hierarchy using <code class="language-plaintext highlighter-rouge">System.Text.Json</code> in ASP.NET Core Minimal API. We’ve seen how to use <code class="language-plaintext highlighter-rouge">JsonDerivedTypeAttribute</code> and <code class="language-plaintext highlighter-rouge">DefaultJsonTypeInfoResolver</code> to handle polymorphic serialization, allowing us to accurately represent complex object hierarchies in JSON format. We’ve also discussed how to configure OpenAPI to provide a clear and accurate representation of our serialized data.</p>

<h2 id="references">References</h2>

<ul>
  <li><a href="https://learn.microsoft.com/en-us/dotnet/standard/serialization/system-text-json/polymorphism" target="_blank" rel="noopener noreferrer">https://learn.microsoft.com/en-us/dotnet/standard/serialization/system-text-json/polymorphism</a></li>
  <li><a href="https://github.com/dotnet/aspnet-api-versioning" target="_blank" rel="noopener noreferrer">https://github.com/dotnet/aspnet-api-versioning</a></li>
  <li><a href="https://github.com/dotnet/aspnet-api-versioning/blob/main/examples/AspNetCore/WebApi/MinimalOpenApiExample/Program.cs" target="_blank" rel="noopener noreferrer">https://github.com/dotnet/aspnet-api-versioning/blob/main/examples/AspNetCore/WebApi/MinimalOpenApiExample/Program.cs</a></li>
  <li><a href="https://learn.microsoft.com/en-us/aspnet/core/fundamentals/minimal-apis/handle-errors?view=aspnetcore-8.0#problem-details" target="_blank" rel="noopener noreferrer">https://learn.microsoft.com/en-us/aspnet/core/fundamentals/minimal-apis/handle-errors?view=aspnetcore-8.0#problem-details</a></li>
  <li><a href="https://github.com/dotnet/aspnetcore/issues/54599" target="_blank" rel="noopener noreferrer">https://github.com/dotnet/aspnetcore/issues/54599</a></li>
</ul>

	</div>

	

	
	<ul class="tag_box list-unstyled list-inline">
		<li><i class="fa fa-folder-open"></i></li>
		
		
		
		<li><a href="https://nikiforovall.github.io/categories.html#dotnet-ref" target="_blank" rel="noopener noreferrer">
				dotnet <span>(54)</span>
				,
			</a></li>
		
		<li><a href="https://nikiforovall.github.io/categories.html#aspnetcore-ref" target="_blank" rel="noopener noreferrer">
				aspnetcore <span>(11)</span>
				
			</a></li>
		
		
	</ul>
	

	
	<ul class="list-inline">
		<li><i class="fa fa-tags"></i></li>
		
		
		
		<li>
			<a href="https://nikiforovall.github.io/tags.html#dotnet-ref" target="_blank" rel="noopener noreferrer">
				dotnet <span>(59)</span>
				,
			</a>
		</li>
		
		<li>
			<a href="https://nikiforovall.github.io/tags.html#aspnetcore-ref" target="_blank" rel="noopener noreferrer">
				aspnetcore <span>(24)</span>
				,
			</a>
		</li>
		
		<li>
			<a href="https://nikiforovall.github.io/tags.html#openapi-ref" target="_blank" rel="noopener noreferrer">
				openapi <span>(4)</span>
				,
			</a>
		</li>
		
		<li>
			<a href="https://nikiforovall.github.io/tags.html#minimal-api-ref" target="_blank" rel="noopener noreferrer">
				minimal-api <span>(2)</span>
				
			</a>
		</li>
		
		
		
	</ul>
	

	<hr>

	<div>
		<section class="share col-sm-6">
			<h4 class="section-title">Share Post</h4>
			<a class="btn btn-default btn-sm twitter" href="http://twitter.com/share?&amp;via=nikiforovall" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;" target="_blank" rel="noopener noreferrer">
				<i class="fa fa-twitter fa-lg"></i>
				Twitter
			</a>
		</section>

		<section class="col-sm-6 author">
			<img src="//www.gravatar.com/avatar/e86fa0938976c38907a302ecb208f011" class="img-rounded author-image">
			<h4 class="section-title author-name">Oleksii Nikiforov</h4>
			<p class="author-bio">Jibber-jabbering about programming and IT.</p>
		</section>
	</div>

	<div class="clearfix"></div>

	<ul class="pager">
		
		<li class="previous"><a href="https://nikiforovall.github.io/dotnet/aspnetcore/aspire/2024/03/30/aspire-cap.html" title="Transactional Outbox in .NET Cloud Native Development via Aspire" target="_blank" rel="noopener noreferrer">←
				Previous</a></li>
		
		
		<li class="next">
<a href="https://nikiforovall.github.io/dotnet/async/2024/04/21/channels-composition.html" title="Building pipelines with System.Threading.Channels" target="_blank" rel="noopener noreferrer">Next →</a>
		</li>
		
	</ul>

	<hr>
	</div>

	<div class="col-sm-2 sidebar-2">

	</div>

</article>
<div class="clearfix"></div>



    
    <script src="https://utteranc.es/client.js" repo="NikiforovAll/nikiforovall.github.io" issue-term="pathname" label="Blog" theme="preferred-color-scheme" crossorigin="anonymous" async>
    </script>





		<footer>
			<hr>
			<p>
				© 2025 Oleksii Nikiforov with <a href="http://jekyllrb.com/" target="_blank" rel="noopener noreferrer">Jekyll</a>. Theme: <a href="https://github.com/dbtek/dbyll" target="_blank" rel="noopener noreferrer">dbyll</a> by dbtek.
			</p>
		</footer>
	</div>

	<script type="text/javascript" src="https://nikiforovall.github.io/assets/resources/jquery/jquery.min.js"></script>
	<script type="text/javascript" src="https://nikiforovall.github.io/assets/resources/bootstrap/js/bootstrap.min.js"></script>
	<script type="text/javascript" src="https://nikiforovall.github.io/assets/js/app.js"></script>
	
		<script type="text/javascript" src="https://unpkg.com/mermaid@10.9.0/dist/mermaid.min.js">
</script>
<script>
$(document).ready(function() {
    mermaid.initialize({
        theme: 'forest'
    });
});
</script>

	
</body>
</html>



<!-- Asynchronous Google Analytics snippet -->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-164555539-1', 'auto');
  ga('send', 'pageview');
</script>

