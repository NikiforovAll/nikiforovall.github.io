<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<!-- <meta http-equiv="Content-Security-Policy" content="frame-src https://try.dot.net;"> -->
	<title>Creating and Using HTTP Client SDKs in .NET 6</title>
	
	<meta name="author" content="Oleksii Nikiforov">

	<!-- Enable responsive viewport -->
	<meta name="viewport" content="width=device-width, initial-scale=1.0">

	<!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
	<!--[if lt IE 9]>
	<script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
	<![endif]-->

	<!-- Le styles -->
	<link href="https://nikiforovall.github.io/assets/resources/bootstrap/css/bootstrap.min.css" rel="stylesheet">
	<link href="https://nikiforovall.github.io/assets/resources/font-awesome/css/font-awesome.min.css" rel="stylesheet">
	<link href="https://nikiforovall.github.io/assets/resources/syntax/syntax.css" rel="stylesheet">
	<link href="https://nikiforovall.github.io/assets/css/style.css" rel="stylesheet">

	<!-- Le fav and touch icons -->
	<!-- Update these with your own images
	<link rel="shortcut icon" href="images/favicon.ico">
	<link rel="apple-touch-icon" href="images/apple-touch-icon.png">
	<link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
	<link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
	-->
	<link rel="shortcut icon" href="/assets/media/favicon.ico">

	<link rel="alternate" type="application/rss+xml" title="" href="https://nikiforovall.github.io/feed.xml">
</head>

<body>
	<nav class="navbar navbar-default visible-xs" role="navigation">
		<!-- Brand and toggle get grouped for better mobile display -->
		<div class="navbar-header">
			<button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
				<span class="sr-only">Toggle navigation</span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</button>
			
			<a type="button" class="navbar-toggle nav-link" href="http://github.com/nikiforovAll" target="_blank" rel="noopener noreferrer">
				<i class="fa fa-github"></i>
			</a>
			
			
			<a type="button" class="navbar-toggle nav-link" href="http://twitter.com/nikiforovall" target="_blank" rel="noopener noreferrer">
				<i class="fa fa-twitter"></i>
			</a>
			
			
			<a type="button" class="navbar-toggle nav-link" href="mailto:alexey.nikiforovall@gmail.com">
				<i class="fa fa-envelope"></i>
			</a>
			
			<a class="navbar-brand" href="https://nikiforovall.github.io/" target="_blank" rel="noopener noreferrer">
				<img src="//www.gravatar.com/avatar/e86fa0938976c38907a302ecb208f011?s=35" class="img-circle">
				N+1 Blog
			</a>
		</div>

		<!-- Collect the nav links, forms, and other content for toggling -->
		<div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
			<ul class="nav navbar-nav">
				<li class="active"><a href="https://nikiforovall.github.io/" target="_blank" rel="noopener noreferrer">Home</a></li>
				<li><a href="https://nikiforovall.github.io/categories.html" target="_blank" rel="noopener noreferrer">Categories</a></li>
				<li><a href="https://nikiforovall.github.io/tags.html" target="_blank" rel="noopener noreferrer">Tags</a></li>
				<li><a href="https://nikiforovall.github.io/about.html" target="_blank" rel="noopener noreferrer">About</a></li>
			</ul>
		</div>
<!-- /.navbar-collapse -->
	</nav>

	<!-- nav-menu-dropdown -->
	<div class="btn-group hidden-xs" id="nav-menu">
		<button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">
			<i class="fa fa-bars"></i>
		</button>
		<ul class="dropdown-menu" role="menu">
			<li><a href="https://nikiforovall.github.io/" target="_blank" rel="noopener noreferrer"><i class="fa fa-home"></i>Home</a></li>
			<li><a href="https://nikiforovall.github.io/categories.html" target="_blank" rel="noopener noreferrer"><i class="fa fa-folder"></i>Categories</a></li>
			<li><a href="https://nikiforovall.github.io/tags.html" target="_blank" rel="noopener noreferrer"><i class="fa fa-tags"></i>Tags</a></li>
			<li><a href="https://nikiforovall.github.io/about.html" target="_blank" rel="noopener noreferrer"><i class="fa fa-pencil"></i>About</a></li>
			<li class="divider">
			<li><a href="#"><i class="fa fa-arrow-up"></i>Top of Page</a></li>
		</ul>
	</div>

	<div class="col-sm-3 sidebar hidden-xs" style="">
		<!-- sidebar.html -->
<header class="sidebar-header" role="banner">
	<a href="https://nikiforovall.github.io/" target="_blank" rel="noopener noreferrer">
		<img src="//www.gravatar.com/avatar/e86fa0938976c38907a302ecb208f011?s=150" class="img-circle">
	</a>
	<h3 class="title">
        <a href="https://nikiforovall.github.io/" target="_blank" rel="noopener noreferrer">N+1 Blog</a>
    </h3>
</header>


<div id="bio" class="text-center">
	Jibber-jabbering about programming and IT.
</div>


<div id="contact-list" class="text-center">
	<ul class="list-unstyled list-inline">
		
		<li>
			<a class="btn btn-default btn-sm" href="https://github.com/nikiforovAll" target="_blank" rel="noopener noreferrer">
				<i class="fa fa-github-alt fa-lg"></i>
			</a>
		</li>
		
		
		<li>
			<a class="btn btn-default btn-sm" href="https://twitter.com/nikiforovall" target="_blank" rel="noopener noreferrer">
				<i class="fa fa-twitter fa-lg"></i>
			</a>
		</li>
		
		
		<li>
			<a class="btn btn-default btn-sm" href="https://t.me/nikiforovallblog" target="_blank" rel="noopener noreferrer">
				<i class="fa fa-pencil-square fa-lg"></i>
			</a>
		</li>
		
		
		<li>
			<a class="btn btn-default btn-sm" href="mailto:alexey.nikiforovall@gmail.com">
				<i class="fa fa-envelope fa-lg"></i>
			</a>
		</li>
		
	</ul>
	<ul id="contact-list-secondary" class="list-unstyled list-inline">
		
		
		<li>
			<a class="btn btn-default btn-sm" href="https://linkedin.com/in/nikiforov-oleksii" target="_blank" rel="noopener noreferrer">
				<i class="fa fa-linkedin fa-lg"></i>
			</a>
		</li>
		
		<li>
			<a class="btn btn-default btn-sm" href="https://nikiforovall.github.io/feed.xml" target="_blank" rel="noopener noreferrer">
				<i class="fa fa-rss fa-lg"></i>
			</a>
		</li>
	</ul>
</div>
<!-- sidebar.html end -->

	</div>

	<div class="col-sm-9 col-sm-offset-3">
		<div class="page-header">
	<h1>Creating and Using HTTP Client SDKs in .NET 6 </h1>
</div>
<article>

	<div class="col-sm-10">

		<span class="post-date">
			
			April
			4th,
			
			2022
		</span>

	

	<div class="article_body" style="margin-top: 30px;">
		<h2 id="tldr">TL;DR</h2>

<p>Learn three ways you can develop HTTP Client SDKs in .NET. Source code: <a href="https://github.com/NikiforovAll/http-sdk-guide" target="_blank" rel="noopener noreferrer">https://github.com/NikiforovAll/http-sdk-guide</a></p>

<ul>
  <li><a href="#tldr">TL;DR</a></li>
  <li><a href="#key-takeaways">Key Takeaways</a></li>
  <li><a href="#introduction">Introduction</a></li>
  <li>
<a href="#writing-http-client-sdk">Writing HTTP Client SDK</a>
    <ul>
      <li><a href="#client-lifetime">Client Lifetime</a></li>
    </ul>
  </li>
  <li>
<a href="#consuming-api-clients">Consuming API Clients</a>
    <ul>
      <li><a href="#consuming-api-clients-httpclientfactory">Consuming API Clients. HttpClientFactory</a></li>
    </ul>
  </li>
  <li>
<a href="#extending-http-client-sdks-adding-cross-cutting-concerns-via-delegatinghandler">Extending HTTP Client SDKs. Adding cross-cutting concerns via DelegatingHandler</a>
    <ul>
      <li><a href="#third-party-extensions">Third-Party Extensions</a></li>
    </ul>
  </li>
  <li><a href="#testing-http-client-sdks">Testing HTTP Client SDKs</a></li>
  <li><a href="#writing-http-client-sdk-declarative-approach">Writing HTTP Client SDK. Declarative approach</a></li>
  <li><a href="#consuming-api-clients-refit">Consuming API Clients. Refit</a></li>
  <li><a href="#writing-http-client-sdk-automated-approach">Writing HTTP Client SDK. Automated approach</a></li>
  <li><a href="#choosing-the-right-approach">Choosing the right approach</a></li>
  <li><a href="#summary">Summary</a></li>
  <li><a href="#reference">Reference</a></li>
</ul>

<h2 id="key-takeaways">Key Takeaways</h2>

<ol>
  <li>Writing and maintaining HTTP Client SDKs is a very important skill for modern .NET developers working with distributed systems.</li>
  <li>In order to properly manage HTTP connections, you need to design your API Clients to be ready to be consumed from any Dependency Injection container.</li>
  <li>A good client SDK is composable, providing straightforward ways to configure and extend it.</li>
  <li>Testing HTTP Client SDKs can be very beneficial in certain scenarios and it gives you additional confidence in your code.</li>
  <li>There are many ways of developing HTTP Client SDKs. This article helps you to choose the right one according to your scenario.</li>
</ol>

<h2 id="introduction">Introduction</h2>

<p>Today’s cloud-based, microservice-based or internet-of-things applications often depend on communicating with other systems across a network. Each service runs in its process and solves a bounded set of problems. Communication between services is based on a lightweight mechanism, often an HTTP resource API.</p>

<p>From a .NET developer perspective, we want to provide a consistent and manageable way of integrating with a particular service in the form of a distributable package. Preferably, we also want to ship the service integration code we develop as a NuGet package and share it with other people, teams, or even organizations. In this article, I will share many aspects of creating and using HTTP Client SDKs using .NET 6.</p>

<p>Client SDKs provide a meaningful abstraction layer over remote service. Essentially, it allows making <a href="https://en.wikipedia.org/wiki/Remote_procedure_call" target="_blank" rel="noopener noreferrer">Remote Procedure Calls (RPC)</a>. The responsibility of a Client SDK is to serialize some data, send it to remote, deserialize and process a response.</p>

<p>The main benefits of API SDKs:</p>

<ol>
  <li>It speedups the API integration process</li>
  <li>Provides a consistent and standard approach</li>
  <li>Gives somewhat control to service owners over the way APIs are consumed</li>
</ol>

<h2 id="writing-http-client-sdk">Writing HTTP Client SDK</h2>

<p>Throughout this article, we will write full-functioning <a href="https://rapidapi.com/KegenGuyll/api/dad-jokes/" target="_blank" rel="noopener noreferrer">Dad Jokes API Client</a>. It serves dad jokes, let’s have some fun. It is a good idea to start from the contract.</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">interface</span> <span class="nc">IDadJokesApiClient</span>
<span class="p">{</span>
    <span class="n">Task</span><span class="p">&lt;</span><span class="n">JokeSearchResponse</span><span class="p">&gt;</span> <span class="nf">SearchAsync</span><span class="p">(</span>
      <span class="kt">string</span> <span class="n">term</span><span class="p">,</span> <span class="n">CancellationToken</span> <span class="n">cancellationToken</span><span class="p">);</span>

    <span class="n">Task</span><span class="p">&lt;</span><span class="n">Joke</span><span class="p">&gt;</span> <span class="nf">GetJokeByIdAsync</span><span class="p">(</span>
        <span class="kt">string</span> <span class="n">id</span><span class="p">,</span> <span class="n">CancellationToken</span> <span class="n">cancellationToken</span><span class="p">);</span>

    <span class="n">Task</span><span class="p">&lt;</span><span class="n">Joke</span><span class="p">&gt;</span> <span class="nf">GetRandomJokeAsync</span><span class="p">(</span><span class="n">CancellationToken</span> <span class="n">cancellationToken</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">public</span> <span class="k">class</span> <span class="nc">JokeSearchResponse</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="kt">bool</span> <span class="n">Success</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">init</span><span class="p">;</span> <span class="p">}</span>

    <span class="k">public</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">Joke</span><span class="p">&gt;</span> <span class="n">Body</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">init</span><span class="p">;</span> <span class="p">}</span> <span class="p">=</span> <span class="k">new</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">public</span> <span class="k">class</span> <span class="nc">Joke</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="kt">string</span> <span class="n">Punchline</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span> <span class="p">=</span> <span class="k">default</span><span class="p">!;</span>

    <span class="k">public</span> <span class="kt">string</span> <span class="n">Setup</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span> <span class="p">=</span> <span class="k">default</span><span class="p">!;</span>

    <span class="k">public</span> <span class="kt">string</span> <span class="n">Type</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span> <span class="p">=</span> <span class="k">default</span><span class="p">!;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The contract is created based on an API you are integrating with. My general recommendations are to develop common-purpose APIs and follow <a href="https://en.wikipedia.org/wiki/Robustness_principle" target="_blank" rel="noopener noreferrer">Robustness Principle</a> and <a href="https://en.wikipedia.org/wiki/Principle_of_least_astonishment" target="_blank" rel="noopener noreferrer">Principle of least astonishment</a>. But it is totally fine if you want to modify and transform data contract based on your needs. Just think about it from a consumer perspective.</p>

<p>The bread and butter of HTTP-based integrations is <code class="language-plaintext highlighter-rouge">HttpClient</code>. It contains everything you need to successfully work with <a href="https://datatracker.ietf.org/doc/html/rfc2616/" target="_blank" rel="noopener noreferrer">HTTP</a> abstractions.</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">class</span> <span class="nc">DadJokesApiClient</span> <span class="p">:</span> <span class="n">IDadJokesApiClient</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="n">HttpClient</span> <span class="n">httpClient</span><span class="p">;</span>

    <span class="k">public</span> <span class="nf">DadJokesApiClient</span><span class="p">(</span><span class="n">HttpClient</span> <span class="n">httpClient</span><span class="p">)</span> <span class="p">=&gt;</span>
        <span class="k">this</span><span class="p">.</span><span class="n">httpClient</span> <span class="p">=</span> <span class="n">httpClient</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Usually, we deal with JSON over HTTP APIs, so in .NET 5 <code class="language-plaintext highlighter-rouge">System.Net.Http.Json</code> namespace was added to BCL. It provides many extension methods for <code class="language-plaintext highlighter-rouge">HttpClient</code> and <code class="language-plaintext highlighter-rouge">HttpContent</code> that perform serialization and deserialization using <code class="language-plaintext highlighter-rouge">System.Text.Json</code>. If you don’t have something complex and exotic I would suggest using <code class="language-plaintext highlighter-rouge">System.Net.Http.Json</code> because it frees you from writing boilerplate code. Not only it is boring, but it also is not trivial to get it right in the most efficient and bug-free way from the get-go. I suggest you check <a href="https://www.stevejgordon.co.uk/sending-and-receiving-json-using-httpclient-with-system-net-http-json" target="_blank" rel="noopener noreferrer">Steves’ Gordon blog post - sending and receiving JSON using HttpClient</a></p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">Joke</span><span class="p">&gt;</span> <span class="nf">GetRandomJokeAsync</span><span class="p">(</span><span class="n">CancellationToken</span> <span class="n">cancellationToken</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">var</span> <span class="n">jokes</span> <span class="p">=</span> <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="n">httpClient</span><span class="p">.</span><span class="n">GetFromJsonAsync</span><span class="p">&lt;</span><span class="n">JokeSearchResponse</span><span class="p">&gt;(</span>
        <span class="n">ApiUrlConstants</span><span class="p">.</span><span class="n">GetRandomJoke</span><span class="p">,</span> <span class="n">cancellationToken</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">jokes</span> <span class="k">is</span> <span class="p">{</span> <span class="n">Body</span><span class="p">.</span><span class="n">Count</span><span class="p">:</span> <span class="m">0</span> <span class="p">}</span> <span class="k">or</span> <span class="p">{</span> <span class="n">Success</span><span class="p">:</span> <span class="k">false</span> <span class="p">})</span>
    <span class="p">{</span>
        <span class="c1">// consider creating custom exceptions for situations like this</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">InvalidOperationException</span><span class="p">(</span><span class="s">"This API is no joke."</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">jokes</span><span class="p">.</span><span class="n">Body</span><span class="p">.</span><span class="nf">First</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div></div>

<p>💡 Tip: You may want to create some centralized place to manage the endpoints URLs, like this:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">static</span> <span class="k">class</span> <span class="nc">ApiUrlConstants</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">const</span> <span class="kt">string</span> <span class="n">JokeSearch</span> <span class="p">=</span> <span class="s">"/joke/search"</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">const</span> <span class="kt">string</span> <span class="n">GetJokeById</span> <span class="p">=</span> <span class="s">"/joke"</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">const</span> <span class="kt">string</span> <span class="n">GetRandomJoke</span> <span class="p">=</span> <span class="s">"/random/joke"</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>💡 Tip: If you need to deal with complex URIs - use <a href="https://flurl.dev/docs/fluent-url/" target="_blank" rel="noopener noreferrer">Flurl</a>. It provides fluent URL building experience.</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">Joke</span><span class="p">&gt;</span> <span class="nf">GetJokeByIdAsync</span><span class="p">(</span><span class="kt">string</span> <span class="n">id</span><span class="p">,</span> <span class="n">CancellationToken</span> <span class="n">cancellationToken</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// $"{ApiUrlConstants.GetJokeById}/{id}"</span>
    <span class="kt">var</span> <span class="n">path</span> <span class="p">=</span> <span class="n">ApiUrlConstants</span><span class="p">.</span><span class="n">GetJokeById</span><span class="p">.</span><span class="nf">AppendPathSegment</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>

    <span class="kt">var</span> <span class="n">joke</span> <span class="p">=</span> <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="n">httpClient</span><span class="p">.</span><span class="n">GetFromJsonAsync</span><span class="p">&lt;</span><span class="n">Joke</span><span class="p">&gt;(</span><span class="n">path</span><span class="p">,</span> <span class="n">cancellationToken</span><span class="p">);</span>

    <span class="k">return</span> <span class="n">joke</span> <span class="p">??</span> <span class="k">new</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Next, we need to specify required headers (or some other required configuration). We want to provide a flexible mechanism for configuring <code class="language-plaintext highlighter-rouge">HttpClient</code> used as part of SDK. In this case, we need to supply credentials in the custom header and specify a well-known “Accept” header.</p>

<p>💡 Tip: Expose high-level building blocks as <code class="language-plaintext highlighter-rouge">HttpClientExtensions</code>. It makes it easy to discover API specific configuration. For example, if you have a custom authorization mechanism it should be supported by SDK (at least provide documentation for it).</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">static</span> <span class="k">class</span> <span class="nc">HttpClientExtensions</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">static</span> <span class="n">HttpClient</span> <span class="nf">AddDadJokesHeaders</span><span class="p">(</span>
        <span class="k">this</span> <span class="n">HttpClient</span> <span class="n">httpClient</span><span class="p">,</span> <span class="kt">string</span> <span class="n">host</span><span class="p">,</span> <span class="kt">string</span> <span class="n">apiKey</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">headers</span> <span class="p">=</span> <span class="n">httpClient</span><span class="p">.</span><span class="n">DefaultRequestHeaders</span><span class="p">;</span>
        <span class="n">headers</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="n">ApiConstants</span><span class="p">.</span><span class="n">HostHeader</span><span class="p">,</span> <span class="k">new</span> <span class="nf">Uri</span><span class="p">(</span><span class="n">host</span><span class="p">).</span><span class="n">Host</span><span class="p">);</span>
        <span class="n">headers</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="n">ApiConstants</span><span class="p">.</span><span class="n">ApiKeyHeader</span><span class="p">,</span> <span class="n">apiKey</span><span class="p">);</span>

        <span class="k">return</span> <span class="n">httpClient</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="client-lifetime">Client Lifetime</h3>

<p>To construct <code class="language-plaintext highlighter-rouge">DadJokesApiClient</code> we need to create <code class="language-plaintext highlighter-rouge">HttpClient</code>. As you know, <code class="language-plaintext highlighter-rouge">HttpClient</code> implements <code class="language-plaintext highlighter-rouge">IDisposable</code> because there is an underlying unmanageable resource - TCP connection. There is a limited amount of concurrent TCP connections that can be opened simultaneously on a single machine. So, it brings an important question - “Should I create HttpClient every time I need it or only once during an application startup?”</p>

<p><code class="language-plaintext highlighter-rouge">HttpClient</code> is actually a shared object. This means that under the covers it is <a href="https://en.wikipedia.org/wiki/Reentrancy_(computing)" target="_blank" rel="noopener noreferrer">reentrant</a> and thread-safe. Instead of creating a new instance of <code class="language-plaintext highlighter-rouge">HttpClient</code> for each execution, you should share a single instance of <code class="language-plaintext highlighter-rouge">HttpClient</code>. However, this comes with its own set of issues. For example, the client will keep connections open for the lifespan of the application, it won’t respect the <a href="https://en.wikipedia.org/wiki/Time_to_live" target="_blank" rel="noopener noreferrer">DNS TTL</a> settings and it will never get DNS updates. So this isn’t a perfect solution either.</p>

<p>Basically, you need to manage a pool of TCP connections that are disposed from time to time to respect DNS updates. This is exactly what <code class="language-plaintext highlighter-rouge">HttpClientFactory</code> does. The official <a href="https://docs.microsoft.com/en-us/dotnet/architecture/microservices/implement-resilient-applications/use-httpclientfactory-to-implement-resilient-http-requests" target="_blank" rel="noopener noreferrer">documentation describes</a> <code class="language-plaintext highlighter-rouge">HttpClientFactory</code> as being “an opinionated factory for creating HttpClient instances to be used in your applications”. We will see how to use it in a moment.</p>

<p>Each time you get an <code class="language-plaintext highlighter-rouge">HttpClient</code> object from the <code class="language-plaintext highlighter-rouge">IHttpClientFactory</code>, a new instance is returned. But each <code class="language-plaintext highlighter-rouge">HttpClient</code> uses an <code class="language-plaintext highlighter-rouge">HttpMessageHandler</code> that’s pooled and reused by the <code class="language-plaintext highlighter-rouge">IHttpClientFactory</code> to reduce resource consumption. Pooling of handlers is desirable as each handler typically manages its own underlying HTTP connections. Some handlers also keep connections open indefinitely, which can prevent the handler from reacting to DNS changes. <code class="language-plaintext highlighter-rouge">HttpMessageHandler</code> has a limited lifetime.</p>

<p>Down below you can see how <code class="language-plaintext highlighter-rouge">HttpClientFactory</code> comes into play when using <code class="language-plaintext highlighter-rouge">HttpClient</code> managed by DI.</p>

<p><img src="/assets/http-sdk/http-factory.png" alt="http-factory"></p>

<h2 id="consuming-api-clients">Consuming API Clients</h2>

<p>The very basic scenario is a console application without a dependency injection container. The goal here is to give consumers the fastest way possible to integrate.</p>

<p>💡 Create static factory method that creates an API Client.</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">static</span> <span class="k">class</span> <span class="nc">DadJokesApiClientFactory</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">static</span> <span class="n">IDadJokesApiClient</span> <span class="nf">Create</span><span class="p">(</span><span class="kt">string</span> <span class="n">host</span><span class="p">,</span> <span class="kt">string</span> <span class="n">apiKey</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">httpClient</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">HttpClient</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="n">BaseAddress</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Uri</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="nf">ConfigureHttpClient</span><span class="p">(</span><span class="n">httpClient</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">apiKey</span><span class="p">);</span>

        <span class="k">return</span> <span class="k">new</span> <span class="nf">DadJokesApiClient</span><span class="p">(</span><span class="n">httpClient</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">internal</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">ConfigureHttpClient</span><span class="p">(</span>
        <span class="n">HttpClient</span> <span class="n">httpClient</span><span class="p">,</span> <span class="kt">string</span> <span class="n">host</span><span class="p">,</span> <span class="kt">string</span> <span class="n">apiKey</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nf">ConfigureHttpClientCore</span><span class="p">(</span><span class="n">httpClient</span><span class="p">);</span>
        <span class="n">httpClient</span><span class="p">.</span><span class="nf">AddDadJokesHeaders</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">apiKey</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">internal</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">ConfigureHttpClientCore</span><span class="p">(</span><span class="n">HttpClient</span> <span class="n">httpClient</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">httpClient</span><span class="p">.</span><span class="n">DefaultRequestHeaders</span><span class="p">.</span><span class="n">Accept</span><span class="p">.</span><span class="nf">Clear</span><span class="p">();</span>
        <span class="n">httpClient</span><span class="p">.</span><span class="n">DefaultRequestHeaders</span><span class="p">.</span><span class="n">Accept</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="k">new</span><span class="p">(</span><span class="s">"application/json"</span><span class="p">));</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Finally, we can use <code class="language-plaintext highlighter-rouge">IDadJokesApiClient</code> from the console application:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">var</span> <span class="n">host</span> <span class="p">=</span> <span class="s">"https://dad-jokes.p.rapidapi.com"</span><span class="p">;</span>
<span class="kt">var</span> <span class="n">apiKey</span> <span class="p">=</span> <span class="s">"&lt;token&gt;"</span><span class="p">;</span>

<span class="kt">var</span> <span class="n">client</span> <span class="p">=</span> <span class="n">DadJokesApiClientFactory</span><span class="p">.</span><span class="nf">Create</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">apiKey</span><span class="p">);</span>
<span class="kt">var</span> <span class="n">joke</span> <span class="p">=</span> <span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="nf">GetRandomJokeAsync</span><span class="p">();</span>

<span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">$"</span><span class="p">{</span><span class="n">joke</span><span class="p">.</span><span class="n">Setup</span><span class="p">}</span><span class="s"> </span><span class="p">{</span><span class="n">joke</span><span class="p">.</span><span class="n">Punchline</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>
</code></pre></div></div>

<p><img src="/assets/http-sdk/manual-client-console-host.png" alt="manual-client-console-host"></p>

<h3 id="consuming-api-clients-httpclientfactory">Consuming API Clients. HttpClientFactory</h3>

<p>The next step is to configure <code class="language-plaintext highlighter-rouge">HttpClient</code> as part of a <em>Dependency Injection</em> container. I will not go into details, there is a lot of good stuff on the internet. Once again, there is a really good article from <a href="https://www.stevejgordon.co.uk/httpclientfactory-named-typed-clients-aspnetcore" target="_blank" rel="noopener noreferrer">Steve’s Gordon - HttpClientFactory in ASP.NET Core</a></p>

<p>To add pooled <code class="language-plaintext highlighter-rouge">HttpClient</code> to DI you need to use <code class="language-plaintext highlighter-rouge">IServiceCollection.AddHttpClient</code> from <code class="language-plaintext highlighter-rouge">Microsoft.Extensions.Http</code>.</p>

<p>💡 Provide a custom extension method to add typed <code class="language-plaintext highlighter-rouge">HttpClient</code> in DI.</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">static</span> <span class="k">class</span> <span class="nc">ServiceCollectionExtensions</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">static</span> <span class="n">IHttpClientBuilder</span> <span class="nf">AddDadJokesApiClient</span><span class="p">(</span>
        <span class="k">this</span> <span class="n">IServiceCollection</span> <span class="n">services</span><span class="p">,</span>
        <span class="n">Action</span><span class="p">&lt;</span><span class="n">HttpClient</span><span class="p">&gt;</span> <span class="n">configureClient</span><span class="p">)</span> <span class="p">=&gt;</span>
            <span class="n">services</span><span class="p">.</span><span class="n">AddHttpClient</span><span class="p">&lt;</span><span class="n">IDadJokesApiClient</span><span class="p">,</span> <span class="n">DadJokesApiClient</span><span class="p">&gt;((</span><span class="n">httpClient</span><span class="p">)</span> <span class="p">=&gt;</span>
            <span class="p">{</span>
                <span class="n">DadJokesApiClientFactory</span><span class="p">.</span><span class="nf">ConfigureHttpClientCore</span><span class="p">(</span><span class="n">httpClient</span><span class="p">);</span>

                <span class="nf">configureClient</span><span class="p">(</span><span class="n">httpClient</span><span class="p">);</span>
            <span class="p">});</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Use extension method like the following:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">var</span> <span class="n">host</span> <span class="p">=</span> <span class="s">"https://da-jokes.p.rapidapi.com"</span><span class="p">;</span>
<span class="kt">var</span> <span class="n">apiKey</span> <span class="p">=</span> <span class="s">"&lt;token&gt;"</span><span class="p">;</span>

<span class="kt">var</span> <span class="n">services</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">ServiceCollection</span><span class="p">();</span>

<span class="n">services</span><span class="p">.</span><span class="nf">AddDadJokesApiClient</span><span class="p">(</span><span class="n">httpClient</span> <span class="p">=&gt;</span>
<span class="p">{</span>
    <span class="n">httpClient</span><span class="p">.</span><span class="n">BaseAddress</span> <span class="p">=</span> <span class="k">new</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
    <span class="n">httpClient</span><span class="p">.</span><span class="nf">AddDadJokesHeaders</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">apiKey</span><span class="p">);</span>
<span class="p">});</span>

<span class="kt">var</span> <span class="n">provider</span> <span class="p">=</span> <span class="n">services</span><span class="p">.</span><span class="nf">BuildServiceProvider</span><span class="p">();</span>
<span class="kt">var</span> <span class="n">client</span> <span class="p">=</span> <span class="n">provider</span><span class="p">.</span><span class="n">GetRequiredService</span><span class="p">&lt;</span><span class="n">IDadJokesApiClient</span><span class="p">&gt;();</span>

<span class="kt">var</span> <span class="n">joke</span> <span class="p">=</span> <span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="nf">GetRandomJokeAsync</span><span class="p">();</span>

<span class="n">logger</span><span class="p">.</span><span class="nf">Information</span><span class="p">(</span><span class="s">$"</span><span class="p">{</span><span class="n">joke</span><span class="p">.</span><span class="n">Setup</span><span class="p">}</span><span class="s"> </span><span class="p">{</span><span class="n">joke</span><span class="p">.</span><span class="n">Punchline</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>
</code></pre></div></div>

<p>As you see, you can use <code class="language-plaintext highlighter-rouge">IHttpClientFactory</code> outside of ASP.NET Core. For example, console applications, workers, lambdas, etc.</p>

<p>Let’s see it running:</p>

<p><img src="/assets/http-sdk/manual-client-console-di-host.png" alt="manual-client-console-di-host"></p>

<p>The interesting part here is that clients created by DI automatically logs outgoing requests. It makes development and troubleshooting so much easier.</p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{SourceContext}[{EventId}] // pattern

System.Net.Http.HttpClient.IDadJokesApiClient.LogicalHandler [{ Id: 100, Name: "RequestPipelineStart" }]
    System.Net.Http.HttpClient.IDadJokesApiClient.ClientHandler [{ Id: 100, Name: "RequestStart" }]
    System.Net.Http.HttpClient.IDadJokesApiClient.ClientHandler [{ Id: 101, Name: "RequestEnd" }]
System.Net.Http.HttpClient.IDadJokesApiClient.LogicalHandler [{ Id: 101, Name: "RequestPipelineEnd" }]
</code></pre></div></div>

<p>The most common scenario is web applications. Here is .NET 6 MinimalAPI example:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">var</span> <span class="n">builder</span> <span class="p">=</span> <span class="n">WebApplication</span><span class="p">.</span><span class="nf">CreateBuilder</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>
<span class="kt">var</span> <span class="n">services</span> <span class="p">=</span> <span class="n">builder</span><span class="p">.</span><span class="n">Services</span><span class="p">;</span>
<span class="kt">var</span> <span class="n">configuration</span> <span class="p">=</span> <span class="n">builder</span><span class="p">.</span><span class="n">Configuration</span><span class="p">;</span>
<span class="kt">var</span> <span class="n">host</span> <span class="p">=</span> <span class="n">configuration</span><span class="p">[</span><span class="s">"DadJokesClient:host"</span><span class="p">];</span>

<span class="n">services</span><span class="p">.</span><span class="nf">AddDadJokesApiClient</span><span class="p">(</span><span class="n">httpClient</span> <span class="p">=&gt;</span>
<span class="p">{</span>
    <span class="n">httpClient</span><span class="p">.</span><span class="n">BaseAddress</span> <span class="p">=</span> <span class="k">new</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
    <span class="n">httpClient</span><span class="p">.</span><span class="nf">AddDadJokesHeaders</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">configuration</span><span class="p">[</span><span class="s">"DADJOKES_TOKEN"</span><span class="p">]);</span>
<span class="p">});</span>

<span class="kt">var</span> <span class="n">app</span> <span class="p">=</span> <span class="n">builder</span><span class="p">.</span><span class="nf">Build</span><span class="p">();</span>

<span class="n">app</span><span class="p">.</span><span class="nf">MapGet</span><span class="p">(</span><span class="s">"/"</span><span class="p">,</span> <span class="k">async</span> <span class="p">(</span><span class="n">IDadJokesApiClient</span> <span class="n">client</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="nf">GetRandomJokeAsync</span><span class="p">());</span>

<span class="n">app</span><span class="p">.</span><span class="nf">Run</span><span class="p">();</span>
</code></pre></div></div>

<p><img src="/assets/http-sdk/manual-client-api-host.png" alt="manual-client-api-host"></p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"punchline"</span><span class="p">:</span><span class="w"> </span><span class="s2">"They are all paid actors anyway"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"setup"</span><span class="p">:</span><span class="w"> </span><span class="s2">"We really shouldn't care what people at the Oscars say"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"actor"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<h2 id="extending-http-client-sdks-adding-cross-cutting-concerns-via-delegatinghandler">Extending HTTP Client SDKs. Adding cross-cutting concerns via DelegatingHandler</h2>

<p><code class="language-plaintext highlighter-rouge">HttpClient</code> provide an extension point - <em>message handler</em>. A message handler is a class that receives an HTTP request and returns an HTTP response. A wide variety of problems could be expressed as <a href="https://en.wikipedia.org/wiki/Cross-cutting_concern" target="_blank" rel="noopener noreferrer">cross-cutting concerns</a>. For example, logging, authentication, caching, header forwarding, auditing, etc. Aspect-oriented programming aims to encapsulate cross-cutting concerns into aspects to retain modularity. Typically, a series of message handlers are chained together. The first handler receives an HTTP request, does some processing, and gives the request to the next handler. At some point, the response is created and goes back up the chain.</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// supports the most common requirements for most applications</span>
<span class="k">public</span> <span class="k">abstract</span> <span class="k">class</span> <span class="nc">HttpMessageHandler</span> <span class="p">:</span> <span class="n">IDisposable</span>
<span class="p">{}</span>
<span class="c1">// plug a handler into a handler chain</span>
<span class="k">public</span> <span class="k">abstract</span> <span class="k">class</span> <span class="nc">DelegatingHandler</span> <span class="p">:</span> <span class="n">HttpMessageHandler</span>
<span class="p">{}</span>
</code></pre></div></div>

<p><img src="/assets/http-sdk/delegating-handler.png" alt="delegating-handler"></p>

<p><strong>Task</strong>. Assume you need to copy a list of headers from ASP.NET Core <code class="language-plaintext highlighter-rouge">HttpContext</code> and pass them to all outgoing requests made by <em>Dad Jokes API</em> client.</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">class</span> <span class="nc">HeaderPropagationMessageHandler</span> <span class="p">:</span> <span class="n">DelegatingHandler</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="n">HeaderPropagationOptions</span> <span class="n">options</span><span class="p">;</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="n">IHttpContextAccessor</span> <span class="n">contextAccessor</span><span class="p">;</span>

    <span class="k">public</span> <span class="nf">HeaderPropagationMessageHandler</span><span class="p">(</span>
        <span class="n">HeaderPropagationOptions</span> <span class="n">options</span><span class="p">,</span>
        <span class="n">IHttpContextAccessor</span> <span class="n">contextAccessor</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="n">options</span> <span class="p">=</span> <span class="n">options</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="n">contextAccessor</span> <span class="p">=</span> <span class="n">contextAccessor</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">protected</span> <span class="k">override</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">HttpResponseMessage</span><span class="p">&gt;</span> <span class="nf">SendAsync</span><span class="p">(</span>
        <span class="n">HttpRequestMessage</span> <span class="n">request</span><span class="p">,</span> <span class="n">CancellationToken</span> <span class="n">cancellationToken</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">contextAccessor</span><span class="p">.</span><span class="n">HttpContext</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">headerName</span> <span class="k">in</span> <span class="k">this</span><span class="p">.</span><span class="n">options</span><span class="p">.</span><span class="n">HeaderNames</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="kt">var</span> <span class="n">headerValue</span> <span class="p">=</span> <span class="k">this</span><span class="p">.</span><span class="n">contextAccessor</span>
                    <span class="p">.</span><span class="n">HttpContext</span><span class="p">.</span><span class="n">Request</span><span class="p">.</span><span class="n">Headers</span><span class="p">[</span><span class="n">headerName</span><span class="p">];</span>

                <span class="n">request</span><span class="p">.</span><span class="n">Headers</span><span class="p">.</span><span class="nf">TryAddWithoutValidation</span><span class="p">(</span>
                    <span class="n">headerName</span><span class="p">,</span> <span class="p">(</span><span class="kt">string</span><span class="p">[])</span><span class="n">headerValue</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="k">base</span><span class="p">.</span><span class="nf">SendAsync</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">cancellationToken</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">public</span> <span class="k">class</span> <span class="nc">HeaderPropagationOptions</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="n">IList</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;</span> <span class="n">HeaderNames</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;();</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Now, we want to “plug” <code class="language-plaintext highlighter-rouge">DelegatingHandler</code> into <code class="language-plaintext highlighter-rouge">HttpClient</code> request pipeline.</p>

<p>For non-<code class="language-plaintext highlighter-rouge">IHttpClientFactory</code> scenarios, we want clients to specify a list of <code class="language-plaintext highlighter-rouge">DelegatingHandler</code> so we can build an underlying chain for <code class="language-plaintext highlighter-rouge">HttpClient</code>.</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//DadJokesApiClientFactory.cs</span>
<span class="k">public</span> <span class="k">static</span> <span class="n">IDadJokesApiClient</span> <span class="nf">Create</span><span class="p">(</span>
    <span class="kt">string</span> <span class="n">host</span><span class="p">,</span>
    <span class="kt">string</span> <span class="n">apiKey</span><span class="p">,</span>
    <span class="k">params</span> <span class="n">DelegatingHandler</span><span class="p">[]</span> <span class="n">handlers</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">var</span> <span class="n">httpClient</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">HttpClient</span><span class="p">();</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">handlers</span><span class="p">.</span><span class="n">Length</span> <span class="p">&gt;</span> <span class="m">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">_</span> <span class="p">=</span> <span class="n">handlers</span><span class="p">.</span><span class="nf">Aggregate</span><span class="p">((</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span> <span class="p">=&gt;</span>
        <span class="p">{</span>
            <span class="n">a</span><span class="p">.</span><span class="n">InnerHandler</span> <span class="p">=</span> <span class="n">b</span><span class="p">;</span>
            <span class="k">return</span> <span class="n">b</span><span class="p">;</span>
        <span class="p">});</span>
        <span class="n">httpClient</span> <span class="p">=</span> <span class="k">new</span><span class="p">(</span><span class="n">handlers</span><span class="p">[</span><span class="m">0</span><span class="p">]);</span>
    <span class="p">}</span>
    <span class="n">httpClient</span><span class="p">.</span><span class="n">BaseAddress</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Uri</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>

    <span class="nf">ConfigureHttpClient</span><span class="p">(</span><span class="n">httpClient</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">apiKey</span><span class="p">);</span>

    <span class="k">return</span> <span class="k">new</span> <span class="nf">DadJokesApiClient</span><span class="p">(</span><span class="n">httpClient</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>So, without DI container, extended <code class="language-plaintext highlighter-rouge">DadJokesApiClient</code> could be constructed like this:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">var</span> <span class="n">loggingHandler</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">LoggingMessageHandler</span><span class="p">();</span> <span class="c1">//outermost</span>
<span class="kt">var</span> <span class="n">authHandler</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">AuthMessageHandler</span><span class="p">();</span>
<span class="kt">var</span> <span class="n">propagationHandler</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">HeaderPropagationMessageHandler</span><span class="p">();</span>
<span class="kt">var</span> <span class="n">primaryHandler</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">HttpClientHandler</span><span class="p">();</span>  <span class="c1">// the default handler used by HttpClient</span>

<span class="n">DadJokesApiClientFactory</span><span class="p">.</span><span class="nf">Create</span><span class="p">(</span>
    <span class="n">host</span><span class="p">,</span> <span class="n">apiKey</span><span class="p">,</span>
    <span class="n">loggingHandler</span><span class="p">,</span> <span class="n">authHandler</span><span class="p">,</span> <span class="n">propagationHandler</span><span class="p">,</span> <span class="n">primaryHandler</span><span class="p">);</span>

<span class="c1">// LoggingMessageHandler ➝ AuthMessageHandler ➝ HeaderPropagationMessageHandler ➝ HttpClientHandler</span>
</code></pre></div></div>

<p>For DI container scenarios, on another hand, we want to provide auxiliary extension method to easily plug <code class="language-plaintext highlighter-rouge">HeaderPropagationMessageHandler</code> by using <code class="language-plaintext highlighter-rouge">IHttpClientBuilder.AddHttpMessageHandler</code>.</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">static</span> <span class="k">class</span> <span class="nc">HeaderPropagationExtensions</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">static</span> <span class="n">IHttpClientBuilder</span> <span class="nf">AddHeaderPropagation</span><span class="p">(</span>
        <span class="k">this</span> <span class="n">IHttpClientBuilder</span> <span class="n">builder</span><span class="p">,</span>
        <span class="n">Action</span><span class="p">&lt;</span><span class="n">HeaderPropagationOptions</span><span class="p">&gt;</span> <span class="n">configure</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">builder</span><span class="p">.</span><span class="n">Services</span><span class="p">.</span><span class="nf">Configure</span><span class="p">(</span><span class="n">configure</span><span class="p">);</span>
        <span class="n">builder</span><span class="p">.</span><span class="nf">AddHttpMessageHandler</span><span class="p">((</span><span class="n">sp</span><span class="p">)</span> <span class="p">=&gt;</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="k">new</span> <span class="nf">HeaderPropagationMessageHandler</span><span class="p">(</span>
                <span class="n">sp</span><span class="p">.</span><span class="n">GetRequiredService</span><span class="p">&lt;</span><span class="n">IOptions</span><span class="p">&lt;</span><span class="n">HeaderPropagationOptions</span><span class="p">&gt;&gt;().</span><span class="n">Value</span><span class="p">,</span>
                <span class="n">sp</span><span class="p">.</span><span class="n">GetRequiredService</span><span class="p">&lt;</span><span class="n">IHttpContextAccessor</span><span class="p">&gt;());</span>
        <span class="p">});</span>

        <span class="k">return</span> <span class="n">builder</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Here is how extended MinimalAPI example looks like:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">var</span> <span class="n">builder</span> <span class="p">=</span> <span class="n">WebApplication</span><span class="p">.</span><span class="nf">CreateBuilder</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>
<span class="kt">var</span> <span class="n">services</span> <span class="p">=</span> <span class="n">builder</span><span class="p">.</span><span class="n">Services</span><span class="p">;</span>
<span class="kt">var</span> <span class="n">configuration</span> <span class="p">=</span> <span class="n">builder</span><span class="p">.</span><span class="n">Configuration</span><span class="p">;</span>
<span class="kt">var</span> <span class="n">host</span> <span class="p">=</span> <span class="n">configuration</span><span class="p">[</span><span class="s">"DadJokesClient:host"</span><span class="p">];</span>

<span class="n">services</span><span class="p">.</span><span class="nf">AddDadJokesApiClient</span><span class="p">(</span><span class="n">httpClient</span> <span class="p">=&gt;</span>
<span class="p">{</span>
    <span class="n">httpClient</span><span class="p">.</span><span class="n">BaseAddress</span> <span class="p">=</span> <span class="k">new</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
    <span class="n">httpClient</span><span class="p">.</span><span class="nf">AddDadJokesHeaders</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">configuration</span><span class="p">[</span><span class="s">"DADJOKES_TOKEN"</span><span class="p">]);</span>
<span class="p">}).</span><span class="nf">AddHeaderPropagation</span><span class="p">(</span><span class="n">o</span> <span class="p">=&gt;</span> <span class="n">o</span><span class="p">.</span><span class="n">HeaderNames</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="s">"X-Correlation-ID"</span><span class="p">));</span>

<span class="kt">var</span> <span class="n">app</span> <span class="p">=</span> <span class="n">builder</span><span class="p">.</span><span class="nf">Build</span><span class="p">();</span>

<span class="n">app</span><span class="p">.</span><span class="nf">MapGet</span><span class="p">(</span><span class="s">"/"</span><span class="p">,</span> <span class="k">async</span> <span class="p">(</span><span class="n">IDadJokesApiClient</span> <span class="n">client</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="nf">GetRandomJokeAsync</span><span class="p">());</span>

<span class="n">app</span><span class="p">.</span><span class="nf">Run</span><span class="p">();</span>
</code></pre></div></div>

<p>💡 Sometimes functionality like this is reused by other services. You might want to take it one step further and factor out all shared code into a common NuGet package and use it in HTTP Client SDKs.</p>

<h3 id="third-party-extensions">Third-Party Extensions</h3>

<p>Not only we can write our own message handlers. There is a lot of useful NuGet packages provided and supported by .NET OSS community. Here are my favorites:</p>

<p>💡 <em>Resiliency patterns</em> - retry, cache, fallback, etc.: Very often, in distrusted systems world you need to ensure high availability by incorporating some resilience policies. Luckily, we have a built-in solution to build and define policies in .NET - <a href="https://github.com/App-vNext/Polly" target="_blank" rel="noopener noreferrer">Polly</a>. There is out-of-the-box integration with <code class="language-plaintext highlighter-rouge">IHttpClientFactory</code> provided by Polly. This uses a convenience method, <a href="https://docs.microsoft.com/en-us/dotnet/api/microsoft.extensions.dependencyinjection.pollyhttpclientbuilderextensions.addtransienthttperrorpolicy" target="_blank" rel="noopener noreferrer">IHttpClientBuilder.AddTransientHttpErrorPolicy</a>. It configures a policy to handle errors typical of HTTP calls: <code class="language-plaintext highlighter-rouge">HttpRequestException</code>, HTTP 5XX status codes (server errors), HTTP 408 status code (request timeout).</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">services</span><span class="p">.</span><span class="nf">AddDadJokesApiClient</span><span class="p">(</span><span class="n">httpClient</span> <span class="p">=&gt;</span>
<span class="p">{</span>
    <span class="n">httpClient</span><span class="p">.</span><span class="n">BaseAddress</span> <span class="p">=</span> <span class="k">new</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
<span class="p">}).</span><span class="nf">AddTransientHttpErrorPolicy</span><span class="p">(</span><span class="n">builder</span> <span class="p">=&gt;</span> <span class="n">builder</span><span class="p">.</span><span class="nf">WaitAndRetryAsync</span><span class="p">(</span><span class="k">new</span><span class="p">[]</span>
<span class="p">{</span>
    <span class="n">TimeSpan</span><span class="p">.</span><span class="nf">FromSeconds</span><span class="p">(</span><span class="m">1</span><span class="p">),</span>
    <span class="n">TimeSpan</span><span class="p">.</span><span class="nf">FromSeconds</span><span class="p">(</span><span class="m">5</span><span class="p">),</span>
    <span class="n">TimeSpan</span><span class="p">.</span><span class="nf">FromSeconds</span><span class="p">(</span><span class="m">10</span><span class="p">)</span>
<span class="p">}));</span>
</code></pre></div></div>

<p>For example, transient errors might be handled proactively by using <em>Retry</em> and <em>Circuit Breaker</em> patterns. Usually, we use a retry pattern when there is a hope that downstream service will self-correct eventually. Waiting between retries provides an opportunity for a downstream service to stabilize. It is common to use retries based on the <a href="https://en.wikipedia.org/wiki/Exponential_backoff" target="_blank" rel="noopener noreferrer">Exponential Backoff</a> algorithm. On paper, it sounds great, but in real-world scenarios, the retry pattern may be overused. Additional retries might be the source of additional load or spikes. In the worst case, resources in the caller may then become exhausted or excessively blocked, waiting for replies which will never come causing an upstream-cascading failure.</p>

<p>This is when the <em>Circuit Breaker</em> pattern comes into play. It detects the level of faults and prevents calls to a downstream service when a fault threshold is exceeded. Use this pattern when there is no chance of succeeding - for example, where a subsystem is completely offline or struggling under load. The idea behind <em>Circuit Breaker</em> is pretty straightforward, although, you might build something more complex on top of it. When faults exceed the threshold, calls are placed through the circuit, so instead of processing a request, we practice the fail-fast approach, throwing an exception immediately.</p>

<p>Polly is really powerful and it provides a way to combine resilience strategies. See <a href="https://github.com/App-vNext/Polly/wiki/PolicyWrap" target="_blank" rel="noopener noreferrer">PolicyWrap</a>.</p>

<p>Here is a classification of the strategies you might want to use:</p>

<p><img src="/assets/http-sdk/http-client-sdk-polly.png" alt="http-client-sdk-polly"></p>

<p>Designing reliable systems could be a challenging task, I suggest you investigate the subject on your own. Here is a good introduction - <a href="https://docs.microsoft.com/en-us/dotnet/architecture/microservices/implement-resilient-applications/" target="_blank" rel="noopener noreferrer">.NET microservices - Architecture e-book: Implement resilient applications</a></p>

<p>💡 <em>Authentication in OAuth2/OIDC</em>: If you need to manage user and client access tokens I suggest using <a href="https://github.com/IdentityModel/IdentityModel.AspNetCore" target="_blank" rel="noopener noreferrer">IdentityModel.AspNetCore</a>. It acquires, caches, and rotates tokens for you, see the <a href="https://identitymodel.readthedocs.io/en/latest/aspnetcore/overview.html" target="_blank" rel="noopener noreferrer">docs</a>.</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// adds user and client access token management</span>
<span class="n">services</span><span class="p">.</span><span class="nf">AddAccessTokenManagement</span><span class="p">(</span><span class="n">options</span> <span class="p">=&gt;</span>
<span class="p">{</span>
    <span class="n">options</span><span class="p">.</span><span class="n">Client</span><span class="p">.</span><span class="n">Clients</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="s">"identity-provider"</span><span class="p">,</span> <span class="k">new</span> <span class="n">ClientCredentialsTokenRequest</span>
    <span class="p">{</span>
        <span class="n">Address</span> <span class="p">=</span> <span class="s">"https://demo.identityserver.io/connect/token"</span><span class="p">,</span>
        <span class="n">ClientId</span> <span class="p">=</span> <span class="s">"my-awesome-service"</span><span class="p">,</span>
        <span class="n">ClientSecret</span> <span class="p">=</span> <span class="s">"secret"</span><span class="p">,</span>
        <span class="n">Scope</span> <span class="p">=</span> <span class="s">"api"</span> <span class="c1">// optional</span>
    <span class="p">});</span>
<span class="p">});</span>
<span class="c1">// registers HTTP client that uses the managed client access token</span>
<span class="c1">// adds the access token handler to HTTP client registration</span>
<span class="n">services</span><span class="p">.</span><span class="nf">AddDadJokesApiClient</span><span class="p">(</span><span class="n">httpClient</span> <span class="p">=&gt;</span>
<span class="p">{</span>
    <span class="n">httpClient</span><span class="p">.</span><span class="n">BaseAddress</span> <span class="p">=</span> <span class="k">new</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
<span class="p">}).</span><span class="nf">AddClientAccessTokenHandler</span><span class="p">();</span> 
</code></pre></div></div>

<h2 id="testing-http-client-sdks">Testing HTTP Client SDKs</h2>

<p>By this time, you should be pretty comfortable designing and writing your own HTTP Client SDKs. The only thing that is left is to write some tests to ensure expected behavior. Note, it might be a good idea to skip extensive unit testing and write more integration or e2e to ensure proper integration. For now, I will show you how to unit test <code class="language-plaintext highlighter-rouge">DadJokesApiClient</code>.</p>

<p>As you have seen previously, <code class="language-plaintext highlighter-rouge">HttpClient</code> is extensible. Furthermore, we can replace the standard <code class="language-plaintext highlighter-rouge">HttpMessageHandler</code> with the test version. So, instead of sending actual requests over the wire, we will use the mock. This technique opens tons of opportunities because we can simulate all kinds of behaviors of <code class="language-plaintext highlighter-rouge">HttpClient</code> that otherwise could be hard to replicate in a normal situation.</p>

<p>Let’s define reusable methods to create a mock of <code class="language-plaintext highlighter-rouge">HttpClient</code> that we will pass as a dependency to <code class="language-plaintext highlighter-rouge">DadJokesApiClient</code>.</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">static</span> <span class="k">class</span> <span class="nc">TestHarness</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">static</span> <span class="n">Mock</span><span class="p">&lt;</span><span class="n">HttpMessageHandler</span><span class="p">&gt;</span> <span class="n">CreateMessageHandlerWithResult</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span>
        <span class="n">T</span> <span class="n">result</span><span class="p">,</span> <span class="n">HttpStatusCode</span> <span class="n">code</span> <span class="p">=</span> <span class="n">HttpStatusCode</span><span class="p">.</span><span class="n">OK</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">messageHandler</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Mock</span><span class="p">&lt;</span><span class="n">HttpMessageHandler</span><span class="p">&gt;();</span>
        <span class="n">messageHandler</span><span class="p">.</span><span class="nf">Protected</span><span class="p">()</span>
            <span class="p">.</span><span class="n">Setup</span><span class="p">&lt;</span><span class="n">Task</span><span class="p">&lt;</span><span class="n">HttpResponseMessage</span><span class="p">&gt;&gt;(</span>
                <span class="s">"SendAsync"</span><span class="p">,</span>
                <span class="n">ItExpr</span><span class="p">.</span><span class="n">IsAny</span><span class="p">&lt;</span><span class="n">HttpRequestMessage</span><span class="p">&gt;(),</span>
                <span class="n">ItExpr</span><span class="p">.</span><span class="n">IsAny</span><span class="p">&lt;</span><span class="n">CancellationToken</span><span class="p">&gt;())</span>
            <span class="p">.</span><span class="nf">ReturnsAsync</span><span class="p">(</span><span class="k">new</span> <span class="nf">HttpResponseMessage</span><span class="p">()</span>
            <span class="p">{</span>
                <span class="n">StatusCode</span> <span class="p">=</span> <span class="n">code</span><span class="p">,</span>
                <span class="n">Content</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">StringContent</span><span class="p">(</span><span class="n">JsonSerializer</span><span class="p">.</span><span class="nf">Serialize</span><span class="p">(</span><span class="n">result</span><span class="p">)),</span>
            <span class="p">});</span>

        <span class="k">return</span> <span class="n">messageHandler</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">static</span> <span class="n">HttpClient</span> <span class="n">CreateHttpClientWithResult</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span>
        <span class="n">T</span> <span class="n">result</span><span class="p">,</span> <span class="n">HttpStatusCode</span> <span class="n">code</span> <span class="p">=</span> <span class="n">HttpStatusCode</span><span class="p">.</span><span class="n">OK</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">httpClient</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">HttpClient</span><span class="p">(</span><span class="nf">CreateMessageHandlerWithResult</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">code</span><span class="p">).</span><span class="n">Object</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">BaseAddress</span> <span class="p">=</span> <span class="k">new</span><span class="p">(</span><span class="s">"https://api-client-under-test.com"</span><span class="p">),</span>
        <span class="p">};</span>

        <span class="k">return</span> <span class="n">httpClient</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>From this point, unit testing is a pretty simple process:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">class</span> <span class="nc">DadJokesApiClientTests</span>
<span class="p">{</span>
    <span class="p">[</span><span class="n">Theory</span><span class="p">,</span> <span class="n">AutoData</span><span class="p">]</span>
    <span class="k">public</span> <span class="k">async</span> <span class="n">Task</span> <span class="nf">GetRandomJokeAsync_SingleJokeInResult_Returned</span><span class="p">(</span><span class="n">Joke</span> <span class="n">joke</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// Arrange</span>
        <span class="kt">var</span> <span class="n">response</span> <span class="p">=</span> <span class="k">new</span> <span class="n">JokeSearchResponse</span>
        <span class="p">{</span>
            <span class="n">Success</span> <span class="p">=</span> <span class="k">true</span><span class="p">,</span>
            <span class="n">Body</span> <span class="p">=</span> <span class="k">new</span><span class="p">()</span> <span class="p">{</span> <span class="n">joke</span> <span class="p">}</span>
        <span class="p">};</span>
        <span class="kt">var</span> <span class="n">httpClient</span> <span class="p">=</span> <span class="nf">CreateHttpClientWithResult</span><span class="p">(</span><span class="n">response</span><span class="p">);</span>
        <span class="kt">var</span> <span class="n">sut</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">DadJokesApiClient</span><span class="p">(</span><span class="n">httpClient</span><span class="p">);</span>

        <span class="c1">// Act</span>
        <span class="kt">var</span> <span class="n">result</span> <span class="p">=</span> <span class="k">await</span> <span class="n">sut</span><span class="p">.</span><span class="nf">GetRandomJokeAsync</span><span class="p">();</span>

        <span class="c1">// Assert</span>
        <span class="n">result</span><span class="p">.</span><span class="nf">Should</span><span class="p">().</span><span class="nf">BeEquivalentTo</span><span class="p">(</span><span class="n">joke</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="p">[</span><span class="n">Fact</span><span class="p">]</span>
    <span class="k">public</span> <span class="k">async</span> <span class="n">Task</span> <span class="nf">GetRandomJokeAsync_UnsuccessfulJokeResult_ExceptionThrown</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">// Arrange</span>
        <span class="kt">var</span> <span class="n">response</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">JokeSearchResponse</span><span class="p">();</span>
        <span class="kt">var</span> <span class="n">httpClient</span> <span class="p">=</span> <span class="nf">CreateHttpClientWithResult</span><span class="p">(</span><span class="n">response</span><span class="p">);</span>
        <span class="kt">var</span> <span class="n">sut</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">DadJokesApiClient</span><span class="p">(</span><span class="n">httpClient</span><span class="p">);</span>

        <span class="c1">// Act</span>
        <span class="c1">// Assert</span>
        <span class="k">await</span> <span class="n">FluentActions</span><span class="p">.</span><span class="nf">Invoking</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="n">sut</span><span class="p">.</span><span class="nf">GetRandomJokeAsync</span><span class="p">())</span>
            <span class="p">.</span><span class="nf">Should</span><span class="p">().</span><span class="n">ThrowAsync</span><span class="p">&lt;</span><span class="n">InvalidOperationException</span><span class="p">&gt;();</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Using <code class="language-plaintext highlighter-rouge">HttpClient</code> is the most flexible approach. You have full control over integration with APIs. But, there is a downside, you need to write a lot of boilerplate code. In some situations, an API you are integrating with is trivial so you don’t really need all capabilities provided by <code class="language-plaintext highlighter-rouge">HttpClient</code>, <code class="language-plaintext highlighter-rouge">HttpRequestMessage</code>, <code class="language-plaintext highlighter-rouge">HttpResponseMessage</code>.</p>

<p>Pros ➕:</p>

<ul>
  <li>Full control over behavior and data contracts. You can even write “smart” API Client and move some logic inside SDK if it makes sense for a particular scenario. For example, you can throw custom exceptions, transform requests and responses, provide default values for headers, etc.</li>
  <li>Full control over serialization and deserialization process</li>
  <li>Easy to debug and troubleshoot. A stack trace is simple and you can always spin up the debugger to see what is happening under the hood.</li>
</ul>

<p>Cons ➖:</p>

<ul>
  <li>Need to write a lot of repetitive code</li>
  <li>Someone should maintain a code base in case of API changes and bugs. This is a tedious and error-prone process.</li>
</ul>

<h2 id="writing-http-client-sdk-declarative-approach">Writing HTTP Client SDK. Declarative approach</h2>

<blockquote>
  <p>The less code, the fewer bugs.</p>
</blockquote>

<p><a href="https://github.com/reactiveui/refit" target="_blank" rel="noopener noreferrer">Refit</a> is an automatic type-safe REST library for .NET. It turns your REST API into a live interface. Refit uses <code class="language-plaintext highlighter-rouge">System.Text.Json</code> as the default JSON serializer.</p>

<p>Every method must have an HTTP attribute that provides the request method and relative URL.</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">using</span> <span class="nn">Refit</span><span class="p">;</span>

<span class="k">public</span> <span class="k">interface</span> <span class="nc">IDadJokesApiClient</span>
<span class="p">{</span>
    <span class="c1">/// &lt;summary&gt;</span>
    <span class="c1">/// Searches jokes by term.</span>
    <span class="c1">/// &lt;/summary&gt;</span>
    <span class="p">[</span><span class="nf">Get</span><span class="p">(</span><span class="s">"/joke/search"</span><span class="p">)]</span>
    <span class="n">Task</span><span class="p">&lt;</span><span class="n">JokeSearchResponse</span><span class="p">&gt;</span> <span class="nf">SearchAsync</span><span class="p">(</span>
        <span class="kt">string</span> <span class="n">term</span><span class="p">,</span>
        <span class="n">CancellationToken</span> <span class="n">cancellationToken</span> <span class="p">=</span> <span class="k">default</span><span class="p">);</span>

    <span class="c1">/// &lt;summary&gt;</span>
    <span class="c1">/// Gets a joke by id.</span>
    <span class="c1">/// &lt;/summary&gt;</span>
    <span class="p">[</span><span class="nf">Get</span><span class="p">(</span><span class="s">"/joke/{id}"</span><span class="p">)]</span>
    <span class="n">Task</span><span class="p">&lt;</span><span class="n">Joke</span><span class="p">&gt;</span> <span class="nf">GetJokeByIdAsync</span><span class="p">(</span>
        <span class="kt">string</span> <span class="n">id</span><span class="p">,</span>
        <span class="n">CancellationToken</span> <span class="n">cancellationToken</span> <span class="p">=</span> <span class="k">default</span><span class="p">);</span>

    <span class="c1">/// &lt;summary&gt;</span>
    <span class="c1">/// Gets a random joke.</span>
    <span class="c1">/// &lt;/summary&gt;</span>
    <span class="p">[</span><span class="nf">Get</span><span class="p">(</span><span class="s">"/random/joke"</span><span class="p">)]</span>
    <span class="n">Task</span><span class="p">&lt;</span><span class="n">JokeSearchResponse</span><span class="p">&gt;</span> <span class="nf">GetRandomJokeAsync</span><span class="p">(</span>
        <span class="n">CancellationToken</span> <span class="n">cancellationToken</span> <span class="p">=</span> <span class="k">default</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Refit generates type that implements <code class="language-plaintext highlighter-rouge">IDadJokesApiClient</code> based on information provided by <code class="language-plaintext highlighter-rouge">Refit.HttpMethodAttribute</code></p>

<h2 id="consuming-api-clients-refit">Consuming API Clients. Refit</h2>

<p>The approach is the same as for vanilla <code class="language-plaintext highlighter-rouge">HttpClient</code> integration, but instead of constructing a client manually, we use static method provided by Refit.</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">static</span> <span class="k">class</span> <span class="nc">DadJokesApiClientFactory</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">static</span> <span class="n">IDadJokesApiClient</span> <span class="nf">Create</span><span class="p">(</span>
        <span class="n">HttpClient</span> <span class="n">httpClient</span><span class="p">,</span>
        <span class="kt">string</span> <span class="n">host</span><span class="p">,</span>
        <span class="kt">string</span> <span class="n">apiKey</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">httpClient</span><span class="p">.</span><span class="n">BaseAddress</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Uri</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>

        <span class="nf">ConfigureHttpClient</span><span class="p">(</span><span class="n">httpClient</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">apiKey</span><span class="p">);</span>

        <span class="k">return</span> <span class="n">RestService</span><span class="p">.</span><span class="n">For</span><span class="p">&lt;</span><span class="n">IDadJokesApiClient</span><span class="p">&gt;(</span><span class="n">httpClient</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="c1">// ...</span>
<span class="p">}</span>
</code></pre></div></div>

<p>For DI container scenarios, we can use <code class="language-plaintext highlighter-rouge">Refit.HttpClientFactoryExtensions.AddRefitClient</code> extension method.</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">static</span> <span class="k">class</span> <span class="nc">ServiceCollectionExtensions</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">static</span> <span class="n">IHttpClientBuilder</span> <span class="nf">AddDadJokesApiClient</span><span class="p">(</span>
        <span class="k">this</span> <span class="n">IServiceCollection</span> <span class="n">services</span><span class="p">,</span>
        <span class="n">Action</span><span class="p">&lt;</span><span class="n">HttpClient</span><span class="p">&gt;</span> <span class="n">configureClient</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">settings</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">RefitSettings</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="n">ContentSerializer</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">SystemTextJsonContentSerializer</span><span class="p">(</span><span class="k">new</span> <span class="nf">JsonSerializerOptions</span><span class="p">()</span>
            <span class="p">{</span>
                <span class="n">PropertyNameCaseInsensitive</span> <span class="p">=</span> <span class="k">true</span><span class="p">,</span>
                <span class="n">WriteIndented</span> <span class="p">=</span> <span class="k">true</span><span class="p">,</span>
            <span class="p">})</span>
        <span class="p">};</span>

        <span class="k">return</span> <span class="n">services</span><span class="p">.</span><span class="n">AddRefitClient</span><span class="p">&lt;</span><span class="n">IDadJokesApiClient</span><span class="p">&gt;(</span><span class="n">settings</span><span class="p">)</span>
            <span class="p">.</span><span class="nf">ConfigureHttpClient</span><span class="p">((</span><span class="n">httpClient</span><span class="p">)</span> <span class="p">=&gt;</span>
            <span class="p">{</span>
                <span class="n">DadJokesApiClientFactory</span><span class="p">.</span><span class="nf">ConfigureHttpClient</span><span class="p">(</span><span class="n">httpClient</span><span class="p">);</span>
                <span class="nf">configureClient</span><span class="p">(</span><span class="n">httpClient</span><span class="p">);</span>
            <span class="p">});</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Usage:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="kt">var</span> <span class="n">builder</span> <span class="p">=</span> <span class="n">WebApplication</span><span class="p">.</span><span class="nf">CreateBuilder</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>
<span class="kt">var</span> <span class="n">configuration</span> <span class="p">=</span> <span class="n">builder</span><span class="p">.</span><span class="n">Configuration</span><span class="p">;</span>

<span class="n">Log</span><span class="p">.</span><span class="n">Logger</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">LoggerConfiguration</span><span class="p">().</span><span class="n">WriteTo</span><span class="p">.</span><span class="nf">Console</span><span class="p">().</span><span class="nf">CreateBootstrapLogger</span><span class="p">();</span>
<span class="n">builder</span><span class="p">.</span><span class="n">Host</span><span class="p">.</span><span class="nf">UseSerilog</span><span class="p">((</span><span class="n">ctx</span><span class="p">,</span> <span class="n">cfg</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="n">cfg</span><span class="p">.</span><span class="n">WriteTo</span><span class="p">.</span><span class="nf">Console</span><span class="p">());</span>

<span class="kt">var</span> <span class="n">services</span> <span class="p">=</span> <span class="n">builder</span><span class="p">.</span><span class="n">Services</span><span class="p">;</span>

<span class="n">services</span><span class="p">.</span><span class="nf">AddDadJokesApiClient</span><span class="p">(</span><span class="n">httpClient</span> <span class="p">=&gt;</span>
<span class="p">{</span>
    <span class="kt">var</span> <span class="n">host</span> <span class="p">=</span> <span class="n">configuration</span><span class="p">[</span><span class="s">"DadJokesClient:host"</span><span class="p">];</span>
    <span class="n">httpClient</span><span class="p">.</span><span class="n">BaseAddress</span> <span class="p">=</span> <span class="k">new</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
    <span class="n">httpClient</span><span class="p">.</span><span class="nf">AddDadJokesHeaders</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">configuration</span><span class="p">[</span><span class="s">"DADJOKES_TOKEN"</span><span class="p">]);</span>
<span class="p">});</span>

<span class="kt">var</span> <span class="n">app</span> <span class="p">=</span> <span class="n">builder</span><span class="p">.</span><span class="nf">Build</span><span class="p">();</span>

<span class="n">app</span><span class="p">.</span><span class="nf">MapGet</span><span class="p">(</span><span class="s">"/"</span><span class="p">,</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">Joke</span><span class="p">&gt;</span> <span class="p">(</span><span class="n">IDadJokesApiClient</span> <span class="n">client</span><span class="p">)</span> <span class="p">=&gt;</span>
<span class="p">{</span>
    <span class="kt">var</span> <span class="n">jokeResponse</span> <span class="p">=</span> <span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="nf">GetRandomJokeAsync</span><span class="p">();</span>

    <span class="k">return</span> <span class="n">jokeResponse</span><span class="p">.</span><span class="n">Body</span><span class="p">.</span><span class="nf">First</span><span class="p">();</span> <span class="c1">// unwraps JokeSearchResponse</span>
<span class="p">});</span>

<span class="n">app</span><span class="p">.</span><span class="nf">Run</span><span class="p">();</span>
</code></pre></div></div>

<p>Note, since the contract of the generated client should match the underlying data contract, we no longer have control of contract transformation and this responsibility is delegated to consumers.</p>

<p>Let’s see how the code above works in practice. The output of MinimalAPI example is different because I’ve added Serilog logging.</p>

<p><img src="/assets/http-sdk/declarative-client-api-host.png" alt="declarative-client-api-host"></p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"punchline"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Forgery."</span><span class="p">,</span><span class="w">
  </span><span class="nl">"setup"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Why was the blacksmith charged with?"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"forgery"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>As usual, there are some pros and some cons:</p>

<p>Pros ➕:</p>

<ul>
  <li>Easy to use and develop API clients.</li>
  <li>Highly configurable. Flexible enough to get things done.</li>
  <li>No need for additional unit testing</li>
</ul>

<p>Cons ➖:</p>

<ul>
  <li>Hard to troubleshoot. Sometimes it can be hard to understand how the generated code works. For example, there is a mismatch in configuration.</li>
  <li>Requires other team members to understand how to read and write code developed with Refit.</li>
  <li>Still consumes some time for medium/large APIs.</li>
</ul>

<p>Honorable mentions: <a href="https://github.com/canton7/RestEase" target="_blank" rel="noopener noreferrer">RestEase</a>, <a href="https://github.com/hassanhabib/RESTFulSense" target="_blank" rel="noopener noreferrer">RESTFulSense</a></p>

<h2 id="writing-http-client-sdk-automated-approach">Writing HTTP Client SDK. Automated approach</h2>

<p>There is a way to fully automate HTTP Client SDKs. The OpenAPI/Swagger specification uses JSON and JSON Schema to describe a RESTful web API. The <a href="https://github.com/RicoSuter/NSwag" target="_blank" rel="noopener noreferrer">NSwag</a> project provides tools to generate client code from these OpenAPI specifications. Everything can be automated via CLI (distributed via NuGet tool or build target; or NPM).</p>

<p>Actually, <em>Dad Jokes API</em> doesn’t provide OpenAPI, so I had to write it manually. Fortunately, it was quite easy to do:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">openapi</span><span class="pi">:</span> <span class="s1">'</span><span class="s">3.0.2'</span>
<span class="na">info</span><span class="pi">:</span>
  <span class="na">title</span><span class="pi">:</span> <span class="s">Dad Jokes API</span>
  <span class="na">version</span><span class="pi">:</span> <span class="s1">'</span><span class="s">1.0'</span>
<span class="na">servers</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">url</span><span class="pi">:</span> <span class="s">https://dad-jokes.p.rapidapi.com</span>
<span class="na">paths</span><span class="pi">:</span>
  <span class="s">/joke/{id}</span><span class="err">:</span>
    <span class="na">get</span><span class="pi">:</span>
      <span class="na">description</span><span class="pi">:</span> <span class="s1">'</span><span class="s">'</span>
      <span class="na">operationId</span><span class="pi">:</span> <span class="s1">'</span><span class="s">GetJokeById'</span>
      <span class="na">parameters</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">id"</span>
        <span class="na">in</span><span class="pi">:</span> <span class="s2">"</span><span class="s">path"</span>
        <span class="na">description</span><span class="pi">:</span> <span class="s2">"</span><span class="s">"</span>
        <span class="na">required</span><span class="pi">:</span> <span class="kc">true</span>
        <span class="na">schema</span><span class="pi">:</span>
          <span class="na">type</span><span class="pi">:</span> <span class="s2">"</span><span class="s">string"</span>
      <span class="na">responses</span><span class="pi">:</span>
        <span class="s1">'</span><span class="s">200'</span><span class="err">:</span>
          <span class="na">description</span><span class="pi">:</span> <span class="s">successful operation</span>
          <span class="na">content</span><span class="pi">:</span>
            <span class="na">application/json</span><span class="pi">:</span>
              <span class="na">schema</span><span class="pi">:</span>
                <span class="s2">"</span><span class="s">$ref"</span><span class="err">:</span> <span class="s2">"</span><span class="s">#/components/schemas/Joke"</span>
<span class="err">  </span><span class="na">/random/joke</span><span class="pi">:</span>
    <span class="na">get</span><span class="pi">:</span>
      <span class="na">description</span><span class="pi">:</span> <span class="s1">'</span><span class="s">'</span>
      <span class="na">operationId</span><span class="pi">:</span> <span class="s1">'</span><span class="s">GetRandomJoke'</span>
      <span class="na">parameters</span><span class="pi">:</span> <span class="pi">[]</span>
      <span class="na">responses</span><span class="pi">:</span>
        <span class="s1">'</span><span class="s">200'</span><span class="err">:</span>
          <span class="na">description</span><span class="pi">:</span> <span class="s">successful operation</span>
          <span class="na">content</span><span class="pi">:</span>
            <span class="na">application/json</span><span class="pi">:</span>
              <span class="na">schema</span><span class="pi">:</span>
                <span class="s2">"</span><span class="s">$ref"</span><span class="err">:</span> <span class="s2">"</span><span class="s">#/components/schemas/JokeResponse"</span>
  <span class="na">/joke/search</span><span class="pi">:</span>
    <span class="na">get</span><span class="pi">:</span>
      <span class="na">description</span><span class="pi">:</span> <span class="s1">'</span><span class="s">'</span>
      <span class="na">operationId</span><span class="pi">:</span> <span class="s1">'</span><span class="s">SearchJoke'</span>
      <span class="na">parameters</span><span class="pi">:</span> <span class="pi">[]</span>
      <span class="na">responses</span><span class="pi">:</span>
        <span class="s1">'</span><span class="s">200'</span><span class="err">:</span>
          <span class="na">description</span><span class="pi">:</span> <span class="s">successful operation</span>
          <span class="na">content</span><span class="pi">:</span>
            <span class="na">application/json</span><span class="pi">:</span>
              <span class="na">schema</span><span class="pi">:</span>
                <span class="s2">"</span><span class="s">$ref"</span><span class="err">:</span> <span class="s2">"</span><span class="s">#/components/schemas/JokeResponse"</span>
<span class="na">components</span><span class="pi">:</span>
  <span class="na">schemas</span><span class="pi">:</span>
    <span class="na">Joke</span><span class="pi">:</span>
      <span class="na">type</span><span class="pi">:</span> <span class="s">object</span>
      <span class="na">required</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">_id</span>
      <span class="pi">-</span> <span class="s">punchline</span>
      <span class="pi">-</span> <span class="s">setup</span>
      <span class="pi">-</span> <span class="s">type</span>
      <span class="na">properties</span><span class="pi">:</span>
        <span class="na">_id</span><span class="pi">:</span>
          <span class="na">type</span><span class="pi">:</span> <span class="s">string</span>
        <span class="na">type</span><span class="pi">:</span>
          <span class="na">type</span><span class="pi">:</span> <span class="s">string</span>
        <span class="na">setup</span><span class="pi">:</span>
          <span class="na">type</span><span class="pi">:</span> <span class="s">string</span>
        <span class="na">punchline</span><span class="pi">:</span>
          <span class="na">type</span><span class="pi">:</span> <span class="s">string</span>
    <span class="na">JokeResponse</span><span class="pi">:</span>
      <span class="na">type</span><span class="pi">:</span> <span class="s">object</span>
      <span class="na">properties</span><span class="pi">:</span>
        <span class="na">sucess</span><span class="pi">:</span>
          <span class="na">type</span><span class="pi">:</span> <span class="s">boolean</span>
        <span class="na">body</span><span class="pi">:</span>
          <span class="na">type</span><span class="pi">:</span> <span class="s">array</span>
          <span class="na">items</span><span class="pi">:</span>
            <span class="na">$ref</span><span class="pi">:</span> <span class="s1">'</span><span class="s">#/components/schemas/Joke'</span>
</code></pre></div></div>

<p>Now, we want to generate HTTP Client SDK automatically. Let’s use <a href="https://github.com/RicoSuter/NSwag/wiki/NSwagStudio" target="_blank" rel="noopener noreferrer">NSwagStudio</a>.</p>

<p><img src="/assets/http-sdk/nswag-example.png" alt="nswag-example"></p>

<p>Here is how the generated <code class="language-plaintext highlighter-rouge">IDadJokesApiClient</code> looks like (XML comments are deleted for brevity):</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="p">[</span><span class="n">System</span><span class="p">.</span><span class="n">CodeDom</span><span class="p">.</span><span class="n">Compiler</span><span class="p">.</span><span class="nf">GeneratedCode</span><span class="p">(</span><span class="s">"NSwag"</span><span class="p">,</span> <span class="s">"13.10.9.0 (NJsonSchema v10.4.1.0 (Newtonsoft.Json v12.0.0.0))"</span><span class="p">)]</span>
    <span class="k">public</span> <span class="k">partial</span> <span class="k">interface</span> <span class="nc">IDadJokesApiClient</span>
    <span class="p">{</span>
        <span class="n">System</span><span class="p">.</span><span class="n">Threading</span><span class="p">.</span><span class="n">Tasks</span><span class="p">.</span><span class="n">Task</span><span class="p">&lt;</span><span class="n">Joke</span><span class="p">&gt;</span> <span class="nf">GetJokeByIdAsync</span><span class="p">(</span><span class="kt">string</span> <span class="n">id</span><span class="p">);</span>
    
        <span class="n">System</span><span class="p">.</span><span class="n">Threading</span><span class="p">.</span><span class="n">Tasks</span><span class="p">.</span><span class="n">Task</span><span class="p">&lt;</span><span class="n">Joke</span><span class="p">&gt;</span> <span class="nf">GetJokeByIdAsync</span><span class="p">(</span><span class="kt">string</span> <span class="n">id</span><span class="p">,</span> <span class="n">System</span><span class="p">.</span><span class="n">Threading</span><span class="p">.</span><span class="n">CancellationToken</span> <span class="n">cancellationToken</span><span class="p">);</span>
    
        <span class="n">System</span><span class="p">.</span><span class="n">Threading</span><span class="p">.</span><span class="n">Tasks</span><span class="p">.</span><span class="n">Task</span><span class="p">&lt;</span><span class="n">JokeResponse</span><span class="p">&gt;</span> <span class="nf">GetRandomJokeAsync</span><span class="p">();</span>
    
        <span class="n">System</span><span class="p">.</span><span class="n">Threading</span><span class="p">.</span><span class="n">Tasks</span><span class="p">.</span><span class="n">Task</span><span class="p">&lt;</span><span class="n">JokeResponse</span><span class="p">&gt;</span> <span class="nf">GetRandomJokeAsync</span><span class="p">(</span><span class="n">System</span><span class="p">.</span><span class="n">Threading</span><span class="p">.</span><span class="n">CancellationToken</span> <span class="n">cancellationToken</span><span class="p">);</span>
    
        <span class="n">System</span><span class="p">.</span><span class="n">Threading</span><span class="p">.</span><span class="n">Tasks</span><span class="p">.</span><span class="n">Task</span><span class="p">&lt;</span><span class="n">JokeResponse</span><span class="p">&gt;</span> <span class="nf">SearchJokeAsync</span><span class="p">();</span>
    
        <span class="n">System</span><span class="p">.</span><span class="n">Threading</span><span class="p">.</span><span class="n">Tasks</span><span class="p">.</span><span class="n">Task</span><span class="p">&lt;</span><span class="n">JokeResponse</span><span class="p">&gt;</span> <span class="nf">SearchJokeAsync</span><span class="p">(</span><span class="n">System</span><span class="p">.</span><span class="n">Threading</span><span class="p">.</span><span class="n">CancellationToken</span> <span class="n">cancellationToken</span><span class="p">);</span>
    <span class="p">}</span>
</code></pre></div></div>

<p>As usual, we want to provide the registration of typed client as an extension method:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">static</span> <span class="k">class</span> <span class="nc">ServiceCollectionExtensions</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">static</span> <span class="n">IHttpClientBuilder</span> <span class="nf">AddDadJokesApiClient</span><span class="p">(</span>
        <span class="k">this</span> <span class="n">IServiceCollection</span> <span class="n">services</span><span class="p">,</span> <span class="n">Action</span><span class="p">&lt;</span><span class="n">HttpClient</span><span class="p">&gt;</span> <span class="n">configureClient</span><span class="p">)</span> <span class="p">=&gt;</span> 
            <span class="n">services</span><span class="p">.</span><span class="n">AddHttpClient</span><span class="p">&lt;</span><span class="n">IDadJokesApiClient</span><span class="p">,</span> <span class="n">DadJokesApiClient</span><span class="p">&gt;(</span>
                <span class="n">httpClient</span> <span class="p">=&gt;</span> <span class="nf">configureClient</span><span class="p">(</span><span class="n">httpClient</span><span class="p">));</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Usage:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">var</span> <span class="n">builder</span> <span class="p">=</span> <span class="n">WebApplication</span><span class="p">.</span><span class="nf">CreateBuilder</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>
<span class="kt">var</span> <span class="n">configuration</span> <span class="p">=</span> <span class="n">builder</span><span class="p">.</span><span class="n">Configuration</span><span class="p">;</span>
<span class="kt">var</span> <span class="n">services</span> <span class="p">=</span> <span class="n">builder</span><span class="p">.</span><span class="n">Services</span><span class="p">;</span>

<span class="n">services</span><span class="p">.</span><span class="nf">AddDadJokesApiClient</span><span class="p">(</span><span class="n">httpClient</span> <span class="p">=&gt;</span>
<span class="p">{</span>
    <span class="kt">var</span> <span class="n">host</span> <span class="p">=</span> <span class="n">configuration</span><span class="p">[</span><span class="s">"DadJokesClient:host"</span><span class="p">];</span>
    <span class="n">httpClient</span><span class="p">.</span><span class="n">BaseAddress</span> <span class="p">=</span> <span class="k">new</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
    <span class="n">httpClient</span><span class="p">.</span><span class="nf">AddDadJokesHeaders</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">configuration</span><span class="p">[</span><span class="s">"DADJOKES_TOKEN"</span><span class="p">]);</span>
<span class="p">});</span>

<span class="kt">var</span> <span class="n">app</span> <span class="p">=</span> <span class="n">builder</span><span class="p">.</span><span class="nf">Build</span><span class="p">();</span>

<span class="n">app</span><span class="p">.</span><span class="nf">MapGet</span><span class="p">(</span><span class="s">"/"</span><span class="p">,</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">Joke</span><span class="p">&gt;</span> <span class="p">(</span><span class="n">IDadJokesApiClient</span> <span class="n">client</span><span class="p">)</span> <span class="p">=&gt;</span>
<span class="p">{</span>
    <span class="kt">var</span> <span class="n">jokeResponse</span> <span class="p">=</span> <span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="nf">GetRandomJokeAsync</span><span class="p">();</span>

    <span class="k">return</span> <span class="n">jokeResponse</span><span class="p">.</span><span class="n">Body</span><span class="p">.</span><span class="nf">First</span><span class="p">();</span>
<span class="p">});</span>

<span class="n">app</span><span class="p">.</span><span class="nf">Run</span><span class="p">();</span>
</code></pre></div></div>

<p>Let’s run it and enjoy the last joke of this article:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"punchline"</span><span class="p">:</span><span class="w"> </span><span class="s2">"And it's really taken off"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"setup"</span><span class="p">:</span><span class="w"> </span><span class="s2">"So I invested in a hot air balloon company..."</span><span class="p">,</span><span class="w">
  </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"air"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>Pros ➕:</p>

<ul>
  <li>Based on the well-known specification</li>
  <li>Supported by rich set of tools and vibrant community</li>
  <li>Fully automated, new SDK can be generated as part of CI/CD process every time OpenAPI specification is changed</li>
  <li>Generate SDKs for multiple programming languages</li>
  <li>Relatively easy to troubleshoot since we can see the code generated by the toolchain.</li>
</ul>

<p>Cons ➖:</p>

<ul>
  <li>Can’t be applied without proper OpenAPI specification</li>
  <li>Hard to customize and control the contract of generated API Client</li>
</ul>

<p>Honorable mentions: <a href="https://github.com/Azure/AutoRest" target="_blank" rel="noopener noreferrer">AutoRest</a>, <a href="https://devblogs.microsoft.com/dotnet/generating-http-api-clients-using-visual-studio-connected-services/" target="_blank" rel="noopener noreferrer">Visual Studio Connected Services</a></p>

<h2 id="choosing-the-right-approach">Choosing the right approach</h2>

<p>We have three different ways of producing SDK clients. The selection process can be simplified to the next categories</p>

<blockquote>
  <p>I’m a simple man/woman/non-binary, I want to have full control over my HTTP Client integration.</p>
</blockquote>

<p>Use manual approach.</p>

<blockquote>
  <p>I’m a busy man/woman/non-binary, but I still want to have somewhat control.</p>
</blockquote>

<p>Use a declarative approach.</p>

<blockquote>
  <p>I’m a lazy man/woman/non-binary. Do the thing for me.</p>
</blockquote>

<p>Use an automated approach.</p>

<p>Decision chart:</p>

<p><img src="/assets/http-sdk/http-client-sdk-design-decision-chart.png" alt="decision-chart"></p>

<hr>

<h2 id="summary">Summary</h2>

<p>We’ve reviewed different ways of developing HTTP Client SDKs. Choosing the right approach depends on use-case and requirements, but I hope this article gives you nice foundations for making the best design decisions. Thank you.</p>

<h2 id="reference">Reference</h2>

<ul>
  <li><a href="https://github.com/NikiforovAll/http-sdk-guide" target="_blank" rel="noopener noreferrer">https://github.com/NikiforovAll/http-sdk-guide</a></li>
  <li><a href="https://www.stevejgordon.co.uk/sending-and-receiving-json-using-httpclient-with-system-net-http-json" target="_blank" rel="noopener noreferrer">https://www.stevejgordon.co.uk/sending-and-receiving-json-using-httpclient-with-system-net-http-json</a></li>
  <li><a href="https://devblogs.microsoft.com/dotnet/net-5-new-networking-improvements/" target="_blank" rel="noopener noreferrer">https://devblogs.microsoft.com/dotnet/net-5-new-networking-improvements/</a></li>
  <li><a href="https://www.stevejgordon.co.uk/httpclientfactory-aspnetcore-outgoing-request-middleware-pipeline-delegatinghandlers" target="_blank" rel="noopener noreferrer">https://www.stevejgordon.co.uk/httpclientfactory-aspnetcore-outgoing-request-middleware-pipeline-delegatinghandlers</a></li>
  <li><a href="https://www.aspnetmonsters.com/2016/08/2016-08-27-httpclientwrong/" target="_blank" rel="noopener noreferrer">https://www.aspnetmonsters.com/2016/08/2016-08-27-httpclientwrong/</a></li>
  <li><a href="https://www.stevejgordon.co.uk/httpclient-creation-and-disposal-internals-should-i-dispose-of-httpclient" target="_blank" rel="noopener noreferrer">https://www.stevejgordon.co.uk/httpclient-creation-and-disposal-internals-should-i-dispose-of-httpclient</a></li>
  <li><a href="https://www.assemblyai.com/blog/getting-started-with-httpclientfactory-in-c-sharp-and-net-5/" target="_blank" rel="noopener noreferrer">https://www.assemblyai.com/blog/getting-started-with-httpclientfactory-in-c-sharp-and-net-5/</a></li>
  <li><a href="https://www.stevejgordon.co.uk/httpclientfactory-named-typed-clients-aspnetcore" target="_blank" rel="noopener noreferrer">https://www.stevejgordon.co.uk/httpclientfactory-named-typed-clients-aspnetcore</a></li>
  <li><a href="https://andrewlock.net/understanding-scopes-with-ihttpclientfactory-message-handlers/" target="_blank" rel="noopener noreferrer">https://andrewlock.net/understanding-scopes-with-ihttpclientfactory-message-handlers/</a></li>
  <li><a href="https://andrewlock.net/exporing-the-code-behind-ihttpclientfactory/" target="_blank" rel="noopener noreferrer">https://andrewlock.net/exporing-the-code-behind-ihttpclientfactory/</a></li>
  <li><a href="https://docs.microsoft.com/en-us/dotnet/architecture/microservices/implement-resilient-applications/" target="_blank" rel="noopener noreferrer">https://docs.microsoft.com/en-us/dotnet/architecture/microservices/implement-resilient-applications/</a></li>
  <li><a href="https://app.pluralsight.com/library/courses/using-httpclient-consume-apis-dot-net" target="_blank" rel="noopener noreferrer">https://app.pluralsight.com/library/courses/using-httpclient-consume-apis-dot-net</a></li>
</ul>

	</div>

	

	
	<ul class="tag_box list-unstyled list-inline">
		<li><i class="fa fa-folder-open"></i></li>
		
		
		
		<li><a href="https://nikiforovall.github.io/categories.html#dotnet-ref" target="_blank" rel="noopener noreferrer">
				dotnet <span>(54)</span>
				,
			</a></li>
		
		<li><a href="https://nikiforovall.github.io/categories.html#aspnetcore-ref" target="_blank" rel="noopener noreferrer">
				aspnetcore <span>(11)</span>
				,
			</a></li>
		
		<li><a href="https://nikiforovall.github.io/categories.html#microservices-ref" target="_blank" rel="noopener noreferrer">
				microservices <span>(3)</span>
				
			</a></li>
		
		
	</ul>
	

	
	<ul class="list-inline">
		<li><i class="fa fa-tags"></i></li>
		
		
		
		<li>
			<a href="https://nikiforovall.github.io/tags.html#dotnet-ref" target="_blank" rel="noopener noreferrer">
				dotnet <span>(59)</span>
				,
			</a>
		</li>
		
		<li>
			<a href="https://nikiforovall.github.io/tags.html#microservices-ref" target="_blank" rel="noopener noreferrer">
				microservices <span>(4)</span>
				,
			</a>
		</li>
		
		<li>
			<a href="https://nikiforovall.github.io/tags.html#aspnetcore-ref" target="_blank" rel="noopener noreferrer">
				aspnetcore <span>(24)</span>
				,
			</a>
		</li>
		
		<li>
			<a href="https://nikiforovall.github.io/tags.html#api-ref" target="_blank" rel="noopener noreferrer">
				api <span>(3)</span>
				
			</a>
		</li>
		
		
		
	</ul>
	

	<hr>

	<div>
		<section class="share col-sm-6">
			<h4 class="section-title">Share Post</h4>
			<a class="btn btn-default btn-sm twitter" href="http://twitter.com/share?&amp;via=nikiforovall" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;" target="_blank" rel="noopener noreferrer">
				<i class="fa fa-twitter fa-lg"></i>
				Twitter
			</a>
		</section>

		<section class="col-sm-6 author">
			<img src="//www.gravatar.com/avatar/e86fa0938976c38907a302ecb208f011" class="img-rounded author-image">
			<h4 class="section-title author-name">Oleksii Nikiforov</h4>
			<p class="author-bio">Jibber-jabbering about programming and IT.</p>
		</section>
	</div>

	<div class="clearfix"></div>

	<ul class="pager">
		
		<li class="previous"><a href="https://nikiforovall.github.io/dotnet/aspnetcore/microservices/2022/02/06/http-sdks.html" title="Creating and Using HTTP Client SDKs in .NET 6. (Announcement)" target="_blank" rel="noopener noreferrer">←
				Previous</a></li>
		
		
		<li class="next">
<a href="https://nikiforovall.github.io/productivity/devcontainers/2022/08/13/deaac.html" title="Dev Environment as a Code (DEaaC) with DevContainers, Dotfiles, and GitHub Codespaces" target="_blank" rel="noopener noreferrer">Next →</a>
		</li>
		
	</ul>

	<hr>
	</div>

	<div class="col-sm-2 sidebar-2">

	</div>

</article>
<div class="clearfix"></div>



    
    <script src="https://utteranc.es/client.js" repo="NikiforovAll/nikiforovall.github.io" issue-term="pathname" label="Blog" theme="preferred-color-scheme" crossorigin="anonymous" async>
    </script>





		<footer>
			<hr>
			<p>
				© 2025 Oleksii Nikiforov with <a href="http://jekyllrb.com/" target="_blank" rel="noopener noreferrer">Jekyll</a>. Theme: <a href="https://github.com/dbtek/dbyll" target="_blank" rel="noopener noreferrer">dbyll</a> by dbtek.
			</p>
		</footer>
	</div>

	<script type="text/javascript" src="https://nikiforovall.github.io/assets/resources/jquery/jquery.min.js"></script>
	<script type="text/javascript" src="https://nikiforovall.github.io/assets/resources/bootstrap/js/bootstrap.min.js"></script>
	<script type="text/javascript" src="https://nikiforovall.github.io/assets/js/app.js"></script>
	
</body>
</html>



<!-- Asynchronous Google Analytics snippet -->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-164555539-1', 'auto');
  ga('send', 'pageview');
</script>

